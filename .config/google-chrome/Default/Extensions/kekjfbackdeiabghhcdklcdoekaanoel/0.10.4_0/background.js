/*! For license information please see background.js.LICENSE.txt */
(()=>{var t={744:function(t,e,n){t.exports=function(){"use strict";var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)},e=function(){return(e=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function r(t,e,n){if(n||2===arguments.length)for(var r,i=0,s=e.length;i<s;i++)!r&&i in e||((r=r||Array.prototype.slice.call(e,0,i))[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))}var i="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:n.g,s=Object.keys,a=Array.isArray;function o(t,e){return"object"!=typeof e||s(e).forEach((function(n){t[n]=e[n]})),t}"undefined"==typeof Promise||i.Promise||(i.Promise=Promise);var u=Object.getPrototypeOf,l={}.hasOwnProperty;function c(t,e){return l.call(t,e)}function h(t,e){"function"==typeof e&&(e=e(u(t))),("undefined"==typeof Reflect?s:Reflect.ownKeys)(e).forEach((function(n){p(t,n,e[n])}))}var d=Object.defineProperty;function p(t,e,n,r){d(t,e,o(n&&c(n,"get")&&"function"==typeof n.get?{get:n.get,set:n.set,configurable:!0}:{value:n,configurable:!0,writable:!0},r))}function f(t){return{from:function(e){return t.prototype=Object.create(e.prototype),p(t.prototype,"constructor",t),{extend:h.bind(null,t.prototype)}}}}var m=Object.getOwnPropertyDescriptor,g=[].slice;function y(t,e,n){return g.call(t,e,n)}function v(t,e){return e(t)}function _(t){if(!t)throw new Error("Assertion Failed")}function b(t){i.setImmediate?setImmediate(t):setTimeout(t,0)}function w(t,e){if("string"==typeof e&&c(t,e))return t[e];if(!e)return t;if("string"!=typeof e){for(var n=[],r=0,i=e.length;r<i;++r){var s=w(t,e[r]);n.push(s)}return n}var a=e.indexOf(".");if(-1!==a){var o=t[e.substr(0,a)];return null==o?void 0:w(o,e.substr(a+1))}}function E(t,e,n){if(t&&void 0!==e&&(!("isFrozen"in Object)||!Object.isFrozen(t)))if("string"!=typeof e&&"length"in e){_("string"!=typeof n&&"length"in n);for(var r=0,i=e.length;r<i;++r)E(t,e[r],n[r])}else{var s,o,u=e.indexOf(".");-1!==u?(s=e.substr(0,u),""===(o=e.substr(u+1))?void 0===n?a(t)&&!isNaN(parseInt(s))?t.splice(s,1):delete t[s]:t[s]=n:E(u=(u=t[s])&&c(t,s)?u:t[s]={},o,n)):void 0===n?a(t)&&!isNaN(parseInt(e))?t.splice(e,1):delete t[e]:t[e]=n}}function I(t){var e,n={};for(e in t)c(t,e)&&(n[e]=t[e]);return n}var S=[].concat;function k(t){return S.apply([],t)}var T="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(k([8,16,32,64].map((function(t){return["Int","Uint","Float"].map((function(e){return e+t+"Array"}))})))).filter((function(t){return i[t]})),x=new Set(T.map((function(t){return i[t]}))),$=null;function L(t){return $=new WeakMap,t=function t(e){if(!e||"object"!=typeof e)return e;var n=$.get(e);if(n)return n;if(a(e)){n=[],$.set(e,n);for(var r=0,i=e.length;r<i;++r)n.push(t(e[r]))}else if(x.has(e.constructor))n=e;else{var s,o=u(e);for(s in n=o===Object.prototype?{}:Object.create(o),$.set(e,n),e)c(e,s)&&(n[s]=t(e[s]))}return n}(t),$=null,t}var O={}.toString;function P(t){return O.call(t).slice(8,-1)}var N="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator",A="symbol"==typeof N?function(t){var e;return null!=t&&(e=t[N])&&e.apply(t)}:function(){return null};function C(t,e){return 0<=(e=t.indexOf(e))&&t.splice(e,1),0<=e}var R={};function M(t){var e,n,r,i;if(1===arguments.length){if(a(t))return t.slice();if(this===R&&"string"==typeof t)return[t];if(i=A(t)){for(n=[];!(r=i.next()).done;)n.push(r.value);return n}if(null==t)return[t];if("number"!=typeof(e=t.length))return[t];for(n=new Array(e);e--;)n[e]=t[e];return n}for(e=arguments.length,n=new Array(e);e--;)n[e]=arguments[e];return n}var j="undefined"!=typeof Symbol?function(t){return"AsyncFunction"===t[Symbol.toStringTag]}:function(){return!1},D=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(ut=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"]),K={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function U(t,e){this.name=t,this.message=e}function F(t,e){return t+". Errors: "+Object.keys(e).map((function(t){return e[t].toString()})).filter((function(t,e,n){return n.indexOf(t)===e})).join("\n")}function B(t,e,n,r){this.failures=e,this.failedKeys=r,this.successCount=n,this.message=F(t,e)}function q(t,e){this.name="BulkError",this.failures=Object.keys(e).map((function(t){return e[t]})),this.failuresByPos=e,this.message=F(t,this.failures)}f(U).from(Error).extend({toString:function(){return this.name+": "+this.message}}),f(B).from(U),f(q).from(U);var V=D.reduce((function(t,e){return t[e]=e+"Error",t}),{}),G=U,W=D.reduce((function(t,e){var n=e+"Error";function r(t,r){this.name=n,t?"string"==typeof t?(this.message="".concat(t).concat(r?"\n "+r:""),this.inner=r||null):"object"==typeof t&&(this.message="".concat(t.name," ").concat(t.message),this.inner=t):(this.message=K[e]||n,this.inner=null)}return f(r).from(G),t[e]=r,t}),{});W.Syntax=SyntaxError,W.Type=TypeError,W.Range=RangeError;var z=ut.reduce((function(t,e){return t[e+"Error"]=W[e],t}),{}),H=D.reduce((function(t,e){return-1===["Syntax","Type","Range"].indexOf(e)&&(t[e+"Error"]=W[e]),t}),{});function X(){}function Y(t){return t}function J(t,e){return null==t||t===Y?e:function(n){return e(t(n))}}function Q(t,e){return function(){t.apply(this,arguments),e.apply(this,arguments)}}function Z(t,e){return t===X?e:function(){var n=t.apply(this,arguments);void 0!==n&&(arguments[0]=n);var r=this.onsuccess,i=this.onerror;this.onsuccess=null,this.onerror=null;var s=e.apply(this,arguments);return r&&(this.onsuccess=this.onsuccess?Q(r,this.onsuccess):r),i&&(this.onerror=this.onerror?Q(i,this.onerror):i),void 0!==s?s:n}}function tt(t,e){return t===X?e:function(){t.apply(this,arguments);var n=this.onsuccess,r=this.onerror;this.onsuccess=this.onerror=null,e.apply(this,arguments),n&&(this.onsuccess=this.onsuccess?Q(n,this.onsuccess):n),r&&(this.onerror=this.onerror?Q(r,this.onerror):r)}}function et(t,e){return t===X?e:function(n){var r=t.apply(this,arguments);o(n,r);var i=this.onsuccess,s=this.onerror;return this.onsuccess=null,this.onerror=null,n=e.apply(this,arguments),i&&(this.onsuccess=this.onsuccess?Q(i,this.onsuccess):i),s&&(this.onerror=this.onerror?Q(s,this.onerror):s),void 0===r?void 0===n?void 0:n:o(r,n)}}function nt(t,e){return t===X?e:function(){return!1!==e.apply(this,arguments)&&t.apply(this,arguments)}}function rt(t,e){return t===X?e:function(){var n=t.apply(this,arguments);if(n&&"function"==typeof n.then){for(var r=this,i=arguments.length,s=new Array(i);i--;)s[i]=arguments[i];return n.then((function(){return e.apply(r,s)}))}return e.apply(this,arguments)}}H.ModifyError=B,H.DexieError=U,H.BulkError=q;var it="undefined"!=typeof location&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function st(t){it=t}var at={},ot=100,ut=(T="undefined"==typeof Promise?[]:function(){var t=Promise.resolve();if("undefined"==typeof crypto||!crypto.subtle)return[t,u(t),t];var e=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[e,u(e),t]}(),T[0]),lt=(D=T[1],T=T[2],D=D&&D.then,ut&&ut.constructor),ct=!!T,ht=function(t,e){_t.push([t,e]),pt&&(queueMicrotask(Lt),pt=!1)},dt=!0,pt=!0,ft=[],mt=[],gt=Y,yt={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:X,pgp:!1,env:{},finalize:X},vt=yt,_t=[],bt=0,wt=[];function Et(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var e=this._PSD=vt;if("function"!=typeof t){if(t!==at)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(!1===this._state&&kt(this,this._value))}this._state=null,this._value=null,++e.ref,function t(e,n){try{n((function(n){if(null===e._state){if(n===e)throw new TypeError("A promise cannot be resolved with itself.");var r=e._lib&&Ot();n&&"function"==typeof n.then?t(e,(function(t,e){n instanceof Et?n._then(t,e):n.then(t,e)})):(e._state=!0,e._value=n,Tt(e)),r&&Pt()}}),kt.bind(null,e))}catch(n){kt(e,n)}}(this,t)}var It={get:function(){var t=vt,e=Kt;function n(n,r){var i=this,s=!t.global&&(t!==vt||e!==Kt),a=s&&!qt(),o=new Et((function(e,o){xt(i,new St(Xt(n,t,s,a),Xt(r,t,s,a),e,o,t))}));return this._consoleTask&&(o._consoleTask=this._consoleTask),o}return n.prototype=at,n},set:function(t){p(this,"then",t&&t.prototype===at?It:{get:function(){return t},set:It.set})}};function St(t,e,n,r,i){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.resolve=n,this.reject=r,this.psd=i}function kt(t,e){var n,r;mt.push(e),null===t._state&&(n=t._lib&&Ot(),e=gt(e),t._state=!1,t._value=e,r=t,ft.some((function(t){return t._value===r._value}))||ft.push(r),Tt(t),n&&Pt())}function Tt(t){var e=t._listeners;t._listeners=[];for(var n=0,r=e.length;n<r;++n)xt(t,e[n]);var i=t._PSD;--i.ref||i.finalize(),0===bt&&(++bt,ht((function(){0==--bt&&Nt()}),[]))}function xt(t,e){if(null!==t._state){var n=t._state?e.onFulfilled:e.onRejected;if(null===n)return(t._state?e.resolve:e.reject)(t._value);++e.psd.ref,++bt,ht($t,[n,t,e])}else t._listeners.push(e)}function $t(t,e,n){try{var r,i=e._value;!e._state&&mt.length&&(mt=[]),r=it&&e._consoleTask?e._consoleTask.run((function(){return t(i)})):t(i),e._state||-1!==mt.indexOf(i)||function(t){for(var e=ft.length;e;)if(ft[--e]._value===t._value)return ft.splice(e,1)}(e),n.resolve(r)}catch(t){n.reject(t)}finally{0==--bt&&Nt(),--n.psd.ref||n.psd.finalize()}}function Lt(){Ht(yt,(function(){Ot()&&Pt()}))}function Ot(){var t=dt;return pt=dt=!1,t}function Pt(){var t,e,n;do{for(;0<_t.length;)for(t=_t,_t=[],n=t.length,e=0;e<n;++e){var r=t[e];r[0].apply(null,r[1])}}while(0<_t.length);pt=dt=!0}function Nt(){var t=ft;ft=[],t.forEach((function(t){t._PSD.onunhandled.call(null,t._value,t)}));for(var e=wt.slice(0),n=e.length;n;)e[--n]()}function At(t){return new Et(at,!1,t)}function Ct(t,e){var n=vt;return function(){var r=Ot(),i=vt;try{return Wt(n,!0),t.apply(this,arguments)}catch(r){e&&e(r)}finally{Wt(i,!1),r&&Pt()}}}h(Et.prototype,{then:It,_then:function(t,e){xt(this,new St(null,null,t,e,vt))},catch:function(t){if(1===arguments.length)return this.then(null,t);var e=t,n=arguments[1];return"function"==typeof e?this.then(null,(function(t){return(t instanceof e?n:At)(t)})):this.then(null,(function(t){return(t&&t.name===e?n:At)(t)}))},finally:function(t){return this.then((function(e){return Et.resolve(t()).then((function(){return e}))}),(function(e){return Et.resolve(t()).then((function(){return At(e)}))}))},timeout:function(t,e){var n=this;return t<1/0?new Et((function(r,i){var s=setTimeout((function(){return i(new W.Timeout(e))}),t);n.then(r,i).finally(clearTimeout.bind(null,s))})):this}}),"undefined"!=typeof Symbol&&Symbol.toStringTag&&p(Et.prototype,Symbol.toStringTag,"Dexie.Promise"),yt.env=zt(),h(Et,{all:function(){var t=M.apply(null,arguments).map(Vt);return new Et((function(e,n){0===t.length&&e([]);var r=t.length;t.forEach((function(i,s){return Et.resolve(i).then((function(n){t[s]=n,--r||e(t)}),n)}))}))},resolve:function(t){return t instanceof Et?t:t&&"function"==typeof t.then?new Et((function(e,n){t.then(e,n)})):new Et(at,!0,t)},reject:At,race:function(){var t=M.apply(null,arguments).map(Vt);return new Et((function(e,n){t.map((function(t){return Et.resolve(t).then(e,n)}))}))},PSD:{get:function(){return vt},set:function(t){return vt=t}},totalEchoes:{get:function(){return Kt}},newPSD:Ft,usePSD:Ht,scheduler:{get:function(){return ht},set:function(t){ht=t}},rejectionMapper:{get:function(){return gt},set:function(t){gt=t}},follow:function(t,e){return new Et((function(n,r){return Ft((function(e,n){var r=vt;r.unhandleds=[],r.onunhandled=n,r.finalize=Q((function(){var t,r=this;t=function(){0===r.unhandleds.length?e():n(r.unhandleds[0])},wt.push((function e(){t(),wt.splice(wt.indexOf(e),1)})),++bt,ht((function(){0==--bt&&Nt()}),[])}),r.finalize),t()}),e,n,r)}))}}),lt&&(lt.allSettled&&p(Et,"allSettled",(function(){var t=M.apply(null,arguments).map(Vt);return new Et((function(e){0===t.length&&e([]);var n=t.length,r=new Array(n);t.forEach((function(t,i){return Et.resolve(t).then((function(t){return r[i]={status:"fulfilled",value:t}}),(function(t){return r[i]={status:"rejected",reason:t}})).then((function(){return--n||e(r)}))}))}))})),lt.any&&"undefined"!=typeof AggregateError&&p(Et,"any",(function(){var t=M.apply(null,arguments).map(Vt);return new Et((function(e,n){0===t.length&&n(new AggregateError([]));var r=t.length,i=new Array(r);t.forEach((function(t,s){return Et.resolve(t).then((function(t){return e(t)}),(function(t){i[s]=t,--r||n(new AggregateError(i))}))}))}))})));var Rt={awaits:0,echoes:0,id:0},Mt=0,jt=[],Dt=0,Kt=0,Ut=0;function Ft(t,e,n,r){var i=vt,s=Object.create(i);return s.parent=i,s.ref=0,s.global=!1,s.id=++Ut,yt.env,s.env=ct?{Promise:Et,PromiseProp:{value:Et,configurable:!0,writable:!0},all:Et.all,race:Et.race,allSettled:Et.allSettled,any:Et.any,resolve:Et.resolve,reject:Et.reject}:{},e&&o(s,e),++i.ref,s.finalize=function(){--this.parent.ref||this.parent.finalize()},r=Ht(s,t,n,r),0===s.ref&&s.finalize(),r}function Bt(){return Rt.id||(Rt.id=++Mt),++Rt.awaits,Rt.echoes+=ot,Rt.id}function qt(){return!!Rt.awaits&&(0==--Rt.awaits&&(Rt.id=0),Rt.echoes=Rt.awaits*ot,!0)}function Vt(t){return Rt.echoes&&t&&t.constructor===lt?(Bt(),t.then((function(t){return qt(),t}),(function(t){return qt(),Jt(t)}))):t}function Gt(){var t=jt[jt.length-1];jt.pop(),Wt(t,!1)}function Wt(t,e){var n,r=vt;(e?!Rt.echoes||Dt++&&t===vt:!Dt||--Dt&&t===vt)||queueMicrotask(e?function(t){++Kt,Rt.echoes&&0!=--Rt.echoes||(Rt.echoes=Rt.awaits=Rt.id=0),jt.push(vt),Wt(t,!0)}.bind(null,t):Gt),t!==vt&&(vt=t,r===yt&&(yt.env=zt()),ct&&(n=yt.env.Promise,e=t.env,(r.global||t.global)&&(Object.defineProperty(i,"Promise",e.PromiseProp),n.all=e.all,n.race=e.race,n.resolve=e.resolve,n.reject=e.reject,e.allSettled&&(n.allSettled=e.allSettled),e.any&&(n.any=e.any))))}function zt(){var t=i.Promise;return ct?{Promise:t,PromiseProp:Object.getOwnPropertyDescriptor(i,"Promise"),all:t.all,race:t.race,allSettled:t.allSettled,any:t.any,resolve:t.resolve,reject:t.reject}:{}}function Ht(t,e,n,r,i){var s=vt;try{return Wt(t,!0),e(n,r,i)}finally{Wt(s,!1)}}function Xt(t,e,n,r){return"function"!=typeof t?t:function(){var i=vt;n&&Bt(),Wt(e,!0);try{return t.apply(this,arguments)}finally{Wt(i,!1),r&&queueMicrotask(qt)}}}function Yt(t){Promise===lt&&0===Rt.echoes?0===Dt?t():enqueueNativeMicroTask(t):setTimeout(t,0)}-1===(""+D).indexOf("[native code]")&&(Bt=qt=X);var Jt=Et.reject,Qt=String.fromCharCode(65535),Zt="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",te="String expected.",ee=[],ne="__dbnames",re="readonly",ie="readwrite";function se(t,e){return t?e?function(){return t.apply(this,arguments)&&e.apply(this,arguments)}:t:e}var ae={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function oe(t){return"string"!=typeof t||/\./.test(t)?function(t){return t}:function(e){return void 0===e[t]&&t in e&&delete(e=L(e))[t],e}}function ue(){throw W.Type()}function le(t,e){try{var n=ce(t),r=ce(e);if(n!==r)return"Array"===n?1:"Array"===r?-1:"binary"===n?1:"binary"===r?-1:"string"===n?1:"string"===r?-1:"Date"===n?1:"Date"!==r?NaN:-1;switch(n){case"number":case"Date":case"string":return e<t?1:t<e?-1:0;case"binary":return function(t,e){for(var n=t.length,r=e.length,i=n<r?n:r,s=0;s<i;++s)if(t[s]!==e[s])return t[s]<e[s]?-1:1;return n===r?0:n<r?-1:1}(he(t),he(e));case"Array":return function(t,e){for(var n=t.length,r=e.length,i=n<r?n:r,s=0;s<i;++s){var a=le(t[s],e[s]);if(0!==a)return a}return n===r?0:n<r?-1:1}(t,e)}}catch(t){}return NaN}function ce(t){var e=typeof t;return"object"!=e?e:ArrayBuffer.isView(t)||"ArrayBuffer"===(t=P(t))?"binary":t}function he(t){return t instanceof Uint8Array?t:ArrayBuffer.isView(t)?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):new Uint8Array(t)}var de=(pe.prototype._trans=function(t,e,n){var r=this._tx||vt.trans,i=this.name,s=it&&"undefined"!=typeof console&&console.createTask&&console.createTask("Dexie: ".concat("readonly"===t?"read":"write"," ").concat(this.name));function a(t,n,r){if(!r.schema[i])throw new W.NotFound("Table "+i+" not part of transaction");return e(r.idbtrans,r)}var o=Ot();try{var u=r&&r.db._novip===this.db._novip?r===vt.trans?r._promise(t,a,n):Ft((function(){return r._promise(t,a,n)}),{trans:r,transless:vt.transless||vt}):function t(e,n,r,i){if(e.idbdb&&(e._state.openComplete||vt.letThrough||e._vip)){var s=e._createTransaction(n,r,e._dbSchema);try{s.create(),e._state.PR1398_maxLoop=3}catch(s){return s.name===V.InvalidState&&e.isOpen()&&0<--e._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),e.close({disableAutoOpen:!1}),e.open().then((function(){return t(e,n,r,i)}))):Jt(s)}return s._promise(n,(function(t,e){return Ft((function(){return vt.trans=s,i(t,e,s)}))})).then((function(t){if("readwrite"===n)try{s.idbtrans.commit()}catch(t){}return"readonly"===n?t:s._completion.then((function(){return t}))}))}if(e._state.openComplete)return Jt(new W.DatabaseClosed(e._state.dbOpenError));if(!e._state.isBeingOpened){if(!e._state.autoOpen)return Jt(new W.DatabaseClosed);e.open().catch(X)}return e._state.dbReadyPromise.then((function(){return t(e,n,r,i)}))}(this.db,t,[this.name],a);return s&&(u._consoleTask=s,u=u.catch((function(t){return console.trace(t),Jt(t)}))),u}finally{o&&Pt()}},pe.prototype.get=function(t,e){var n=this;return t&&t.constructor===Object?this.where(t).first(e):null==t?Jt(new W.Type("Invalid argument to Table.get()")):this._trans("readonly",(function(e){return n.core.get({trans:e,key:t}).then((function(t){return n.hook.reading.fire(t)}))})).then(e)},pe.prototype.where=function(t){if("string"==typeof t)return new this.db.WhereClause(this,t);if(a(t))return new this.db.WhereClause(this,"[".concat(t.join("+"),"]"));var e=s(t);if(1===e.length)return this.where(e[0]).equals(t[e[0]]);var n=this.schema.indexes.concat(this.schema.primKey).filter((function(t){if(t.compound&&e.every((function(e){return 0<=t.keyPath.indexOf(e)}))){for(var n=0;n<e.length;++n)if(-1===e.indexOf(t.keyPath[n]))return!1;return!0}return!1})).sort((function(t,e){return t.keyPath.length-e.keyPath.length}))[0];if(n&&this.db._maxKey!==Qt){var r=n.keyPath.slice(0,e.length);return this.where(r).equals(r.map((function(e){return t[e]})))}!n&&it&&console.warn("The query ".concat(JSON.stringify(t)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(e.join("+"),"]"));var i=this.schema.idxByName,o=this.db._deps.indexedDB;function u(t,e){return 0===o.cmp(t,e)}var l=e.reduce((function(e,n){var r=e[0],s=e[1],o=(e=i[n],t[n]);return[r||e,r||!e?se(s,e&&e.multi?function(t){return t=w(t,n),a(t)&&t.some((function(t){return u(o,t)}))}:function(t){return u(o,w(t,n))}):s]}),[null,null]);return r=l[0],l=l[1],r?this.where(r.name).equals(t[r.keyPath]).filter(l):n?this.filter(l):this.where(e).equals("")},pe.prototype.filter=function(t){return this.toCollection().and(t)},pe.prototype.count=function(t){return this.toCollection().count(t)},pe.prototype.offset=function(t){return this.toCollection().offset(t)},pe.prototype.limit=function(t){return this.toCollection().limit(t)},pe.prototype.each=function(t){return this.toCollection().each(t)},pe.prototype.toArray=function(t){return this.toCollection().toArray(t)},pe.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},pe.prototype.orderBy=function(t){return new this.db.Collection(new this.db.WhereClause(this,a(t)?"[".concat(t.join("+"),"]"):t))},pe.prototype.reverse=function(){return this.toCollection().reverse()},pe.prototype.mapToClass=function(e){var n,r=this.db,i=this.name;function s(){return null!==n&&n.apply(this,arguments)||this}(this.schema.mappedClass=e).prototype instanceof ue&&(function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}(s,n=e),Object.defineProperty(s.prototype,"db",{get:function(){return r},enumerable:!1,configurable:!0}),s.prototype.table=function(){return i},e=s);for(var a=new Set,o=e.prototype;o;o=u(o))Object.getOwnPropertyNames(o).forEach((function(t){return a.add(t)}));function l(t){if(!t)return t;var n,r=Object.create(e.prototype);for(n in t)if(!a.has(n))try{r[n]=t[n]}catch(t){}return r}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=l,this.hook("reading",l),e},pe.prototype.defineClass=function(){return this.mapToClass((function(t){o(this,t)}))},pe.prototype.add=function(t,e){var n=this,r=this.schema.primKey,i=r.auto,s=r.keyPath,a=t;return s&&i&&(a=oe(s)(t)),this._trans("readwrite",(function(t){return n.core.mutate({trans:t,type:"add",keys:null!=e?[e]:null,values:[a]})})).then((function(t){return t.numFailures?Et.reject(t.failures[0]):t.lastResult})).then((function(e){if(s)try{E(t,s,e)}catch(e){}return e}))},pe.prototype.update=function(t,e){return"object"!=typeof t||a(t)?this.where(":id").equals(t).modify(e):void 0===(t=w(t,this.schema.primKey.keyPath))?Jt(new W.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(t).modify(e)},pe.prototype.put=function(t,e){var n=this,r=this.schema.primKey,i=r.auto,s=r.keyPath,a=t;return s&&i&&(a=oe(s)(t)),this._trans("readwrite",(function(t){return n.core.mutate({trans:t,type:"put",values:[a],keys:null!=e?[e]:null})})).then((function(t){return t.numFailures?Et.reject(t.failures[0]):t.lastResult})).then((function(e){if(s)try{E(t,s,e)}catch(e){}return e}))},pe.prototype.delete=function(t){var e=this;return this._trans("readwrite",(function(n){return e.core.mutate({trans:n,type:"delete",keys:[t]})})).then((function(t){return t.numFailures?Et.reject(t.failures[0]):void 0}))},pe.prototype.clear=function(){var t=this;return this._trans("readwrite",(function(e){return t.core.mutate({trans:e,type:"deleteRange",range:ae})})).then((function(t){return t.numFailures?Et.reject(t.failures[0]):void 0}))},pe.prototype.bulkGet=function(t){var e=this;return this._trans("readonly",(function(n){return e.core.getMany({keys:t,trans:n}).then((function(t){return t.map((function(t){return e.hook.reading.fire(t)}))}))}))},pe.prototype.bulkAdd=function(t,e,n){var r=this,i=Array.isArray(e)?e:void 0,s=(n=n||(i?void 0:e))?n.allKeys:void 0;return this._trans("readwrite",(function(e){var n=(o=r.schema.primKey).auto;if((o=o.keyPath)&&i)throw new W.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(i&&i.length!==t.length)throw new W.InvalidArgument("Arguments objects and keys must have the same length");var a=t.length,o=o&&n?t.map(oe(o)):t;return r.core.mutate({trans:e,type:"add",keys:i,values:o,wantResults:s}).then((function(t){var e=t.numFailures,n=t.results,i=t.lastResult;if(t=t.failures,0===e)return s?n:i;throw new q("".concat(r.name,".bulkAdd(): ").concat(e," of ").concat(a," operations failed"),t)}))}))},pe.prototype.bulkPut=function(t,e,n){var r=this,i=Array.isArray(e)?e:void 0,s=(n=n||(i?void 0:e))?n.allKeys:void 0;return this._trans("readwrite",(function(e){var n=(o=r.schema.primKey).auto;if((o=o.keyPath)&&i)throw new W.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(i&&i.length!==t.length)throw new W.InvalidArgument("Arguments objects and keys must have the same length");var a=t.length,o=o&&n?t.map(oe(o)):t;return r.core.mutate({trans:e,type:"put",keys:i,values:o,wantResults:s}).then((function(t){var e=t.numFailures,n=t.results,i=t.lastResult;if(t=t.failures,0===e)return s?n:i;throw new q("".concat(r.name,".bulkPut(): ").concat(e," of ").concat(a," operations failed"),t)}))}))},pe.prototype.bulkUpdate=function(t){var e=this,n=this.core,r=t.map((function(t){return t.key})),i=t.map((function(t){return t.changes})),s=[];return this._trans("readwrite",(function(a){return n.getMany({trans:a,keys:r,cache:"clone"}).then((function(o){var u=[],l=[];t.forEach((function(t,n){var r=t.key,i=t.changes,a=o[n];if(a){for(var c=0,h=Object.keys(i);c<h.length;c++){var d=h[c],p=i[d];if(d===e.schema.primKey.keyPath){if(0!==le(p,r))throw new W.Constraint("Cannot update primary key in bulkUpdate()")}else E(a,d,p)}s.push(n),u.push(r),l.push(a)}}));var c=u.length;return n.mutate({trans:a,type:"put",keys:u,values:l,updates:{keys:r,changeSpecs:i}}).then((function(t){var n=t.numFailures,r=t.failures;if(0===n)return c;for(var i=0,a=Object.keys(r);i<a.length;i++){var o,u=a[i],l=s[Number(u)];null!=l&&(o=r[u],delete r[u],r[l]=o)}throw new q("".concat(e.name,".bulkUpdate(): ").concat(n," of ").concat(c," operations failed"),r)}))}))}))},pe.prototype.bulkDelete=function(t){var e=this,n=t.length;return this._trans("readwrite",(function(n){return e.core.mutate({trans:n,type:"delete",keys:t})})).then((function(t){var r=t.numFailures,i=t.lastResult;if(t=t.failures,0===r)return i;throw new q("".concat(e.name,".bulkDelete(): ").concat(r," of ").concat(n," operations failed"),t)}))},pe);function pe(){}function fe(t){function e(e,r){if(r){for(var i=arguments.length,s=new Array(i-1);--i;)s[i-1]=arguments[i];return n[e].subscribe.apply(null,s),t}if("string"==typeof e)return n[e]}var n={};e.addEventType=o;for(var r=1,i=arguments.length;r<i;++r)o(arguments[r]);return e;function o(t,r,i){if("object"!=typeof t){var u;r=r||nt;var l={subscribers:[],fire:i=i||X,subscribe:function(t){-1===l.subscribers.indexOf(t)&&(l.subscribers.push(t),l.fire=r(l.fire,t))},unsubscribe:function(t){l.subscribers=l.subscribers.filter((function(e){return e!==t})),l.fire=l.subscribers.reduce(r,i)}};return n[t]=e[t]=l}s(u=t).forEach((function(t){var e=u[t];if(a(e))o(t,u[t][0],u[t][1]);else{if("asap"!==e)throw new W.InvalidArgument("Invalid event config");var n=o(t,Y,(function(){for(var t=arguments.length,e=new Array(t);t--;)e[t]=arguments[t];n.subscribers.forEach((function(t){b((function(){t.apply(null,e)}))}))}))}}))}}function me(t,e){return f(e).from({prototype:t}),e}function ge(t,e){return!(t.filter||t.algorithm||t.or)&&(e?t.justLimit:!t.replayFilter)}function ye(t,e){t.filter=se(t.filter,e)}function ve(t,e,n){var r=t.replayFilter;t.replayFilter=r?function(){return se(r(),e())}:e,t.justLimit=n&&!r}function _e(t,e){if(t.isPrimKey)return e.primaryKey;var n=e.getIndexByKeyPath(t.index);if(!n)throw new W.Schema("KeyPath "+t.index+" on object store "+e.name+" is not indexed");return n}function be(t,e,n){var r=_e(t,e.schema);return e.openCursor({trans:n,values:!t.keysOnly,reverse:"prev"===t.dir,unique:!!t.unique,query:{index:r,range:t.range}})}function we(t,e,n,r){var i=t.replayFilter?se(t.filter,t.replayFilter()):t.filter;if(t.or){var s={},a=function(t,n,r){var a,o;i&&!i(n,r,(function(t){return n.stop(t)}),(function(t){return n.fail(t)}))||("[object ArrayBuffer]"==(o=""+(a=n.primaryKey))&&(o=""+new Uint8Array(a)),c(s,o)||(s[o]=!0,e(t,n,r)))};return Promise.all([t.or._iterate(a,n),Ee(be(t,r,n),t.algorithm,a,!t.keysOnly&&t.valueMapper)])}return Ee(be(t,r,n),se(t.algorithm,i),e,!t.keysOnly&&t.valueMapper)}function Ee(t,e,n,r){var i=Ct(r?function(t,e,i){return n(r(t),e,i)}:n);return t.then((function(t){if(t)return t.start((function(){var n=function(){return t.continue()};e&&!e(t,(function(t){return n=t}),(function(e){t.stop(e),n=X}),(function(e){t.fail(e),n=X}))||i(t.value,t,(function(t){return n=t})),n()}))}))}T=Symbol();var Ie=(Se.prototype.execute=function(t){if(void 0!==this.add){var e=this.add;if(a(e))return r(r([],a(t)?t:[],!0),e,!0).sort();if("number"==typeof e)return(Number(t)||0)+e;if("bigint"==typeof e)try{return BigInt(t)+e}catch(t){return BigInt(0)+e}throw new TypeError("Invalid term ".concat(e))}if(void 0!==this.remove){var n=this.remove;if(a(n))return a(t)?t.filter((function(t){return!n.includes(t)})).sort():[];if("number"==typeof n)return Number(t)-n;if("bigint"==typeof n)try{return BigInt(t)-n}catch(t){return BigInt(0)-n}throw new TypeError("Invalid subtrahend ".concat(n))}return(e=null===(e=this.replacePrefix)||void 0===e?void 0:e[0])&&"string"==typeof t&&t.startsWith(e)?this.replacePrefix[1]+t.substring(e.length):t},Se);function Se(t){Object.assign(this,t)}var ke=(Te.prototype._read=function(t,e){var n=this._ctx;return n.error?n.table._trans(null,Jt.bind(null,n.error)):n.table._trans("readonly",t).then(e)},Te.prototype._write=function(t){var e=this._ctx;return e.error?e.table._trans(null,Jt.bind(null,e.error)):e.table._trans("readwrite",t,"locked")},Te.prototype._addAlgorithm=function(t){var e=this._ctx;e.algorithm=se(e.algorithm,t)},Te.prototype._iterate=function(t,e){return we(this._ctx,t,e,this._ctx.table.core)},Te.prototype.clone=function(t){var e=Object.create(this.constructor.prototype),n=Object.create(this._ctx);return t&&o(n,t),e._ctx=n,e},Te.prototype.raw=function(){return this._ctx.valueMapper=null,this},Te.prototype.each=function(t){var e=this._ctx;return this._read((function(n){return we(e,t,n,e.table.core)}))},Te.prototype.count=function(t){var e=this;return this._read((function(t){var n=e._ctx,r=n.table.core;if(ge(n,!0))return r.count({trans:t,query:{index:_e(n,r.schema),range:n.range}}).then((function(t){return Math.min(t,n.limit)}));var i=0;return we(n,(function(){return++i,!1}),t,r).then((function(){return i}))})).then(t)},Te.prototype.sortBy=function(t,e){var n=t.split(".").reverse(),r=n[0],i=n.length-1;function s(t,e){return e?s(t[n[e]],e-1):t[r]}var a="next"===this._ctx.dir?1:-1;function o(t,e){return(t=s(t,i))<(e=s(e,i))?-a:e<t?a:0}return this.toArray((function(t){return t.sort(o)})).then(e)},Te.prototype.toArray=function(t){var e=this;return this._read((function(t){var n=e._ctx;if("next"===n.dir&&ge(n,!0)&&0<n.limit){var r=n.valueMapper,i=_e(n,n.table.core.schema);return n.table.core.query({trans:t,limit:n.limit,values:!0,query:{index:i,range:n.range}}).then((function(t){return t=t.result,r?t.map(r):t}))}var s=[];return we(n,(function(t){return s.push(t)}),t,n.table.core).then((function(){return s}))}),t)},Te.prototype.offset=function(t){var e=this._ctx;return t<=0||(e.offset+=t,ge(e)?ve(e,(function(){var e=t;return function(t,n){return 0===e||(1===e?--e:n((function(){t.advance(e),e=0})),!1)}})):ve(e,(function(){var e=t;return function(){return--e<0}}))),this},Te.prototype.limit=function(t){return this._ctx.limit=Math.min(this._ctx.limit,t),ve(this._ctx,(function(){var e=t;return function(t,n,r){return--e<=0&&n(r),0<=e}}),!0),this},Te.prototype.until=function(t,e){return ye(this._ctx,(function(n,r,i){return!t(n.value)||(r(i),e)})),this},Te.prototype.first=function(t){return this.limit(1).toArray((function(t){return t[0]})).then(t)},Te.prototype.last=function(t){return this.reverse().first(t)},Te.prototype.filter=function(t){var e;return ye(this._ctx,(function(e){return t(e.value)})),(e=this._ctx).isMatch=se(e.isMatch,t),this},Te.prototype.and=function(t){return this.filter(t)},Te.prototype.or=function(t){return new this.db.WhereClause(this._ctx.table,t,this)},Te.prototype.reverse=function(){return this._ctx.dir="prev"===this._ctx.dir?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},Te.prototype.desc=function(){return this.reverse()},Te.prototype.eachKey=function(t){var e=this._ctx;return e.keysOnly=!e.isMatch,this.each((function(e,n){t(n.key,n)}))},Te.prototype.eachUniqueKey=function(t){return this._ctx.unique="unique",this.eachKey(t)},Te.prototype.eachPrimaryKey=function(t){var e=this._ctx;return e.keysOnly=!e.isMatch,this.each((function(e,n){t(n.primaryKey,n)}))},Te.prototype.keys=function(t){var e=this._ctx;e.keysOnly=!e.isMatch;var n=[];return this.each((function(t,e){n.push(e.key)})).then((function(){return n})).then(t)},Te.prototype.primaryKeys=function(t){var e=this._ctx;if("next"===e.dir&&ge(e,!0)&&0<e.limit)return this._read((function(t){var n=_e(e,e.table.core.schema);return e.table.core.query({trans:t,values:!1,limit:e.limit,query:{index:n,range:e.range}})})).then((function(t){return t.result})).then(t);e.keysOnly=!e.isMatch;var n=[];return this.each((function(t,e){n.push(e.primaryKey)})).then((function(){return n})).then(t)},Te.prototype.uniqueKeys=function(t){return this._ctx.unique="unique",this.keys(t)},Te.prototype.firstKey=function(t){return this.limit(1).keys((function(t){return t[0]})).then(t)},Te.prototype.lastKey=function(t){return this.reverse().firstKey(t)},Te.prototype.distinct=function(){var t;if(!(t=(t=this._ctx).index&&t.table.schema.idxByName[t.index])||!t.multi)return this;var e={};return ye(this._ctx,(function(t){var n=t.primaryKey.toString();return t=c(e,n),e[n]=!0,!t})),this},Te.prototype.modify=function(t){var e=this,n=this._ctx;return this._write((function(r){var i,a,o;function u(t,e){var n=e.failures;e=e.numFailures,m+=t-e;for(var r=0,i=s(n);r<i.length;r++){var a=i[r];f.push(n[a])}}o="function"==typeof t?t:(i=s(t),a=i.length,function(e){for(var n=!1,r=0;r<a;++r){var s=i[r],o=t[s],u=w(e,s);o instanceof Ie?(E(e,s,o.execute(u)),n=!0):u!==o&&(E(e,s,o),n=!0)}return n});var l=n.table.core,c=l.schema.primaryKey,h=c.outbound,d=c.extractKey,p=e.db._options.modifyChunkSize||200,f=[],m=0,g=[];return e.clone().primaryKeys().then((function(e){var i=ge(n)&&n.limit===1/0&&("function"!=typeof t||t===xe)&&{index:n.index,range:n.range};return function n(s){var a=Math.min(p,e.length-s);return l.getMany({trans:r,keys:e.slice(s,s+a),cache:"immutable"}).then((function(c){for(var f=[],m=[],g=h?[]:null,y=[],v=0;v<a;++v){var _=c[v],b={value:L(_),primKey:e[s+v]};!1!==o.call(b,b.value,b)&&(null==b.value?y.push(e[s+v]):h||0===le(d(_),d(b.value))?(m.push(b.value),h&&g.push(e[s+v])):(y.push(e[s+v]),f.push(b.value)))}return Promise.resolve(0<f.length&&l.mutate({trans:r,type:"add",values:f}).then((function(t){for(var e in t.failures)y.splice(parseInt(e),1);u(f.length,t)}))).then((function(){return(0<m.length||i&&"object"==typeof t)&&l.mutate({trans:r,type:"put",keys:g,values:m,criteria:i,changeSpec:"function"!=typeof t&&t,isAdditionalChunk:0<s}).then((function(t){return u(m.length,t)}))})).then((function(){return(0<y.length||i&&t===xe)&&l.mutate({trans:r,type:"delete",keys:y,criteria:i,isAdditionalChunk:0<s}).then((function(t){return u(y.length,t)}))})).then((function(){return e.length>s+a&&n(s+p)}))}))}(0).then((function(){if(0<f.length)throw new B("Error modifying one or more objects",f,m,g);return e.length}))}))}))},Te.prototype.delete=function(){var t=this._ctx,e=t.range;return ge(t)&&(t.isPrimKey||3===e.type)?this._write((function(n){var r=t.table.core.schema.primaryKey,i=e;return t.table.core.count({trans:n,query:{index:r,range:i}}).then((function(e){return t.table.core.mutate({trans:n,type:"deleteRange",range:i}).then((function(t){var n=t.failures;if(t.lastResult,t.results,t=t.numFailures)throw new B("Could not delete some values",Object.keys(n).map((function(t){return n[t]})),e-t);return e-t}))}))})):this.modify(xe)},Te);function Te(){}var xe=function(t,e){return e.value=null};function $e(t,e){return t<e?-1:t===e?0:1}function Le(t,e){return e<t?-1:t===e?0:1}function Oe(t,e,n){return(t=t instanceof Re?new t.Collection(t):t)._ctx.error=new(n||TypeError)(e),t}function Pe(t){return new t.Collection(t,(function(){return Ce("")})).limit(0)}function Ne(t,e,n,r){var i,s,a,o,u,l,c,h=n.length;if(!n.every((function(t){return"string"==typeof t})))return Oe(t,te);function d(t){i="next"===t?function(t){return t.toUpperCase()}:function(t){return t.toLowerCase()},s="next"===t?function(t){return t.toLowerCase()}:function(t){return t.toUpperCase()},a="next"===t?$e:Le;var e=n.map((function(t){return{lower:s(t),upper:i(t)}})).sort((function(t,e){return a(t.lower,e.lower)}));o=e.map((function(t){return t.upper})),u=e.map((function(t){return t.lower})),c="next"===(l=t)?"":r}d("next"),(t=new t.Collection(t,(function(){return Ae(o[0],u[h-1]+r)})))._ondirectionchange=function(t){d(t)};var p=0;return t._addAlgorithm((function(t,n,r){var i=t.key;if("string"!=typeof i)return!1;var d=s(i);if(e(d,u,p))return!0;for(var f=null,m=p;m<h;++m){var g=function(t,e,n,r,i,s){for(var a=Math.min(t.length,r.length),o=-1,u=0;u<a;++u){var l=e[u];if(l!==r[u])return i(t[u],n[u])<0?t.substr(0,u)+n[u]+n.substr(u+1):i(t[u],r[u])<0?t.substr(0,u)+r[u]+n.substr(u+1):0<=o?t.substr(0,o)+e[o]+n.substr(o+1):null;i(t[u],l)<0&&(o=u)}return a<r.length&&"next"===s?t+n.substr(t.length):a<t.length&&"prev"===s?t.substr(0,n.length):o<0?null:t.substr(0,o)+r[o]+n.substr(o+1)}(i,d,o[m],u[m],a,l);null===g&&null===f?p=m+1:(null===f||0<a(f,g))&&(f=g)}return n(null!==f?function(){t.continue(f+c)}:r),!1})),t}function Ae(t,e,n,r){return{type:2,lower:t,upper:e,lowerOpen:n,upperOpen:r}}function Ce(t){return{type:1,lower:t,upper:t}}var Re=(Object.defineProperty(Me.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Me.prototype.between=function(t,e,n,r){n=!1!==n,r=!0===r;try{return 0<this._cmp(t,e)||0===this._cmp(t,e)&&(n||r)&&(!n||!r)?Pe(this):new this.Collection(this,(function(){return Ae(t,e,!n,!r)}))}catch(t){return Oe(this,Zt)}},Me.prototype.equals=function(t){return null==t?Oe(this,Zt):new this.Collection(this,(function(){return Ce(t)}))},Me.prototype.above=function(t){return null==t?Oe(this,Zt):new this.Collection(this,(function(){return Ae(t,void 0,!0)}))},Me.prototype.aboveOrEqual=function(t){return null==t?Oe(this,Zt):new this.Collection(this,(function(){return Ae(t,void 0,!1)}))},Me.prototype.below=function(t){return null==t?Oe(this,Zt):new this.Collection(this,(function(){return Ae(void 0,t,!1,!0)}))},Me.prototype.belowOrEqual=function(t){return null==t?Oe(this,Zt):new this.Collection(this,(function(){return Ae(void 0,t)}))},Me.prototype.startsWith=function(t){return"string"!=typeof t?Oe(this,te):this.between(t,t+Qt,!0,!0)},Me.prototype.startsWithIgnoreCase=function(t){return""===t?this.startsWith(t):Ne(this,(function(t,e){return 0===t.indexOf(e[0])}),[t],Qt)},Me.prototype.equalsIgnoreCase=function(t){return Ne(this,(function(t,e){return t===e[0]}),[t],"")},Me.prototype.anyOfIgnoreCase=function(){var t=M.apply(R,arguments);return 0===t.length?Pe(this):Ne(this,(function(t,e){return-1!==e.indexOf(t)}),t,"")},Me.prototype.startsWithAnyOfIgnoreCase=function(){var t=M.apply(R,arguments);return 0===t.length?Pe(this):Ne(this,(function(t,e){return e.some((function(e){return 0===t.indexOf(e)}))}),t,Qt)},Me.prototype.anyOf=function(){var t=this,e=M.apply(R,arguments),n=this._cmp;try{e.sort(n)}catch(r){return Oe(this,Zt)}if(0===e.length)return Pe(this);var r=new this.Collection(this,(function(){return Ae(e[0],e[e.length-1])}));r._ondirectionchange=function(r){n="next"===r?t._ascending:t._descending,e.sort(n)};var i=0;return r._addAlgorithm((function(t,r,s){for(var a=t.key;0<n(a,e[i]);)if(++i===e.length)return r(s),!1;return 0===n(a,e[i])||(r((function(){t.continue(e[i])})),!1)})),r},Me.prototype.notEqual=function(t){return this.inAnyRange([[-1/0,t],[t,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Me.prototype.noneOf=function(){var t=M.apply(R,arguments);if(0===t.length)return new this.Collection(this);try{t.sort(this._ascending)}catch(t){return Oe(this,Zt)}var e=t.reduce((function(t,e){return t?t.concat([[t[t.length-1][1],e]]):[[-1/0,e]]}),null);return e.push([t[t.length-1],this.db._maxKey]),this.inAnyRange(e,{includeLowers:!1,includeUppers:!1})},Me.prototype.inAnyRange=function(t,e){var n=this,r=this._cmp,i=this._ascending,s=this._descending,a=this._min,o=this._max;if(0===t.length)return Pe(this);if(!t.every((function(t){return void 0!==t[0]&&void 0!==t[1]&&i(t[0],t[1])<=0})))return Oe(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",W.InvalidArgument);var u,l=!e||!1!==e.includeLowers,c=e&&!0===e.includeUppers,h=i;function d(t,e){return h(t[0],e[0])}try{(u=t.reduce((function(t,e){for(var n=0,i=t.length;n<i;++n){var s=t[n];if(r(e[0],s[1])<0&&0<r(e[1],s[0])){s[0]=a(s[0],e[0]),s[1]=o(s[1],e[1]);break}}return n===i&&t.push(e),t}),[])).sort(d)}catch(t){return Oe(this,Zt)}var p=0,f=c?function(t){return 0<i(t,u[p][1])}:function(t){return 0<=i(t,u[p][1])},m=l?function(t){return 0<s(t,u[p][0])}:function(t){return 0<=s(t,u[p][0])},g=f;return(t=new this.Collection(this,(function(){return Ae(u[0][0],u[u.length-1][1],!l,!c)})))._ondirectionchange=function(t){h="next"===t?(g=f,i):(g=m,s),u.sort(d)},t._addAlgorithm((function(t,e,r){for(var s,a=t.key;g(a);)if(++p===u.length)return e(r),!1;return!f(s=a)&&!m(s)||(0===n._cmp(a,u[p][1])||0===n._cmp(a,u[p][0])||e((function(){h===i?t.continue(u[p][0]):t.continue(u[p][1])})),!1)})),t},Me.prototype.startsWithAnyOf=function(){var t=M.apply(R,arguments);return t.every((function(t){return"string"==typeof t}))?0===t.length?Pe(this):this.inAnyRange(t.map((function(t){return[t,t+Qt]}))):Oe(this,"startsWithAnyOf() only works with strings")},Me);function Me(){}function je(t){return Ct((function(e){return De(e),t(e.target.error),!1}))}function De(t){t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault()}var Ke="storagemutated",Ue="x-storagemutated-1",Fe=fe(null,Ke),Be=(qe.prototype._lock=function(){return _(!vt.global),++this._reculock,1!==this._reculock||vt.global||(vt.lockOwnerFor=this),this},qe.prototype._unlock=function(){if(_(!vt.global),0==--this._reculock)for(vt.global||(vt.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var t=this._blockedFuncs.shift();try{Ht(t[1],t[0])}catch(t){}}return this},qe.prototype._locked=function(){return this._reculock&&vt.lockOwnerFor!==this},qe.prototype.create=function(t){var e=this;if(!this.mode)return this;var n=this.db.idbdb,r=this.db._state.dbOpenError;if(_(!this.idbtrans),!t&&!n)switch(r&&r.name){case"DatabaseClosedError":throw new W.DatabaseClosed(r);case"MissingAPIError":throw new W.MissingAPI(r.message,r);default:throw new W.OpenFailed(r)}if(!this.active)throw new W.TransactionInactive;return _(null===this._completion._state),(t=this.idbtrans=t||(this.db.core||n).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=Ct((function(n){De(n),e._reject(t.error)})),t.onabort=Ct((function(n){De(n),e.active&&e._reject(new W.Abort(t.error)),e.active=!1,e.on("abort").fire(n)})),t.oncomplete=Ct((function(){e.active=!1,e._resolve(),"mutatedParts"in t&&Fe.storagemutated.fire(t.mutatedParts)})),this},qe.prototype._promise=function(t,e,n){var r=this;if("readwrite"===t&&"readwrite"!==this.mode)return Jt(new W.ReadOnly("Transaction is readonly"));if(!this.active)return Jt(new W.TransactionInactive);if(this._locked())return new Et((function(i,s){r._blockedFuncs.push([function(){r._promise(t,e,n).then(i,s)},vt])}));if(n)return Ft((function(){var t=new Et((function(t,n){r._lock();var i=e(t,n,r);i&&i.then&&i.then(t,n)}));return t.finally((function(){return r._unlock()})),t._lib=!0,t}));var i=new Et((function(t,n){var i=e(t,n,r);i&&i.then&&i.then(t,n)}));return i._lib=!0,i},qe.prototype._root=function(){return this.parent?this.parent._root():this},qe.prototype.waitFor=function(t){var e,n=this._root(),r=Et.resolve(t);n._waitingFor?n._waitingFor=n._waitingFor.then((function(){return r})):(n._waitingFor=r,n._waitingQueue=[],e=n.idbtrans.objectStore(n.storeNames[0]),function t(){for(++n._spinCount;n._waitingQueue.length;)n._waitingQueue.shift()();n._waitingFor&&(e.get(-1/0).onsuccess=t)}());var i=n._waitingFor;return new Et((function(t,e){r.then((function(e){return n._waitingQueue.push(Ct(t.bind(null,e)))}),(function(t){return n._waitingQueue.push(Ct(e.bind(null,t)))})).finally((function(){n._waitingFor===i&&(n._waitingFor=null)}))}))},qe.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new W.Abort))},qe.prototype.table=function(t){var e=this._memoizedTables||(this._memoizedTables={});if(c(e,t))return e[t];var n=this.schema[t];if(!n)throw new W.NotFound("Table "+t+" not part of transaction");return(n=new this.db.Table(t,n,this)).core=this.db.core.table(t),e[t]=n},qe);function qe(){}function Ve(t,e,n,r,i,s,a){return{name:t,keyPath:e,unique:n,multi:r,auto:i,compound:s,src:(n&&!a?"&":"")+(r?"*":"")+(i?"++":"")+Ge(e)}}function Ge(t){return"string"==typeof t?t:t?"["+[].join.call(t,"+")+"]":""}function We(t,e,n){return{name:t,primKey:e,indexes:n,mappedClass:null,idxByName:(r=function(t){return[t.name,t]},n.reduce((function(t,e,n){return(n=r(e))&&(t[n[0]]=n[1]),t}),{}))};var r}var ze=function(t){try{return t.only([[]]),ze=function(){return[[]]},[[]]}catch(t){return ze=function(){return Qt},Qt}};function He(t){return null==t?function(){}:"string"==typeof t?1===(e=t).split(".").length?function(t){return t[e]}:function(t){return w(t,e)}:function(e){return w(e,t)};var e}function Xe(t){return[].slice.call(t)}var Ye=0;function Je(t){return null==t?":id":"string"==typeof t?t:"[".concat(t.join("+"),"]")}function Qe(t,e,n){function r(t){if(3===t.type)return null;if(4===t.type)throw new Error("Cannot convert never type to IDBKeyRange");var n=t.lower,r=t.upper,i=t.lowerOpen;return t=t.upperOpen,void 0===n?void 0===r?null:e.upperBound(r,!!t):void 0===r?e.lowerBound(n,!!i):e.bound(n,r,!!i,!!t)}var i,s,o,u=(s=n,o=Xe((i=t).objectStoreNames),{schema:{name:i.name,tables:o.map((function(t){return s.objectStore(t)})).map((function(t){var e=t.keyPath,n=t.autoIncrement,r=a(e),i={};return n={name:t.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:null==e,compound:r,keyPath:e,autoIncrement:n,unique:!0,extractKey:He(e)},indexes:Xe(t.indexNames).map((function(e){return t.index(e)})).map((function(t){var e=t.name,n=t.unique,r=t.multiEntry;return t=t.keyPath,r={name:e,compound:a(t),keyPath:t,unique:n,multiEntry:r,extractKey:He(t)},i[Je(t)]=r})),getIndexByKeyPath:function(t){return i[Je(t)]}},i[":id"]=n.primaryKey,null!=e&&(i[Je(e)]=n.primaryKey),n}))},hasGetAll:0<o.length&&"getAll"in s.objectStore(o[0])&&!("undefined"!=typeof navigator&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),l=(n=u.schema,u.hasGetAll),c=(u=n.tables.map((function(t){var e,n=t.name;return{name:n,schema:t,mutate:function(t){var e=t.trans,i=t.type,s=t.keys,a=t.values,o=t.range;return new Promise((function(t,u){t=Ct(t);var l=e.objectStore(n),c=null==l.keyPath,h="put"===i||"add"===i;if(!h&&"delete"!==i&&"deleteRange"!==i)throw new Error("Invalid operation type: "+i);var d,p=(s||a||{length:1}).length;if(s&&a&&s.length!==a.length)throw new Error("Given keys array must have same length as given values array.");if(0===p)return t({numFailures:0,failures:{},results:[],lastResult:void 0});function f(t){++y,De(t)}var m=[],g=[],y=0;if("deleteRange"===i){if(4===o.type)return t({numFailures:y,failures:g,results:[],lastResult:void 0});3===o.type?m.push(d=l.clear()):m.push(d=l.delete(r(o)))}else{var v=(c=h?c?[a,s]:[a,null]:[s,null])[0],_=c[1];if(h)for(var b=0;b<p;++b)m.push(d=_&&void 0!==_[b]?l[i](v[b],_[b]):l[i](v[b])),d.onerror=f;else for(b=0;b<p;++b)m.push(d=l[i](v[b])),d.onerror=f}function w(e){e=e.target.result,m.forEach((function(t,e){return null!=t.error&&(g[e]=t.error)})),t({numFailures:y,failures:g,results:"delete"===i?s:m.map((function(t){return t.result})),lastResult:e})}d.onerror=function(t){f(t),w(t)},d.onsuccess=w}))},getMany:function(t){var e=t.trans,r=t.keys;return new Promise((function(t,i){t=Ct(t);for(var s,a=e.objectStore(n),o=r.length,u=new Array(o),l=0,c=0,h=function(e){e=e.target,u[e._pos]=e.result,++c===l&&t(u)},d=je(i),p=0;p<o;++p)null!=r[p]&&((s=a.get(r[p]))._pos=p,s.onsuccess=h,s.onerror=d,++l);0===l&&t(u)}))},get:function(t){var e=t.trans,r=t.key;return new Promise((function(t,i){t=Ct(t);var s=e.objectStore(n).get(r);s.onsuccess=function(e){return t(e.target.result)},s.onerror=je(i)}))},query:(e=l,function(t){return new Promise((function(i,s){i=Ct(i);var a,o,u,l=t.trans,c=t.values,h=t.limit,d=t.query,p=h===1/0?void 0:h,f=d.index;if(d=d.range,l=l.objectStore(n),f=f.isPrimaryKey?l:l.index(f.name),d=r(d),0===h)return i({result:[]});e?((p=c?f.getAll(d,p):f.getAllKeys(d,p)).onsuccess=function(t){return i({result:t.target.result})},p.onerror=je(s)):(a=0,o=!c&&"openKeyCursor"in f?f.openKeyCursor(d):f.openCursor(d),u=[],o.onsuccess=function(t){var e=o.result;return e?(u.push(c?e.value:e.primaryKey),++a===h?i({result:u}):void e.continue()):i({result:u})},o.onerror=je(s))}))}),openCursor:function(t){var e=t.trans,i=t.values,s=t.query,a=t.reverse,o=t.unique;return new Promise((function(t,u){t=Ct(t);var l=s.index,c=s.range,h=e.objectStore(n),d=(h=l.isPrimaryKey?h:h.index(l.name),l=a?o?"prevunique":"prev":o?"nextunique":"next",!i&&"openKeyCursor"in h?h.openKeyCursor(r(c),l):h.openCursor(r(c),l));d.onerror=je(u),d.onsuccess=Ct((function(n){var r,i,s,a,o=d.result;o?(o.___id=++Ye,o.done=!1,r=o.continue.bind(o),i=(i=o.continuePrimaryKey)&&i.bind(o),s=o.advance.bind(o),a=function(){throw new Error("Cursor not stopped")},o.trans=e,o.stop=o.continue=o.continuePrimaryKey=o.advance=function(){throw new Error("Cursor not started")},o.fail=Ct(u),o.next=function(){var t=this,e=1;return this.start((function(){return e--?t.continue():t.stop()})).then((function(){return t}))},o.start=function(t){function e(){if(d.result)try{t()}catch(t){o.fail(t)}else o.done=!0,o.start=function(){throw new Error("Cursor behind last entry")},o.stop()}var n=new Promise((function(t,e){t=Ct(t),d.onerror=je(e),o.fail=e,o.stop=function(e){o.stop=o.continue=o.continuePrimaryKey=o.advance=a,t(e)}}));return d.onsuccess=Ct((function(t){d.onsuccess=e,e()})),o.continue=r,o.continuePrimaryKey=i,o.advance=s,e(),n},t(o)):t(null)}),u)}))},count:function(t){var e=t.query,i=t.trans,s=e.index,a=e.range;return new Promise((function(t,e){var o=i.objectStore(n),u=s.isPrimaryKey?o:o.index(s.name);(u=(o=r(a))?u.count(o):u.count()).onsuccess=Ct((function(e){return t(e.target.result)})),u.onerror=je(e)}))}}})),{});return u.forEach((function(t){return c[t.name]=t})),{stack:"dbcore",transaction:t.transaction.bind(t),table:function(t){if(!c[t])throw new Error("Table '".concat(t,"' not found"));return c[t]},MIN_KEY:-1/0,MAX_KEY:ze(e),schema:n}}function Ze(t,n){var r=n.db;n=function(t,n,r,i){var s=r.IDBKeyRange;return r.indexedDB,{dbcore:(i=Qe(n,s,i),t.dbcore.reduce((function(t,n){return n=n.create,e(e({},t),n(t))}),i))}}(t._middlewares,r,t._deps,n),t.core=n.dbcore,t.tables.forEach((function(e){var n=e.name;t.core.schema.tables.some((function(t){return t.name===n}))&&(e.core=t.core.table(n),t[n]instanceof t.Table&&(t[n].core=e.core))}))}function tn(t,e,n,r){n.forEach((function(n){var i=r[n];e.forEach((function(e){var r=function t(e,n){return m(e,n)||(e=u(e))&&t(e,n)}(e,n);(!r||"value"in r&&void 0===r.value)&&(e===t.Transaction.prototype||e instanceof t.Transaction?p(e,n,{get:function(){return this.table(n)},set:function(t){d(this,n,{value:t,writable:!0,configurable:!0,enumerable:!0})}}):e[n]=new t.Table(n,i))}))}))}function en(t,e){e.forEach((function(e){for(var n in e)e[n]instanceof t.Table&&delete e[n]}))}function nn(t,e){return t._cfg.version-e._cfg.version}function rn(t,e){var n,r={del:[],add:[],change:[]};for(n in t)e[n]||r.del.push(n);for(n in e){var i=t[n],s=e[n];if(i){var a={name:n,def:s,recreate:!1,del:[],add:[],change:[]};if(""+(i.primKey.keyPath||"")!=""+(s.primKey.keyPath||"")||i.primKey.auto!==s.primKey.auto)a.recreate=!0,r.change.push(a);else{var o=i.idxByName,u=s.idxByName,l=void 0;for(l in o)u[l]||a.del.push(l);for(l in u){var c=o[l],h=u[l];c?c.src!==h.src&&a.change.push(h):a.add.push(h)}(0<a.del.length||0<a.add.length||0<a.change.length)&&r.change.push(a)}}else r.add.push([n,s])}return r}function sn(t,e,n,r){var i=t.db.createObjectStore(e,n.keyPath?{keyPath:n.keyPath,autoIncrement:n.auto}:{autoIncrement:n.auto});return r.forEach((function(t){return on(i,t)})),i}function an(t,e){s(t).forEach((function(n){e.db.objectStoreNames.contains(n)||(it&&console.debug("Dexie: Creating missing table",n),sn(e,n,t[n].primKey,t[n].indexes))}))}function on(t,e){t.createIndex(e.name,e.keyPath,{unique:e.unique,multiEntry:e.multi})}function un(t,e,n){var r={};return y(e.objectStoreNames,0).forEach((function(t){for(var e=n.objectStore(t),i=Ve(Ge(o=e.keyPath),o||"",!0,!1,!!e.autoIncrement,o&&"string"!=typeof o,!0),s=[],a=0;a<e.indexNames.length;++a){var o=(u=e.index(e.indexNames[a])).keyPath,u=Ve(u.name,o,!!u.unique,!!u.multiEntry,!1,o&&"string"!=typeof o,!1);s.push(u)}r[t]=We(t,i,s)})),r}function ln(t,e,n){for(var r=n.db.objectStoreNames,s=0;s<r.length;++s){var a=r[s],o=n.objectStore(a);t._hasGetAll="getAll"in o;for(var u=0;u<o.indexNames.length;++u){var l=o.indexNames[u],c=o.index(l).keyPath,h="string"==typeof c?c:"["+y(c).join("+")+"]";!e[a]||(c=e[a].idxByName[h])&&(c.name=l,delete e[a].idxByName[h],e[a].idxByName[l]=c)}}"undefined"!=typeof navigator&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&i.WorkerGlobalScope&&i instanceof i.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(t._hasGetAll=!1)}function cn(t){return t.split(",").map((function(t,e){var n=(t=t.trim()).replace(/([&*]|\+\+)/g,""),r=/^\[/.test(n)?n.match(/^\[(.*)\]$/)[1].split("+"):n;return Ve(n,r||null,/\&/.test(t),/\*/.test(t),/\+\+/.test(t),a(r),0===e)}))}var hn=(dn.prototype._parseStoresSpec=function(t,e){s(t).forEach((function(n){if(null!==t[n]){var r=cn(t[n]),i=r.shift();if(i.unique=!0,i.multi)throw new W.Schema("Primary key cannot be multi-valued");r.forEach((function(t){if(t.auto)throw new W.Schema("Only primary key can be marked as autoIncrement (++)");if(!t.keyPath)throw new W.Schema("Index must have a name and cannot be an empty string")})),e[n]=We(n,i,r)}}))},dn.prototype.stores=function(t){var e=this.db;this._cfg.storesSource=this._cfg.storesSource?o(this._cfg.storesSource,t):t,t=e._versions;var n={},r={};return t.forEach((function(t){o(n,t._cfg.storesSource),r=t._cfg.dbschema={},t._parseStoresSpec(n,r)})),e._dbSchema=r,en(e,[e._allTables,e,e.Transaction.prototype]),tn(e,[e._allTables,e,e.Transaction.prototype,this._cfg.tables],s(r),r),e._storeNames=s(r),this},dn.prototype.upgrade=function(t){return this._cfg.contentUpgrade=rt(this._cfg.contentUpgrade||X,t),this},dn);function dn(){}function pn(t,e){var n=t._dbNamesDB;return n||(n=t._dbNamesDB=new Yn(ne,{addons:[],indexedDB:t,IDBKeyRange:e})).version(1).stores({dbnames:"name"}),n.table("dbnames")}function fn(t){return t&&"function"==typeof t.databases}function mn(t){return Ft((function(){return vt.letThrough=!0,t()}))}function gn(t){return!("from"in t)}var yn=function(t,e){if(!this){var n=new yn;return t&&"d"in t&&o(n,t),n}o(this,arguments.length?{d:1,from:t,to:1<arguments.length?e:t}:{d:0})};function vn(t,e,n){var r=le(e,n);if(!isNaN(r)){if(0<r)throw RangeError();if(gn(t))return o(t,{from:e,to:n,d:1});var i=t.l;if(r=t.r,le(n,t.from)<0)return i?vn(i,e,n):t.l={from:e,to:n,d:1,l:null,r:null},En(t);if(0<le(e,t.to))return r?vn(r,e,n):t.r={from:e,to:n,d:1,l:null,r:null},En(t);le(e,t.from)<0&&(t.from=e,t.l=null,t.d=r?r.d+1:1),0<le(n,t.to)&&(t.to=n,t.r=null,t.d=t.l?t.l.d+1:1),n=!t.r,i&&!t.l&&_n(t,i),r&&n&&_n(t,r)}}function _n(t,e){gn(e)||function t(e,n){var r=n.from,i=n.to,s=n.l;n=n.r,vn(e,r,i),s&&t(e,s),n&&t(e,n)}(t,e)}function bn(t,e){var n=wn(e),r=n.next();if(r.done)return!1;for(var i=r.value,s=wn(t),a=s.next(i.from),o=a.value;!r.done&&!a.done;){if(le(o.from,i.to)<=0&&0<=le(o.to,i.from))return!0;le(i.from,o.from)<0?i=(r=n.next(o.from)).value:o=(a=s.next(i.from)).value}return!1}function wn(t){var e=gn(t)?null:{s:0,n:t};return{next:function(t){for(var n=0<arguments.length;e;)switch(e.s){case 0:if(e.s=1,n)for(;e.n.l&&le(t,e.n.from)<0;)e={up:e,n:e.n.l,s:1};else for(;e.n.l;)e={up:e,n:e.n.l,s:1};case 1:if(e.s=2,!n||le(t,e.n.to)<=0)return{value:e.n,done:!1};case 2:if(e.n.r){e.s=3,e={up:e,n:e.n.r,s:0};continue}case 3:e=e.up}return{done:!0}}}}function En(t){var n,r,i=((null===(n=t.r)||void 0===n?void 0:n.d)||0)-((null===(r=t.l)||void 0===r?void 0:r.d)||0),s=1<i?"r":i<-1?"l":"";s&&(n="r"==s?"l":"r",r=e({},t),i=t[s],t.from=i.from,t.to=i.to,t[s]=i[s],r[s]=i[n],(t[n]=r).d=In(r)),t.d=In(t)}function In(t){var e=t.r;return t=t.l,(e?t?Math.max(e.d,t.d):e.d:t?t.d:0)+1}function Sn(t,e){return s(e).forEach((function(n){t[n]?_n(t[n],e[n]):t[n]=function t(e){var n,r,i={};for(n in e)c(e,n)&&(r=e[n],i[n]=!r||"object"!=typeof r||x.has(r.constructor)?r:t(r));return i}(e[n])})),t}function kn(t,e){return t.all||e.all||Object.keys(t).some((function(n){return e[n]&&bn(e[n],t[n])}))}h(yn.prototype,((D={add:function(t){return _n(this,t),this},addKey:function(t){return vn(this,t,t),this},addKeys:function(t){var e=this;return t.forEach((function(t){return vn(e,t,t)})),this},hasKey:function(t){var e=wn(this).next(t).value;return e&&le(e.from,t)<=0&&0<=le(e.to,t)}})[N]=function(){return wn(this)},D));var Tn={},xn={},$n=!1;function Ln(t){Sn(xn,t),$n||($n=!0,setTimeout((function(){$n=!1,On(xn,!(xn={}))}),0))}function On(t,e){void 0===e&&(e=!1);var n=new Set;if(t.all)for(var r=0,i=Object.values(Tn);r<i.length;r++)Pn(a=i[r],t,n,e);else for(var s in t){var a,o=/^idb\:\/\/(.*)\/(.*)\//.exec(s);o&&(s=o[1],o=o[2],(a=Tn["idb://".concat(s,"/").concat(o)])&&Pn(a,t,n,e))}n.forEach((function(t){return t()}))}function Pn(t,e,n,r){for(var i=[],s=0,a=Object.entries(t.queries.query);s<a.length;s++){for(var o=a[s],u=o[0],l=[],c=0,h=o[1];c<h.length;c++){var d=h[c];kn(e,d.obsSet)?d.subscribers.forEach((function(t){return n.add(t)})):r&&l.push(d)}r&&i.push([u,l])}if(r)for(var p=0,f=i;p<f.length;p++){var m=f[p];u=m[0],l=m[1],t.queries.query[u]=l}}function Nn(t){var e=t._state,n=t._deps.indexedDB;if(e.isBeingOpened||t.idbdb)return e.dbReadyPromise.then((function(){return e.dbOpenError?Jt(e.dbOpenError):t}));e.isBeingOpened=!0,e.dbOpenError=null,e.openComplete=!1;var r=e.openCanceller,i=Math.round(10*t.verno),a=!1;function o(){if(e.openCanceller!==r)throw new W.DatabaseClosed("db.open() was cancelled")}var u,l=e.dbReadyResolve,c=null,h=!1;return Et.race([r,("undefined"==typeof navigator?Et.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(t){function e(){return indexedDB.databases().finally(t)}u=setInterval(e,100),e()})).finally((function(){return clearInterval(u)})):Promise.resolve()).then((function r(){return new Et((function(u,l){if(o(),!n)throw new W.MissingAPI;var d=t.name,p=e.autoSchema||!i?n.open(d):n.open(d,i);if(!p)throw new W.MissingAPI;p.onerror=je(l),p.onblocked=Ct(t._fireOnBlocked),p.onupgradeneeded=Ct((function(r){var i;c=p.transaction,e.autoSchema&&!t._options.allowEmptyDB?(p.onerror=De,c.abort(),p.result.close(),(i=n.deleteDatabase(d)).onsuccess=i.onerror=Ct((function(){l(new W.NoSuchDatabase("Database ".concat(d," doesnt exist")))}))):(c.onerror=je(l),r=r.oldVersion>Math.pow(2,62)?0:r.oldVersion,h=r<1,t.idbdb=p.result,a&&function(t,e){an(t._dbSchema,e),e.db.version%10!=0||e.objectStoreNames.contains("$meta")||e.db.createObjectStore("$meta").add(Math.ceil(e.db.version/10-1),"version");var n=un(0,t.idbdb,e);ln(t,t._dbSchema,e);for(var r=0,i=rn(n,t._dbSchema).change;r<i.length;r++){var s=function(t){if(t.change.length||t.recreate)return console.warn("Unable to patch indexes of table ".concat(t.name," because it has changes on the type of index or primary key.")),{value:void 0};var n=e.objectStore(t.name);t.add.forEach((function(e){it&&console.debug("Dexie upgrade patch: Creating missing index ".concat(t.name,".").concat(e.src)),on(n,e)}))}(i[r]);if("object"==typeof s)return s.value}}(t,c),function(t,e,n,r){var i=t._dbSchema;n.objectStoreNames.contains("$meta")&&!i.$meta&&(i.$meta=We("$meta",cn("")[0],[]),t._storeNames.push("$meta"));var a=t._createTransaction("readwrite",t._storeNames,i);a.create(n),a._completion.catch(r);var o=a._reject.bind(a),u=vt.transless||vt;Ft((function(){return vt.trans=a,vt.transless=u,0!==e?(Ze(t,n),l=e,((r=a).storeNames.includes("$meta")?r.table("$meta").get("version").then((function(t){return null!=t?t:l})):Et.resolve(l)).then((function(e){return i=e,o=a,u=n,l=[],e=(r=t)._versions,c=r._dbSchema=un(0,r.idbdb,u),0!==(e=e.filter((function(t){return t._cfg.version>=i}))).length?(e.forEach((function(t){l.push((function(){var e=c,n=t._cfg.dbschema;ln(r,e,u),ln(r,n,u),c=r._dbSchema=n;var a=rn(e,n);a.add.forEach((function(t){sn(u,t[0],t[1].primKey,t[1].indexes)})),a.change.forEach((function(t){if(t.recreate)throw new W.Upgrade("Not yet support for changing primary key");var e=u.objectStore(t.name);t.add.forEach((function(t){return on(e,t)})),t.change.forEach((function(t){e.deleteIndex(t.name),on(e,t)})),t.del.forEach((function(t){return e.deleteIndex(t)}))}));var l=t._cfg.contentUpgrade;if(l&&t._cfg.version>i){Ze(r,u),o._memoizedTables={};var h=I(n);a.del.forEach((function(t){h[t]=e[t]})),en(r,[r.Transaction.prototype]),tn(r,[r.Transaction.prototype],s(h),h),o.schema=h;var d,p=j(l);return p&&Bt(),a=Et.follow((function(){var t;(d=l(o))&&p&&(t=qt.bind(null,null),d.then(t,t))})),d&&"function"==typeof d.then?Et.resolve(d):a.then((function(){return d}))}})),l.push((function(e){var n,i,s=t._cfg.dbschema;n=s,i=e,[].slice.call(i.db.objectStoreNames).forEach((function(t){return null==n[t]&&i.db.deleteObjectStore(t)})),en(r,[r.Transaction.prototype]),tn(r,[r.Transaction.prototype],r._storeNames,r._dbSchema),o.schema=r._dbSchema})),l.push((function(e){r.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(r.idbdb.version/10)===t._cfg.version?(r.idbdb.deleteObjectStore("$meta"),delete r._dbSchema.$meta,r._storeNames=r._storeNames.filter((function(t){return"$meta"!==t}))):e.objectStore("$meta").put(t._cfg.version,"version"))}))})),function t(){return l.length?Et.resolve(l.shift()(o.idbtrans)).then(t):Et.resolve()}().then((function(){an(c,u)}))):Et.resolve();var r,i,o,u,l,c})).catch(o)):(s(i).forEach((function(t){sn(n,t,i[t].primKey,i[t].indexes)})),Ze(t,n),void Et.follow((function(){return t.on.populate.fire(a)})).catch(o));var r,l}))}(t,r/10,c,l))}),l),p.onsuccess=Ct((function(){c=null;var n,o,l,f,m,g=t.idbdb=p.result,v=y(g.objectStoreNames);if(0<v.length)try{var _=g.transaction(1===(f=v).length?f[0]:f,"readonly");if(e.autoSchema)o=g,l=_,(n=t).verno=o.version/10,l=n._dbSchema=un(0,o,l),n._storeNames=y(o.objectStoreNames,0),tn(n,[n._allTables],s(l),l);else if(ln(t,t._dbSchema,_),((m=rn(un(0,(m=t).idbdb,_),m._dbSchema)).add.length||m.change.some((function(t){return t.add.length||t.change.length})))&&!a)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),g.close(),i=g.version+1,a=!0,u(r());Ze(t,_)}catch(n){}ee.push(t),g.onversionchange=Ct((function(n){e.vcFired=!0,t.on("versionchange").fire(n)})),g.onclose=Ct((function(e){t.on("close").fire(e)})),h&&(m=t._deps,_=d,g=m.indexedDB,m=m.IDBKeyRange,fn(g)||_===ne||pn(g,m).put({name:_}).catch(X)),u()}),l)})).catch((function(t){switch(null==t?void 0:t.name){case"UnknownError":if(0<e.PR1398_maxLoop)return e.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),r();break;case"VersionError":if(0<i)return i=0,r()}return Et.reject(t)}))}))]).then((function(){return o(),e.onReadyBeingFired=[],Et.resolve(mn((function(){return t.on.ready.fire(t.vip)}))).then((function n(){if(0<e.onReadyBeingFired.length){var r=e.onReadyBeingFired.reduce(rt,X);return e.onReadyBeingFired=[],Et.resolve(mn((function(){return r(t.vip)}))).then(n)}}))})).finally((function(){e.openCanceller===r&&(e.onReadyBeingFired=null,e.isBeingOpened=!1)})).catch((function(n){e.dbOpenError=n;try{c&&c.abort()}catch(n){}return r===e.openCanceller&&t._close(),Jt(n)})).finally((function(){e.openComplete=!0,l()})).then((function(){var e;return h&&(e={},t.tables.forEach((function(n){n.schema.indexes.forEach((function(r){r.name&&(e["idb://".concat(t.name,"/").concat(n.name,"/").concat(r.name)]=new yn(-1/0,[[[]]]))})),e["idb://".concat(t.name,"/").concat(n.name,"/")]=e["idb://".concat(t.name,"/").concat(n.name,"/:dels")]=new yn(-1/0,[[[]]])})),Fe(Ke).fire(e),On(e,!0)),t}))}function An(t){function e(e){return t.next(e)}var n=i(e),r=i((function(e){return t.throw(e)}));function i(t){return function(e){var i=t(e);return e=i.value,i.done?e:e&&"function"==typeof e.then?e.then(n,r):a(e)?Promise.all(e).then(n,r):n(e)}}return i(e)()}function Cn(t,e,n){for(var r=a(t)?t.slice():[t],i=0;i<n;++i)r.push(e);return r}var Rn={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(t){return e(e({},t),{table:function(n){var r=t.table(n),i=r.schema,s={},a=[];function o(t,n,r){var i=Je(t),u=s[i]=s[i]||[],l=null==t?0:"string"==typeof t?1:t.length,c=0<n;return c=e(e({},r),{name:c?"".concat(i,"(virtual-from:").concat(r.name,")"):r.name,lowLevelIndex:r,isVirtual:c,keyTail:n,keyLength:l,extractKey:He(t),unique:!c&&r.unique}),u.push(c),c.isPrimaryKey||a.push(c),1<l&&o(2===l?t[0]:t.slice(0,l-1),n+1,r),u.sort((function(t,e){return t.keyTail-e.keyTail})),c}n=o(i.primaryKey.keyPath,0,i.primaryKey),s[":id"]=[n];for(var u=0,l=i.indexes;u<l.length;u++){var c=l[u];o(c.keyPath,0,c)}function h(n){var r,i=n.query.index;return i.isVirtual?e(e({},n),{query:{index:i.lowLevelIndex,range:(r=n.query.range,i=i.keyTail,{type:1===r.type?2:r.type,lower:Cn(r.lower,r.lowerOpen?t.MAX_KEY:t.MIN_KEY,i),lowerOpen:!0,upper:Cn(r.upper,r.upperOpen?t.MIN_KEY:t.MAX_KEY,i),upperOpen:!0})}}):n}return e(e({},r),{schema:e(e({},i),{primaryKey:n,indexes:a,getIndexByKeyPath:function(t){return(t=s[Je(t)])&&t[0]}}),count:function(t){return r.count(h(t))},query:function(t){return r.query(h(t))},openCursor:function(e){var n=e.query.index,i=n.keyTail,s=n.isVirtual,a=n.keyLength;return s?r.openCursor(h(e)).then((function(n){return n&&function(n){return Object.create(n,{continue:{value:function(r){null!=r?n.continue(Cn(r,e.reverse?t.MAX_KEY:t.MIN_KEY,i)):e.unique?n.continue(n.key.slice(0,a).concat(e.reverse?t.MIN_KEY:t.MAX_KEY,i)):n.continue()}},continuePrimaryKey:{value:function(e,r){n.continuePrimaryKey(Cn(e,t.MAX_KEY,i),r)}},primaryKey:{get:function(){return n.primaryKey}},key:{get:function(){var t=n.key;return 1===a?t[0]:t.slice(0,a)}},value:{get:function(){return n.value}}})}(n)})):r.openCursor(e)}})}})}};function Mn(t,e,n,r){return n=n||{},r=r||"",s(t).forEach((function(i){var s,a,o;c(e,i)?(s=t[i],a=e[i],"object"==typeof s&&"object"==typeof a&&s&&a?(o=P(s))!==P(a)?n[r+i]=e[i]:"Object"===o?Mn(s,a,n,r+i+"."):s!==a&&(n[r+i]=e[i]):s!==a&&(n[r+i]=e[i])):n[r+i]=void 0})),s(e).forEach((function(i){c(t,i)||(n[r+i]=e[i])})),n}function jn(t,e){return"delete"===e.type?e.keys:e.keys||e.values.map(t.extractKey)}var Dn={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(t){return e(e({},t),{table:function(n){var i=t.table(n),s=i.schema.primaryKey;return e(e({},i),{mutate:function(t){var a=vt.trans,o=a.table(n).hook,u=o.deleting,l=o.creating,h=o.updating;switch(t.type){case"add":if(l.fire===X)break;return a._promise("readwrite",(function(){return d(t)}),!0);case"put":if(l.fire===X&&h.fire===X)break;return a._promise("readwrite",(function(){return d(t)}),!0);case"delete":if(u.fire===X)break;return a._promise("readwrite",(function(){return d(t)}),!0);case"deleteRange":if(u.fire===X)break;return a._promise("readwrite",(function(){return function t(n,r,a){return i.query({trans:n,values:!1,query:{index:s,range:r},limit:a}).then((function(i){var s=i.result;return d({type:"delete",keys:s,trans:n}).then((function(i){return 0<i.numFailures?Promise.reject(i.failures[0]):s.length<a?{failures:[],numFailures:0,lastResult:void 0}:t(n,e(e({},r),{lower:s[s.length-1],lowerOpen:!0}),a)}))}))}(t.trans,t.range,1e4)}),!0)}return i.mutate(t);function d(t){var n,a,o,d=vt.trans,p=t.keys||jn(s,t);if(!p)throw new Error("Keys missing");return"delete"!==(t="add"===t.type||"put"===t.type?e(e({},t),{keys:p}):e({},t)).type&&(t.values=r([],t.values,!0)),t.keys&&(t.keys=r([],t.keys,!0)),n=i,o=p,("add"===(a=t).type?Promise.resolve([]):n.getMany({trans:a.trans,keys:o,cache:"immutable"})).then((function(e){var n=p.map((function(n,r){var i,a,o,p=e[r],f={onerror:null,onsuccess:null};return"delete"===t.type?u.fire.call(f,n,p,d):"add"===t.type||void 0===p?(i=l.fire.call(f,n,t.values[r],d),null==n&&null!=i&&(t.keys[r]=n=i,s.outbound||E(t.values[r],s.keyPath,n))):(i=Mn(p,t.values[r]),(a=h.fire.call(f,i,n,p,d))&&(o=t.values[r],Object.keys(a).forEach((function(t){c(o,t)?o[t]=a[t]:E(o,t,a[t])})))),f}));return i.mutate(t).then((function(r){for(var i=r.failures,s=r.results,a=r.numFailures,o=(r=r.lastResult,0);o<p.length;++o){var u=(s||p)[o],l=n[o];null==u?l.onerror&&l.onerror(i[o]):l.onsuccess&&l.onsuccess("put"===t.type&&e[o]?t.values[o]:u)}return{failures:i,results:s,numFailures:a,lastResult:r}})).catch((function(t){return n.forEach((function(e){return e.onerror&&e.onerror(t)})),Promise.reject(t)}))}))}}})}})}};function Kn(t,e,n){try{if(!e)return null;if(e.keys.length<t.length)return null;for(var r=[],i=0,s=0;i<e.keys.length&&s<t.length;++i)0===le(e.keys[i],t[s])&&(r.push(n?L(e.values[i]):e.values[i]),++s);return r.length===t.length?r:null}catch(t){return null}}var Un={stack:"dbcore",level:-1,create:function(t){return{table:function(n){var r=t.table(n);return e(e({},r),{getMany:function(t){if(!t.cache)return r.getMany(t);var e=Kn(t.keys,t.trans._cache,"clone"===t.cache);return e?Et.resolve(e):r.getMany(t).then((function(e){return t.trans._cache={keys:t.keys,values:"clone"===t.cache?L(e):e},e}))},mutate:function(t){return"add"!==t.type&&(t.trans._cache=null),r.mutate(t)}})}}}};function Fn(t,e){return"readonly"===t.trans.mode&&!!t.subscr&&!t.trans.explicit&&"disabled"!==t.trans.db._options.cache&&!e.schema.primaryKey.outbound}function Bn(t,e){switch(t){case"query":return e.values&&!e.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var qn={stack:"dbcore",level:0,name:"Observability",create:function(t){var n=t.schema.name,r=new yn(t.MIN_KEY,t.MAX_KEY);return e(e({},t),{transaction:function(e,n,r){if(vt.subscr&&"readonly"!==n)throw new W.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(vt.querier));return t.transaction(e,n,r)},table:function(i){var o=t.table(i),u=o.schema,l=u.primaryKey,c=u.indexes,h=l.extractKey,d=l.outbound,p=l.autoIncrement&&c.filter((function(t){return t.compound&&t.keyPath.includes(l.keyPath)})),f=e(e({},o),{mutate:function(t){function e(t){return t="idb://".concat(n,"/").concat(i,"/").concat(t),f[t]||(f[t]=new yn)}var s,c,h,d=t.trans,f=t.mutatedParts||(t.mutatedParts={}),m=e(""),g=e(":dels"),y=t.type,v="deleteRange"===t.type?[t.range]:"delete"===t.type?[t.keys]:t.values.length<50?[jn(l,t).filter((function(t){return t})),t.values]:[],_=v[0],b=v[1];return v=t.trans._cache,a(_)?(m.addKeys(_),(v="delete"===y||_.length===b.length?Kn(_,v):null)||g.addKeys(_),(v||b)&&(s=e,c=v,h=b,u.indexes.forEach((function(t){var e=s(t.name||"");function n(e){return null!=e?t.extractKey(e):null}function r(n){return t.multiEntry&&a(n)?n.forEach((function(t){return e.addKey(t)})):e.addKey(n)}(c||h).forEach((function(t,e){var i=c&&n(c[e]);0!==le(i,e=h&&n(h[e]))&&(null!=i&&r(i),null!=e&&r(e))}))})))):_?(b={from:_.lower,to:_.upper},g.add(b),m.add(b)):(m.add(r),g.add(r),u.indexes.forEach((function(t){return e(t.name).add(r)}))),o.mutate(t).then((function(n){return!_||"add"!==t.type&&"put"!==t.type||(m.addKeys(n.results),p&&p.forEach((function(r){var i=t.values.map((function(t){return r.extractKey(t)})),s=r.keyPath.findIndex((function(t){return t===l.keyPath}));n.results.forEach((function(t){return i[s]=t})),e(r.name).addKeys(i)}))),d.mutatedParts=Sn(d.mutatedParts||{},f),n}))}}),m=(c=function(e){e=(n=e.query).index;var n=n.range;return[e,new yn(null!==(e=n.lower)&&void 0!==e?e:t.MIN_KEY,null!==(n=n.upper)&&void 0!==n?n:t.MAX_KEY)]},{get:function(t){return[l,new yn(t.key)]},getMany:function(t){return[l,(new yn).addKeys(t.keys)]},count:c,query:c,openCursor:c});return s(m).forEach((function(t){f[t]=function(s){var a=!!(f=vt.subscr),u=Fn(vt,o)&&Bn(t,s)?s.obsSet={}:f;if(a){var l=function(t){return t="idb://".concat(n,"/").concat(i,"/").concat(t),u[t]||(u[t]=new yn)},c=l(""),p=l(":dels"),f=(a=(f=m[t](s))[0],f[1]);if(("query"===t&&a.isPrimaryKey&&!s.values?p:l(a.name||"")).add(f),!a.isPrimaryKey){if("count"!==t){var g="query"===t&&d&&s.values&&o.query(e(e({},s),{values:!1}));return o[t].apply(this,arguments).then((function(e){if("query"===t){if(d&&s.values)return g.then((function(t){return t=t.result,c.addKeys(t),e}));var n=s.values?e.result.map(h):e.result;(s.values?c:p).addKeys(n)}else if("openCursor"===t){var r=e,i=s.values;return r&&Object.create(r,{key:{get:function(){return p.addKey(r.primaryKey),r.key}},primaryKey:{get:function(){var t=r.primaryKey;return p.addKey(t),t}},value:{get:function(){return i&&c.addKey(r.primaryKey),r.value}}})}return e}))}p.add(r)}}return o[t].apply(this,arguments)}})),f}})}};function Vn(t,n,r){if(0===r.numFailures)return n;if("deleteRange"===n.type)return null;var i=n.keys?n.keys.length:"values"in n&&n.values?n.values.length:1;return r.numFailures===i?null:(n=e({},n),a(n.keys)&&(n.keys=n.keys.filter((function(t,e){return!(e in r.failures)}))),"values"in n&&a(n.values)&&(n.values=n.values.filter((function(t,e){return!(e in r.failures)}))),n)}function Gn(t,e){return n=t,(void 0===(r=e).lower||(r.lowerOpen?0<le(n,r.lower):0<=le(n,r.lower)))&&(void 0===e.upper||(e.upperOpen?le(t,e.upper)<0:le(t,e.upper)<=0));var n,r}function Wn(t,e,n,r,i,s){if(!n||0===n.length)return t;var o=e.query.index,u=o.multiEntry,l=e.query.range,c=r.schema.primaryKey.extractKey,h=o.extractKey,d=(o.lowLevelIndex||o).extractKey;return n=n.reduce((function(t,n){var r=t,i=[];if("add"===n.type||"put"===n.type)for(var s=new yn,o=n.values.length-1;0<=o;--o){var d,p=n.values[o],f=c(p);s.hasKey(f)||(d=h(p),(u&&a(d)?d.some((function(t){return Gn(t,l)})):Gn(d,l))&&(s.addKey(f),i.push(p)))}switch(n.type){case"add":r=t.concat(e.values?i:i.map((function(t){return c(t)})));break;case"put":var m=(new yn).addKeys(n.values.map((function(t){return c(t)})));r=t.filter((function(t){return!m.hasKey(e.values?c(t):t)})).concat(e.values?i:i.map((function(t){return c(t)})));break;case"delete":var g=(new yn).addKeys(n.keys);r=t.filter((function(t){return!g.hasKey(e.values?c(t):t)}));break;case"deleteRange":var y=n.range;r=t.filter((function(t){return!Gn(c(t),y)}))}return r}),t),n===t?t:(n.sort((function(t,e){return le(d(t),d(e))||le(c(t),c(e))})),e.limit&&e.limit<1/0&&(n.length>e.limit?n.length=e.limit:t.length===e.limit&&n.length<e.limit&&(i.dirty=!0)),s?Object.freeze(n):n)}function zn(t,e){return 0===le(t.lower,e.lower)&&0===le(t.upper,e.upper)&&!!t.lowerOpen==!!e.lowerOpen&&!!t.upperOpen==!!e.upperOpen}var Hn={stack:"dbcore",level:0,name:"Cache",create:function(t){var n=t.schema.name;return e(e({},t),{transaction:function(e,r,i){var s,a,o=t.transaction(e,r,i);return"readwrite"===r&&(a=(s=new AbortController).signal,i=function(i){return function(){if(s.abort(),"readwrite"===r){for(var a=new Set,u=0,l=e;u<l.length;u++){var c=l[u],h=Tn["idb://".concat(n,"/").concat(c)];if(h){var d=t.table(c),p=h.optimisticOps.filter((function(t){return t.trans===o}));if(o._explicit&&i&&o.mutatedParts)for(var f=0,m=Object.values(h.queries.query);f<m.length;f++)for(var g=0,y=(b=m[f]).slice();g<y.length;g++)kn((w=y[g]).obsSet,o.mutatedParts)&&(C(b,w),w.subscribers.forEach((function(t){return a.add(t)})));else if(0<p.length){h.optimisticOps=h.optimisticOps.filter((function(t){return t.trans!==o}));for(var v=0,_=Object.values(h.queries.query);v<_.length;v++)for(var b,w,E,I=0,S=(b=_[v]).slice();I<S.length;I++)null!=(w=S[I]).res&&o.mutatedParts&&(i&&!w.dirty?(E=Object.isFrozen(w.res),E=Wn(w.res,w.req,p,d,w,E),w.dirty?(C(b,w),w.subscribers.forEach((function(t){return a.add(t)}))):E!==w.res&&(w.res=E,w.promise=Et.resolve({result:E}))):(w.dirty&&C(b,w),w.subscribers.forEach((function(t){return a.add(t)}))))}}}a.forEach((function(t){return t()}))}}},o.addEventListener("abort",i(!1),{signal:a}),o.addEventListener("error",i(!1),{signal:a}),o.addEventListener("complete",i(!0),{signal:a})),o},table:function(r){var i=t.table(r),s=i.schema.primaryKey;return e(e({},i),{mutate:function(t){var a=vt.trans;if(s.outbound||"disabled"===a.db._options.cache||a.explicit)return i.mutate(t);var o=Tn["idb://".concat(n,"/").concat(r)];return o?(a=i.mutate(t),"add"!==t.type&&"put"!==t.type||!(50<=t.values.length||jn(s,t).some((function(t){return null==t})))?(o.optimisticOps.push(t),t.mutatedParts&&Ln(t.mutatedParts),a.then((function(e){0<e.numFailures&&(C(o.optimisticOps,t),(e=Vn(0,t,e))&&o.optimisticOps.push(e),t.mutatedParts&&Ln(t.mutatedParts))})),a.catch((function(){C(o.optimisticOps,t),t.mutatedParts&&Ln(t.mutatedParts)}))):a.then((function(n){var r=Vn(0,e(e({},t),{values:t.values.map((function(t,r){var i;return E(t=null!==(i=s.keyPath)&&void 0!==i&&i.includes(".")?L(t):e({},t),s.keyPath,n.results[r]),t}))}),n);o.optimisticOps.push(r),queueMicrotask((function(){return t.mutatedParts&&Ln(t.mutatedParts)}))})),a):i.mutate(t)},query:function(t){if(!Fn(vt,i)||!Bn("query",t))return i.query(t);var e="immutable"===(null===(o=vt.trans)||void 0===o?void 0:o.db._options.cache),s=(l=vt).requery,a=l.signal,o=function(t,e,n,r){var i=Tn["idb://".concat(t,"/").concat(e)];if(!i)return[];if(!(e=i.queries[n]))return[null,!1,i,null];var s=e[(r.query?r.query.index.name:null)||""];if(!s)return[null,!1,i,null];switch(n){case"query":var a=s.find((function(t){return t.req.limit===r.limit&&t.req.values===r.values&&zn(t.req.query.range,r.query.range)}));return a?[a,!0,i,s]:[s.find((function(t){return("limit"in t.req?t.req.limit:1/0)>=r.limit&&(!r.values||t.req.values)&&function(t,e){return function(t,e,n,r){if(void 0===t)return void 0!==e?-1:0;if(void 0===e)return 1;if(0===(e=le(t,e))){if(n&&r)return 0;if(n)return 1;if(r)return-1}return e}(t.lower,e.lower,t.lowerOpen,e.lowerOpen)<=0&&0<=function(t,e,n,r){if(void 0===t)return void 0!==e?1:0;if(void 0===e)return-1;if(0===(e=le(t,e))){if(n&&r)return 0;if(n)return-1;if(r)return 1}return e}(t.upper,e.upper,t.upperOpen,e.upperOpen)}(t.req.query.range,r.query.range)})),!1,i,s];case"count":return a=s.find((function(t){return zn(t.req.query.range,r.query.range)})),[a,!!a,i,s]}}(n,r,"query",t),u=o[0],l=o[1],c=o[2],h=o[3];return u&&l?u.obsSet=t.obsSet:(l=i.query(t).then((function(t){var n=t.result;if(u&&(u.res=n),e){for(var r=0,i=n.length;r<i;++r)Object.freeze(n[r]);Object.freeze(n)}else t.result=L(n);return t})).catch((function(t){return h&&u&&C(h,u),Promise.reject(t)})),u={obsSet:t.obsSet,promise:l,subscribers:new Set,type:"query",req:t,dirty:!1},h?h.push(u):(h=[u],(c=c||(Tn["idb://".concat(n,"/").concat(r)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[t.query.index.name||""]=h)),function(t,e,n,r){t.subscribers.add(n),r.addEventListener("abort",(function(){var r,i;t.subscribers.delete(n),0===t.subscribers.size&&(r=t,i=e,setTimeout((function(){0===r.subscribers.size&&C(i,r)}),3e3))}))}(u,h,s,a),u.promise.then((function(n){return{result:Wn(n.result,t,null==c?void 0:c.optimisticOps,i,u,e)}}))}})}})}};function Xn(t,e){return new Proxy(t,{get:function(t,n,r){return"db"===n?e:Reflect.get(t,n,r)}})}var Yn=(Jn.prototype.version=function(t){if(isNaN(t)||t<.1)throw new W.Type("Given version is not a positive number");if(t=Math.round(10*t)/10,this.idbdb||this._state.isBeingOpened)throw new W.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,t);var e=this._versions,n=e.filter((function(e){return e._cfg.version===t}))[0];return n||(n=new this.Version(t),e.push(n),e.sort(nn),n.stores({}),this._state.autoSchema=!1,n)},Jn.prototype._whenReady=function(t){var e=this;return this.idbdb&&(this._state.openComplete||vt.letThrough||this._vip)?t():new Et((function(t,n){if(e._state.openComplete)return n(new W.DatabaseClosed(e._state.dbOpenError));if(!e._state.isBeingOpened){if(!e._state.autoOpen)return void n(new W.DatabaseClosed);e.open().catch(X)}e._state.dbReadyPromise.then(t,n)})).then(t)},Jn.prototype.use=function(t){var e=t.stack,n=t.create,r=t.level,i=t.name;return i&&this.unuse({stack:e,name:i}),(t=this._middlewares[e]||(this._middlewares[e]=[])).push({stack:e,create:n,level:null==r?10:r,name:i}),t.sort((function(t,e){return t.level-e.level})),this},Jn.prototype.unuse=function(t){var e=t.stack,n=t.name,r=t.create;return e&&this._middlewares[e]&&(this._middlewares[e]=this._middlewares[e].filter((function(t){return r?t.create!==r:!!n&&t.name!==n}))),this},Jn.prototype.open=function(){var t=this;return Ht(yt,(function(){return Nn(t)}))},Jn.prototype._close=function(){var t=this._state,e=ee.indexOf(this);if(0<=e&&ee.splice(e,1),this.idbdb){try{this.idbdb.close()}catch(e){}this.idbdb=null}t.isBeingOpened||(t.dbReadyPromise=new Et((function(e){t.dbReadyResolve=e})),t.openCanceller=new Et((function(e,n){t.cancelOpen=n})))},Jn.prototype.close=function(t){var e=(void 0===t?{disableAutoOpen:!0}:t).disableAutoOpen;t=this._state,e?(t.isBeingOpened&&t.cancelOpen(new W.DatabaseClosed),this._close(),t.autoOpen=!1,t.dbOpenError=new W.DatabaseClosed):(this._close(),t.autoOpen=this._options.autoOpen||t.isBeingOpened,t.openComplete=!1,t.dbOpenError=null)},Jn.prototype.delete=function(t){var e=this;void 0===t&&(t={disableAutoOpen:!0});var n=0<arguments.length&&"object"!=typeof arguments[0],r=this._state;return new Et((function(i,s){function a(){e.close(t);var n=e._deps.indexedDB.deleteDatabase(e.name);n.onsuccess=Ct((function(){var t,n,r;t=e._deps,n=e.name,r=t.indexedDB,t=t.IDBKeyRange,fn(r)||n===ne||pn(r,t).delete(n).catch(X),i()})),n.onerror=je(s),n.onblocked=e._fireOnBlocked}if(n)throw new W.InvalidArgument("Invalid closeOptions argument to db.delete()");r.isBeingOpened?r.dbReadyPromise.then(a):a()}))},Jn.prototype.backendDB=function(){return this.idbdb},Jn.prototype.isOpen=function(){return null!==this.idbdb},Jn.prototype.hasBeenClosed=function(){var t=this._state.dbOpenError;return t&&"DatabaseClosed"===t.name},Jn.prototype.hasFailed=function(){return null!==this._state.dbOpenError},Jn.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(Jn.prototype,"tables",{get:function(){var t=this;return s(this._allTables).map((function(e){return t._allTables[e]}))},enumerable:!1,configurable:!0}),Jn.prototype.transaction=function(){var t=function(t,e,n){var r=arguments.length;if(r<2)throw new W.InvalidArgument("Too few arguments");for(var i=new Array(r-1);--r;)i[r-1]=arguments[r];return n=i.pop(),[t,k(i),n]}.apply(this,arguments);return this._transaction.apply(this,t)},Jn.prototype._transaction=function(t,e,n){var r=this,i=vt.trans;i&&i.db===this&&-1===t.indexOf("!")||(i=null);var s,a,o=-1!==t.indexOf("?");t=t.replace("!","").replace("?","");try{if(a=e.map((function(t){if("string"!=typeof(t=t instanceof r.Table?t.name:t))throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return t})),"r"==t||t===re)s=re;else{if("rw"!=t&&t!=ie)throw new W.InvalidArgument("Invalid transaction mode: "+t);s=ie}if(i){if(i.mode===re&&s===ie){if(!o)throw new W.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");i=null}i&&a.forEach((function(t){if(i&&-1===i.storeNames.indexOf(t)){if(!o)throw new W.SubTransaction("Table "+t+" not included in parent transaction.");i=null}})),o&&i&&!i.active&&(i=null)}}catch(n){return i?i._promise(null,(function(t,e){e(n)})):Jt(n)}var u=function t(e,n,r,i,s){return Et.resolve().then((function(){var a=vt.transless||vt,o=e._createTransaction(n,r,e._dbSchema,i);if(o.explicit=!0,a={trans:o,transless:a},i)o.idbtrans=i.idbtrans;else try{o.create(),o.idbtrans._explicit=!0,e._state.PR1398_maxLoop=3}catch(a){return a.name===V.InvalidState&&e.isOpen()&&0<--e._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),e.close({disableAutoOpen:!1}),e.open().then((function(){return t(e,n,r,null,s)}))):Jt(a)}var u,l=j(s);return l&&Bt(),a=Et.follow((function(){var t;(u=s.call(o,o))&&(l?(t=qt.bind(null,null),u.then(t,t)):"function"==typeof u.next&&"function"==typeof u.throw&&(u=An(u)))}),a),(u&&"function"==typeof u.then?Et.resolve(u).then((function(t){return o.active?t:Jt(new W.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))})):a.then((function(){return u}))).then((function(t){return i&&o._resolve(),o._completion.then((function(){return t}))})).catch((function(t){return o._reject(t),Jt(t)}))}))}.bind(null,this,s,a,i,n);return i?i._promise(s,u,"lock"):vt.trans?Ht(vt.transless,(function(){return r._whenReady(u)})):this._whenReady(u)},Jn.prototype.table=function(t){if(!c(this._allTables,t))throw new W.InvalidTable("Table ".concat(t," does not exist"));return this._allTables[t]},Jn);function Jn(t,n){var r=this;this._middlewares={},this.verno=0;var i=Jn.dependencies;this._options=n=e({addons:Jn.addons,autoOpen:!0,indexedDB:i.indexedDB,IDBKeyRange:i.IDBKeyRange,cache:"cloned"},n),this._deps={indexedDB:n.indexedDB,IDBKeyRange:n.IDBKeyRange},i=n.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var s,a,o,u,l,c={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:X,dbReadyPromise:null,cancelOpen:X,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:n.autoOpen};c.dbReadyPromise=new Et((function(t){c.dbReadyResolve=t})),c.openCanceller=new Et((function(t,e){c.cancelOpen=e})),this._state=c,this.name=t,this.on=fe(this,"populate","blocked","versionchange","close",{ready:[rt,X]}),this.on.ready.subscribe=v(this.on.ready.subscribe,(function(t){return function(e,n){Jn.vip((function(){var i,s=r._state;s.openComplete?(s.dbOpenError||Et.resolve().then(e),n&&t(e)):s.onReadyBeingFired?(s.onReadyBeingFired.push(e),n&&t(e)):(t(e),i=r,n||t((function t(){i.on.ready.unsubscribe(e),i.on.ready.unsubscribe(t)})))}))}})),this.Collection=(s=this,me(ke.prototype,(function(t,e){this.db=s;var n=ae,r=null;if(e)try{n=e()}catch(t){r=t}var i=t._ctx;t=(e=i.table).hook.reading.fire,this._ctx={table:e,index:i.index,isPrimKey:!i.index||e.schema.primKey.keyPath&&i.index===e.schema.primKey.name,range:n,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:r,or:i.or,valueMapper:t!==Y?t:null}}))),this.Table=(a=this,me(de.prototype,(function(t,e,n){this.db=a,this._tx=n,this.name=t,this.schema=e,this.hook=a._allTables[t]?a._allTables[t].hook:fe(null,{creating:[Z,X],reading:[J,Y],updating:[et,X],deleting:[tt,X]})}))),this.Transaction=(o=this,me(Be.prototype,(function(t,e,n,r,i){var s=this;this.db=o,this.mode=t,this.storeNames=e,this.schema=n,this.chromeTransactionDurability=r,this.idbtrans=null,this.on=fe(this,"complete","error","abort"),this.parent=i||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new Et((function(t,e){s._resolve=t,s._reject=e})),this._completion.then((function(){s.active=!1,s.on.complete.fire()}),(function(t){var e=s.active;return s.active=!1,s.on.error.fire(t),s.parent?s.parent._reject(t):e&&s.idbtrans&&s.idbtrans.abort(),Jt(t)}))}))),this.Version=(u=this,me(hn.prototype,(function(t){this.db=u,this._cfg={version:t,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}}))),this.WhereClause=(l=this,me(Re.prototype,(function(t,e,n){if(this.db=l,this._ctx={table:t,index:":id"===e?null:e,or:n},this._cmp=this._ascending=le,this._descending=function(t,e){return le(e,t)},this._max=function(t,e){return 0<le(t,e)?t:e},this._min=function(t,e){return le(t,e)<0?t:e},this._IDBKeyRange=l._deps.IDBKeyRange,!this._IDBKeyRange)throw new W.MissingAPI}))),this.on("versionchange",(function(t){0<t.newVersion?console.warn("Another connection wants to upgrade database '".concat(r.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(r.name,"'. Closing db now to resume the delete request.")),r.close({disableAutoOpen:!1})})),this.on("blocked",(function(t){!t.newVersion||t.newVersion<t.oldVersion?console.warn("Dexie.delete('".concat(r.name,"') was blocked")):console.warn("Upgrade '".concat(r.name,"' blocked by other connection holding version ").concat(t.oldVersion/10))})),this._maxKey=ze(n.IDBKeyRange),this._createTransaction=function(t,e,n,i){return new r.Transaction(t,e,n,r._options.chromeTransactionDurability,i)},this._fireOnBlocked=function(t){r.on("blocked").fire(t),ee.filter((function(t){return t.name===r.name&&t!==r&&!t._state.vcFired})).map((function(e){return e.on("versionchange").fire(t)}))},this.use(Un),this.use(Hn),this.use(qn),this.use(Rn),this.use(Dn);var h=new Proxy(this,{get:function(t,e,n){if("_vip"===e)return!0;if("table"===e)return function(t){return Xn(r.table(t),h)};var i=Reflect.get(t,e,n);return i instanceof de?Xn(i,h):"tables"===e?i.map((function(t){return Xn(t,h)})):"_createTransaction"===e?function(){return Xn(i.apply(this,arguments),h)}:i}});this.vip=h,i.forEach((function(t){return t(r)}))}D="undefined"!=typeof Symbol&&"observable"in Symbol?Symbol.observable:"@@observable";var Qn,Zn=(tr.prototype.subscribe=function(t,e,n){return this._subscribe(t&&"function"!=typeof t?t:{next:t,error:e,complete:n})},tr.prototype[D]=function(){return this},tr);function tr(t){this._subscribe=t}try{Qn={indexedDB:i.indexedDB||i.mozIndexedDB||i.webkitIndexedDB||i.msIndexedDB,IDBKeyRange:i.IDBKeyRange||i.webkitIDBKeyRange}}catch(T){Qn={indexedDB:null,IDBKeyRange:null}}function er(t){var e,n=!1,r=new Zn((function(r){var i,s=j(t),a=!1,o={},u={},l={get closed(){return a},unsubscribe:function(){a||(a=!0,i&&i.abort(),h&&Fe.storagemutated.unsubscribe(p))}};r.start&&r.start(l);var h=!1,d=function(){return Yt(f)},p=function(t){Sn(o,t),kn(u,o)&&d()},f=function(){var l,f,m;!a&&Qn.indexedDB&&(o={},l={},i&&i.abort(),i=new AbortController,m=function(e){var n=Ot();try{s&&Bt();var r=Ft(t,e);return r=s?r.finally(qt):r}finally{n&&Pt()}}(f={subscr:l,signal:i.signal,requery:d,querier:t,trans:null}),Promise.resolve(m).then((function(t){n=!0,e=t,a||f.signal.aborted||(o={},function(t){for(var e in t)if(c(t,e))return;return 1}(u=l)||h||(Fe(Ke,p),h=!0),Yt((function(){return!a&&r.next&&r.next(t)})))}),(function(t){n=!1,["DatabaseClosedError","AbortError"].includes(null==t?void 0:t.name)||a||Yt((function(){a||r.error&&r.error(t)}))})))};return setTimeout(d,0),l}));return r.hasValue=function(){return n},r.getValue=function(){return e},r}var nr=Yn;function rr(t){var e=sr;try{sr=!0,Fe.storagemutated.fire(t),On(t,!0)}finally{sr=e}}h(nr,e(e({},H),{delete:function(t){return new nr(t,{addons:[]}).delete()},exists:function(t){return new nr(t,{addons:[]}).open().then((function(t){return t.close(),!0})).catch("NoSuchDatabaseError",(function(){return!1}))},getDatabaseNames:function(t){try{return n=(e=nr.dependencies).indexedDB,e=e.IDBKeyRange,(fn(n)?Promise.resolve(n.databases()).then((function(t){return t.map((function(t){return t.name})).filter((function(t){return t!==ne}))})):pn(n,e).toCollection().primaryKeys()).then(t)}catch(t){return Jt(new W.MissingAPI)}var e,n},defineClass:function(){return function(t){o(this,t)}},ignoreTransaction:function(t){return vt.trans?Ht(vt.transless,t):t()},vip:mn,async:function(t){return function(){try{var e=An(t.apply(this,arguments));return e&&"function"==typeof e.then?e:Et.resolve(e)}catch(e){return Jt(e)}}},spawn:function(t,e,n){try{var r=An(t.apply(n,e||[]));return r&&"function"==typeof r.then?r:Et.resolve(r)}catch(t){return Jt(t)}},currentTransaction:{get:function(){return vt.trans||null}},waitFor:function(t,e){return e=Et.resolve("function"==typeof t?nr.ignoreTransaction(t):t).timeout(e||6e4),vt.trans?vt.trans.waitFor(e):e},Promise:Et,debug:{get:function(){return it},set:function(t){st(t)}},derive:f,extend:o,props:h,override:v,Events:fe,on:Fe,liveQuery:er,extendObservabilitySet:Sn,getByKeyPath:w,setByKeyPath:E,delByKeyPath:function(t,e){"string"==typeof e?E(t,e,void 0):"length"in e&&[].map.call(e,(function(e){E(t,e,void 0)}))},shallowClone:I,deepClone:L,getObjectDiff:Mn,cmp:le,asap:b,minKey:-1/0,addons:[],connections:ee,errnames:V,dependencies:Qn,cache:Tn,semVer:"4.0.8",version:"4.0.8".split(".").map((function(t){return parseInt(t)})).reduce((function(t,e,n){return t+e/Math.pow(10,2*n)}))})),nr.maxKey=ze(nr.dependencies.IDBKeyRange),"undefined"!=typeof dispatchEvent&&"undefined"!=typeof addEventListener&&(Fe(Ke,(function(t){sr||(t=new CustomEvent(Ue,{detail:t}),sr=!0,dispatchEvent(t),sr=!1)})),addEventListener(Ue,(function(t){t=t.detail,sr||rr(t)})));var ir,sr=!1,ar=function(){};return"undefined"!=typeof BroadcastChannel&&((ar=function(){(ir=new BroadcastChannel(Ue)).onmessage=function(t){return t.data&&rr(t.data)}})(),"function"==typeof ir.unref&&ir.unref(),Fe(Ke,(function(t){sr||ir.postMessage(t)}))),"undefined"!=typeof addEventListener&&(addEventListener("pagehide",(function(t){if(!Yn.disableBfCache&&t.persisted){it&&console.debug("Dexie: handling persisted pagehide"),null!=ir&&ir.close();for(var e=0,n=ee;e<n.length;e++)n[e].close({disableAutoOpen:!1})}})),addEventListener("pageshow",(function(t){!Yn.disableBfCache&&t.persisted&&(it&&console.debug("Dexie: handling persisted pageshow"),ar(),rr({all:new yn(-1/0,[[]])}))}))),Et.rejectionMapper=function(t,e){return!t||t instanceof U||t instanceof TypeError||t instanceof SyntaxError||!t.name||!z[t.name]?t:(e=new z[t.name](e||t.message,t),"stack"in t&&p(e,"stack",{get:function(){return this.inner.stack}}),e)},st(it),e(Yn,Object.freeze({__proto__:null,Dexie:Yn,liveQuery:er,Entity:ue,cmp:le,PropModSymbol:T,PropModification:Ie,replacePrefix:function(t,e){return new Ie({replacePrefix:[t,e]})},add:function(t){return new Ie({add:t})},remove:function(t){return new Ie({remove:t})},default:Yn,RangeSet:yn,mergeRanges:_n,rangesOverlap:bn}),{default:Yn}),Yn}()},11:(t,e,n)=>{var r;!function(i){var s=Object.hasOwnProperty,a=Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},o="object"==typeof process&&"function"==typeof process.nextTick,u="function"==typeof Symbol,l="object"==typeof Reflect,c="function"==typeof setImmediate?setImmediate:setTimeout,h=u?l&&"function"==typeof Reflect.ownKeys?Reflect.ownKeys:function(t){var e=Object.getOwnPropertyNames(t);return e.push.apply(e,Object.getOwnPropertySymbols(t)),e}:Object.keys;function d(){this._events={},this._conf&&p.call(this,this._conf)}function p(t){t&&(this._conf=t,t.delimiter&&(this.delimiter=t.delimiter),t.maxListeners!==i&&(this._maxListeners=t.maxListeners),t.wildcard&&(this.wildcard=t.wildcard),t.newListener&&(this._newListener=t.newListener),t.removeListener&&(this._removeListener=t.removeListener),t.verboseMemoryLeak&&(this.verboseMemoryLeak=t.verboseMemoryLeak),t.ignoreErrors&&(this.ignoreErrors=t.ignoreErrors),this.wildcard&&(this.listenerTree={}))}function f(t,e){var n="(node) warning: possible EventEmitter memory leak detected. "+t+" listeners added. Use emitter.setMaxListeners() to increase limit.";if(this.verboseMemoryLeak&&(n+=" Event name: "+e+"."),"undefined"!=typeof process&&process.emitWarning){var r=new Error(n);r.name="MaxListenersExceededWarning",r.emitter=this,r.count=t,process.emitWarning(r)}else console.error(n),console.trace&&console.trace()}var m=function(t,e,n){var r=arguments.length;switch(r){case 0:return[];case 1:return[t];case 2:return[t,e];case 3:return[t,e,n];default:for(var i=new Array(r);r--;)i[r]=arguments[r];return i}};function g(t,e){for(var n={},r=t.length,s=e?value.length:0,a=0;a<r;a++)n[t[a]]=a<s?e[a]:i;return n}function y(t,e,n){var r,i;if(this._emitter=t,this._target=e,this._listeners={},this._listenersCount=0,(n.on||n.off)&&(r=n.on,i=n.off),e.addEventListener?(r=e.addEventListener,i=e.removeEventListener):e.addListener?(r=e.addListener,i=e.removeListener):e.on&&(r=e.on,i=e.off),!r&&!i)throw Error("target does not implement any known event API");if("function"!=typeof r)throw TypeError("on method must be a function");if("function"!=typeof i)throw TypeError("off method must be a function");this._on=r,this._off=i;var s=t._observers;s?s.push(this):t._observers=[this]}function v(t,e,n,r){var a=Object.assign({},e);if(!t)return a;if("object"!=typeof t)throw TypeError("options must be an object");var o,u,l,c=Object.keys(t),h=c.length;function d(t){throw Error('Invalid "'+o+'" option value'+(t?". Reason: "+t:""))}for(var p=0;p<h;p++){if(o=c[p],!r&&!s.call(e,o))throw Error('Unknown "'+o+'" option');(u=t[o])!==i&&(l=n[o],a[o]=l?l(u,d):u)}return a}function _(t,e){return"function"==typeof t&&t.hasOwnProperty("prototype")||e("value must be a constructor"),t}function b(t){var e="value must be type of "+t.join("|"),n=t.length,r=t[0],i=t[1];return 1===n?function(t,n){if(typeof t===r)return t;n(e)}:2===n?function(t,n){var s=typeof t;if(s===r||s===i)return t;n(e)}:function(r,i){for(var s=typeof r,a=n;a-- >0;)if(s===t[a])return r;i(e)}}Object.assign(y.prototype,{subscribe:function(t,e,n){var r=this,i=this._target,s=this._emitter,a=this._listeners,o=function(){var r=m.apply(null,arguments),a={data:r,name:e,original:t};n?!1!==n.call(i,a)&&s.emit.apply(s,[a.name].concat(r)):s.emit.apply(s,[e].concat(r))};if(a[t])throw Error("Event '"+t+"' is already listening");this._listenersCount++,s._newListener&&s._removeListener&&!r._onNewListener?(this._onNewListener=function(n){n===e&&null===a[t]&&(a[t]=o,r._on.call(i,t,o))},s.on("newListener",this._onNewListener),this._onRemoveListener=function(n){n===e&&!s.hasListeners(n)&&a[t]&&(a[t]=null,r._off.call(i,t,o))},a[t]=null,s.on("removeListener",this._onRemoveListener)):(a[t]=o,r._on.call(i,t,o))},unsubscribe:function(t){var e,n,r,i=this,s=this._listeners,a=this._emitter,o=this._off,u=this._target;if(t&&"string"!=typeof t)throw TypeError("event must be a string");function l(){i._onNewListener&&(a.off("newListener",i._onNewListener),a.off("removeListener",i._onRemoveListener),i._onNewListener=null,i._onRemoveListener=null);var t=S.call(a,i);a._observers.splice(t,1)}if(t){if(!(e=s[t]))return;o.call(u,t,e),delete s[t],--this._listenersCount||l()}else{for(r=(n=h(s)).length;r-- >0;)t=n[r],o.call(u,t,s[t]);this._listeners={},this._listenersCount=0,l()}}});var w=b(["function"]),E=b(["object","function"]);function I(t,e,n){var r,i,s,a=0,o=new t((function(u,l,c){function h(){i&&(i=null),a&&(clearTimeout(a),a=0)}n=v(n,{timeout:0,overload:!1},{timeout:function(t,e){return("number"!=typeof(t*=1)||t<0||!Number.isFinite(t))&&e("timeout must be a positive number"),t}}),r=!n.overload&&"function"==typeof t.prototype.cancel&&"function"==typeof c;var d=function(t){h(),u(t)},p=function(t){h(),l(t)};r?e(d,p,c):(i=[function(t){p(t||Error("canceled"))}],e(d,p,(function(t){if(s)throw Error("Unable to subscribe on cancel event asynchronously");if("function"!=typeof t)throw TypeError("onCancel callback must be a function");i.push(t)})),s=!0),n.timeout>0&&(a=setTimeout((function(){var t=Error("timeout");t.code="ETIMEDOUT",a=0,o.cancel(t),l(t)}),n.timeout))}));return r||(o.cancel=function(t){if(i){for(var e=i.length,n=1;n<e;n++)i[n](t);i[0](t),i=null}}),o}function S(t){var e=this._observers;if(!e)return-1;for(var n=e.length,r=0;r<n;r++)if(e[r]._target===t)return r;return-1}function k(t,e,n,r,i){if(!n)return null;if(0===r){var s=typeof e;if("string"===s){var a,o,u=0,l=0,c=this.delimiter,d=c.length;if(-1!==(o=e.indexOf(c))){a=new Array(5);do{a[u++]=e.slice(l,o),l=o+d}while(-1!==(o=e.indexOf(c,l)));a[u++]=e.slice(l),e=a,i=u}else e=[e],i=1}else"object"===s?i=e.length:(e=[e],i=1)}var p,f,m,g,y,v,_,b=null,w=e[r],E=e[r+1];if(r===i)n._listeners&&("function"==typeof n._listeners?(t&&t.push(n._listeners),b=[n]):(t&&t.push.apply(t,n._listeners),b=[n]));else{if("*"===w){for(o=(v=h(n)).length;o-- >0;)"_listeners"!==(p=v[o])&&(_=k(t,e,n[p],r+1,i))&&(b?b.push.apply(b,_):b=_);return b}if("**"===w){for((y=r+1===i||r+2===i&&"*"===E)&&n._listeners&&(b=k(t,e,n,i,i)),o=(v=h(n)).length;o-- >0;)"_listeners"!==(p=v[o])&&("*"===p||"**"===p?(n[p]._listeners&&!y&&(_=k(t,e,n[p],i,i))&&(b?b.push.apply(b,_):b=_),_=k(t,e,n[p],r,i)):_=k(t,e,n[p],p===E?r+2:r,i),_&&(b?b.push.apply(b,_):b=_));return b}n[w]&&(b=k(t,e,n[w],r+1,i))}if((f=n["*"])&&k(t,e,f,r+1,i),m=n["**"])if(r<i)for(m._listeners&&k(t,e,m,i,i),o=(v=h(m)).length;o-- >0;)"_listeners"!==(p=v[o])&&(p===E?k(t,e,m[p],r+2,i):p===w?k(t,e,m[p],r+1,i):((g={})[p]=m[p],k(t,e,{"**":g},r+1,i)));else m._listeners?k(t,e,m,i,i):m["*"]&&m["*"]._listeners&&k(t,e,m["*"],i,i);return b}function T(t,e,n){var r,i,s=0,a=0,o=this.delimiter,u=o.length;if("string"==typeof t)if(-1!==(r=t.indexOf(o))){i=new Array(5);do{i[s++]=t.slice(a,r),a=r+u}while(-1!==(r=t.indexOf(o,a)));i[s++]=t.slice(a)}else i=[t],s=1;else i=t,s=t.length;if(s>1)for(r=0;r+1<s;r++)if("**"===i[r]&&"**"===i[r+1])return;var l,c=this.listenerTree;for(r=0;r<s;r++)if(c=c[l=i[r]]||(c[l]={}),r===s-1)return c._listeners?("function"==typeof c._listeners&&(c._listeners=[c._listeners]),n?c._listeners.unshift(e):c._listeners.push(e),!c._listeners.warned&&this._maxListeners>0&&c._listeners.length>this._maxListeners&&(c._listeners.warned=!0,f.call(this,c._listeners.length,l))):c._listeners=e,!0;return!0}function x(t,e,n,r){for(var i,s,a,o,u=h(t),l=u.length,c=t._listeners;l-- >0;)i=t[s=u[l]],a="_listeners"===s?n:n?n.concat(s):[s],o=r||"symbol"==typeof s,c&&e.push(o?a:a.join(this.delimiter)),"object"==typeof i&&x.call(this,i,e,a,o);return e}function $(t){for(var e,n,r,i=h(t),s=i.length;s-- >0;)(e=t[n=i[s]])&&(r=!0,"_listeners"===n||$(e)||delete t[n]);return r}function L(t,e,n){this.emitter=t,this.event=e,this.listener=n}function O(t,e,n){if(!0===n)s=!0;else if(!1===n)r=!0;else{if(!n||"object"!=typeof n)throw TypeError("options should be an object or true");var r=n.async,s=n.promisify,a=n.nextTick,u=n.objectify}if(r||a||s){var l=e,h=e._origin||e;if(a&&!o)throw Error("process.nextTick is not supported");s===i&&(s="AsyncFunction"===e.constructor.name),e=function(){var t=arguments,e=this,n=this.event;return s?a?Promise.resolve():new Promise((function(t){c(t)})).then((function(){return e.event=n,l.apply(e,t)})):(a?process.nextTick:c)((function(){e.event=n,l.apply(e,t)}))},e._async=!0,e._origin=h}return[e,u?new L(this,t,e):this]}function P(t){this._events={},this._newListener=!1,this._removeListener=!1,this.verboseMemoryLeak=!1,p.call(this,t)}L.prototype.off=function(){return this.emitter.off(this.event,this.listener),this},P.EventEmitter2=P,P.prototype.listenTo=function(t,e,n){if("object"!=typeof t)throw TypeError("target musts be an object");var r=this;function s(e){if("object"!=typeof e)throw TypeError("events must be an object");var i,s=n.reducers,a=S.call(r,t);i=-1===a?new y(r,t,n):r._observers[a];for(var o,u=h(e),l=u.length,c="function"==typeof s,d=0;d<l;d++)o=u[d],i.subscribe(o,e[o]||o,c?s:s&&s[o])}return n=v(n,{on:i,off:i,reducers:i},{on:w,off:w,reducers:E}),a(e)?s(g(e)):s("string"==typeof e?g(e.split(/\s+/)):e),this},P.prototype.stopListeningTo=function(t,e){var n=this._observers;if(!n)return!1;var r,i=n.length,s=!1;if(t&&"object"!=typeof t)throw TypeError("target should be an object");for(;i-- >0;)r=n[i],t&&r._target!==t||(r.unsubscribe(e),s=!0);return s},P.prototype.delimiter=".",P.prototype.setMaxListeners=function(t){t!==i&&(this._maxListeners=t,this._conf||(this._conf={}),this._conf.maxListeners=t)},P.prototype.getMaxListeners=function(){return this._maxListeners},P.prototype.event="",P.prototype.once=function(t,e,n){return this._once(t,e,!1,n)},P.prototype.prependOnceListener=function(t,e,n){return this._once(t,e,!0,n)},P.prototype._once=function(t,e,n,r){return this._many(t,1,e,n,r)},P.prototype.many=function(t,e,n,r){return this._many(t,e,n,!1,r)},P.prototype.prependMany=function(t,e,n,r){return this._many(t,e,n,!0,r)},P.prototype._many=function(t,e,n,r,i){var s=this;if("function"!=typeof n)throw new Error("many only accepts instances of Function");function a(){return 0==--e&&s.off(t,a),n.apply(this,arguments)}return a._origin=n,this._on(t,a,r,i)},P.prototype.emit=function(){if(!this._events&&!this._all)return!1;this._events||d.call(this);var t,e,n,r,i,s,a=arguments[0],o=this.wildcard;if("newListener"===a&&!this._newListener&&!this._events.newListener)return!1;if(o&&(t=a,"newListener"!==a&&"removeListener"!==a&&"object"==typeof a)){if(n=a.length,u)for(r=0;r<n;r++)if("symbol"==typeof a[r]){s=!0;break}s||(a=a.join(this.delimiter))}var l,c=arguments.length;if(this._all&&this._all.length)for(r=0,n=(l=this._all.slice()).length;r<n;r++)switch(this.event=a,c){case 1:l[r].call(this,a);break;case 2:l[r].call(this,a,arguments[1]);break;case 3:l[r].call(this,a,arguments[1],arguments[2]);break;default:l[r].apply(this,arguments)}if(o)l=[],k.call(this,l,t,this.listenerTree,0,n);else{if("function"==typeof(l=this._events[a])){switch(this.event=a,c){case 1:l.call(this);break;case 2:l.call(this,arguments[1]);break;case 3:l.call(this,arguments[1],arguments[2]);break;default:for(e=new Array(c-1),i=1;i<c;i++)e[i-1]=arguments[i];l.apply(this,e)}return!0}l&&(l=l.slice())}if(l&&l.length){if(c>3)for(e=new Array(c-1),i=1;i<c;i++)e[i-1]=arguments[i];for(r=0,n=l.length;r<n;r++)switch(this.event=a,c){case 1:l[r].call(this);break;case 2:l[r].call(this,arguments[1]);break;case 3:l[r].call(this,arguments[1],arguments[2]);break;default:l[r].apply(this,e)}return!0}if(!this.ignoreErrors&&!this._all&&"error"===a)throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");return!!this._all},P.prototype.emitAsync=function(){if(!this._events&&!this._all)return!1;this._events||d.call(this);var t,e,n,r,i,s,a=arguments[0],o=this.wildcard;if("newListener"===a&&!this._newListener&&!this._events.newListener)return Promise.resolve([!1]);if(o&&(t=a,"newListener"!==a&&"removeListener"!==a&&"object"==typeof a)){if(r=a.length,u)for(i=0;i<r;i++)if("symbol"==typeof a[i]){e=!0;break}e||(a=a.join(this.delimiter))}var l,c=[],h=arguments.length;if(this._all)for(i=0,r=this._all.length;i<r;i++)switch(this.event=a,h){case 1:c.push(this._all[i].call(this,a));break;case 2:c.push(this._all[i].call(this,a,arguments[1]));break;case 3:c.push(this._all[i].call(this,a,arguments[1],arguments[2]));break;default:c.push(this._all[i].apply(this,arguments))}if(o?(l=[],k.call(this,l,t,this.listenerTree,0)):l=this._events[a],"function"==typeof l)switch(this.event=a,h){case 1:c.push(l.call(this));break;case 2:c.push(l.call(this,arguments[1]));break;case 3:c.push(l.call(this,arguments[1],arguments[2]));break;default:for(n=new Array(h-1),s=1;s<h;s++)n[s-1]=arguments[s];c.push(l.apply(this,n))}else if(l&&l.length){if(l=l.slice(),h>3)for(n=new Array(h-1),s=1;s<h;s++)n[s-1]=arguments[s];for(i=0,r=l.length;i<r;i++)switch(this.event=a,h){case 1:c.push(l[i].call(this));break;case 2:c.push(l[i].call(this,arguments[1]));break;case 3:c.push(l[i].call(this,arguments[1],arguments[2]));break;default:c.push(l[i].apply(this,n))}}else if(!this.ignoreErrors&&!this._all&&"error"===a)return arguments[1]instanceof Error?Promise.reject(arguments[1]):Promise.reject("Uncaught, unspecified 'error' event.");return Promise.all(c)},P.prototype.on=function(t,e,n){return this._on(t,e,!1,n)},P.prototype.prependListener=function(t,e,n){return this._on(t,e,!0,n)},P.prototype.onAny=function(t){return this._onAny(t,!1)},P.prototype.prependAny=function(t){return this._onAny(t,!0)},P.prototype.addListener=P.prototype.on,P.prototype._onAny=function(t,e){if("function"!=typeof t)throw new Error("onAny only accepts instances of Function");return this._all||(this._all=[]),e?this._all.unshift(t):this._all.push(t),this},P.prototype._on=function(t,e,n,r){if("function"==typeof t)return this._onAny(t,e),this;if("function"!=typeof e)throw new Error("on only accepts instances of Function");this._events||d.call(this);var s,a=this;return r!==i&&(e=(s=O.call(this,t,e,r))[0],a=s[1]),this._newListener&&this.emit("newListener",t,e),this.wildcard?(T.call(this,t,e,n),a):(this._events[t]?("function"==typeof this._events[t]&&(this._events[t]=[this._events[t]]),n?this._events[t].unshift(e):this._events[t].push(e),!this._events[t].warned&&this._maxListeners>0&&this._events[t].length>this._maxListeners&&(this._events[t].warned=!0,f.call(this,this._events[t].length,t))):this._events[t]=e,a)},P.prototype.off=function(t,e){if("function"!=typeof e)throw new Error("removeListener only takes instances of Function");var n,r=[];if(this.wildcard){var i="string"==typeof t?t.split(this.delimiter):t.slice();if(!(r=k.call(this,null,i,this.listenerTree,0)))return this}else{if(!this._events[t])return this;n=this._events[t],r.push({_listeners:n})}for(var s=0;s<r.length;s++){var o=r[s];if(n=o._listeners,a(n)){for(var u=-1,l=0,c=n.length;l<c;l++)if(n[l]===e||n[l].listener&&n[l].listener===e||n[l]._origin&&n[l]._origin===e){u=l;break}if(u<0)continue;return this.wildcard?o._listeners.splice(u,1):this._events[t].splice(u,1),0===n.length&&(this.wildcard?delete o._listeners:delete this._events[t]),this._removeListener&&this.emit("removeListener",t,e),this}(n===e||n.listener&&n.listener===e||n._origin&&n._origin===e)&&(this.wildcard?delete o._listeners:delete this._events[t],this._removeListener&&this.emit("removeListener",t,e))}return this.listenerTree&&$(this.listenerTree),this},P.prototype.offAny=function(t){var e,n=0,r=0;if(t&&this._all&&this._all.length>0){for(n=0,r=(e=this._all).length;n<r;n++)if(t===e[n])return e.splice(n,1),this._removeListener&&this.emit("removeListenerAny",t),this}else{if(e=this._all,this._removeListener)for(n=0,r=e.length;n<r;n++)this.emit("removeListenerAny",e[n]);this._all=[]}return this},P.prototype.removeListener=P.prototype.off,P.prototype.removeAllListeners=function(t){if(t===i)return!this._events||d.call(this),this;if(this.wildcard){var e,n=k.call(this,null,t,this.listenerTree,0);if(!n)return this;for(e=0;e<n.length;e++)n[e]._listeners=null;this.listenerTree&&$(this.listenerTree)}else this._events&&(this._events[t]=null);return this},P.prototype.listeners=function(t){var e,n,r,s,a,o=this._events;if(t===i){if(this.wildcard)throw Error("event name required for wildcard emitter");if(!o)return[];for(s=(e=h(o)).length,r=[];s-- >0;)"function"==typeof(n=o[e[s]])?r.push(n):r.push.apply(r,n);return r}if(this.wildcard){if(!(a=this.listenerTree))return[];var u=[],l="string"==typeof t?t.split(this.delimiter):t.slice();return k.call(this,u,l,a,0),u}return o&&(n=o[t])?"function"==typeof n?[n]:n:[]},P.prototype.eventNames=function(t){var e=this._events;return this.wildcard?x.call(this,this.listenerTree,[],null,t):e?h(e):[]},P.prototype.listenerCount=function(t){return this.listeners(t).length},P.prototype.hasListeners=function(t){if(this.wildcard){var e=[],n="string"==typeof t?t.split(this.delimiter):t.slice();return k.call(this,e,n,this.listenerTree,0),e.length>0}var r=this._events,s=this._all;return!!(s&&s.length||r&&(t===i?h(r).length:r[t]))},P.prototype.listenersAny=function(){return this._all?this._all:[]},P.prototype.waitFor=function(t,e){var n=this,r=typeof e;return"number"===r?e={timeout:e}:"function"===r&&(e={filter:e}),I((e=v(e,{timeout:0,filter:i,handleError:!1,Promise,overload:!1},{filter:w,Promise:_})).Promise,(function(r,i,s){function a(){var s=e.filter;if(!s||s.apply(n,arguments))if(n.off(t,a),e.handleError){var o=arguments[0];o?i(o):r(m.apply(null,arguments).slice(1))}else r(m.apply(null,arguments))}s((function(){n.off(t,a)})),n._on(t,a,!1)}),{timeout:e.timeout,overload:e.overload})};var N=P.prototype;Object.defineProperties(P,{defaultMaxListeners:{get:function(){return N._maxListeners},set:function(t){if("number"!=typeof t||t<0||Number.isNaN(t))throw TypeError("n must be a non-negative number");N._maxListeners=t},enumerable:!0},once:{value:function(t,e,n){return I((n=v(n,{Promise,timeout:0,overload:!1},{Promise:_})).Promise,(function(n,r,i){var s;if("function"==typeof t.addEventListener)return s=function(){n(m.apply(null,arguments))},i((function(){t.removeEventListener(e,s)})),void t.addEventListener(e,s,{once:!0});var a,o=function(){a&&t.removeListener("error",a),n(m.apply(null,arguments))};"error"!==e&&(a=function(n){t.removeListener(e,o),r(n)},t.once("error",a)),i((function(){a&&t.removeListener("error",a),t.removeListener(e,o)})),t.once(e,o)}),{timeout:n.timeout,overload:n.overload})},writable:!0,configurable:!0}}),Object.defineProperties(N,{_maxListeners:{value:10,writable:!0,configurable:!0},_observers:{value:null,writable:!0,configurable:!0}}),(r=function(){return P}.call(e,n,e,t))===i||(t.exports=r)}()},908:(t,e,n)=>{const r=n(272),{MAX_LENGTH:i,MAX_SAFE_INTEGER:s}=n(874),{safeRe:a,t:o}=n(718),u=n(587),{compareIdentifiers:l}=n(123);class c{constructor(t,e){if(e=u(e),t instanceof c){if(t.loose===!!e.loose&&t.includePrerelease===!!e.includePrerelease)return t;t=t.version}else if("string"!=typeof t)throw new TypeError(`Invalid version. Must be a string. Got type "${typeof t}".`);if(t.length>i)throw new TypeError(`version is longer than ${i} characters`);r("SemVer",t,e),this.options=e,this.loose=!!e.loose,this.includePrerelease=!!e.includePrerelease;const n=t.trim().match(e.loose?a[o.LOOSE]:a[o.FULL]);if(!n)throw new TypeError(`Invalid Version: ${t}`);if(this.raw=t,this.major=+n[1],this.minor=+n[2],this.patch=+n[3],this.major>s||this.major<0)throw new TypeError("Invalid major version");if(this.minor>s||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>s||this.patch<0)throw new TypeError("Invalid patch version");n[4]?this.prerelease=n[4].split(".").map((t=>{if(/^[0-9]+$/.test(t)){const e=+t;if(e>=0&&e<s)return e}return t})):this.prerelease=[],this.build=n[5]?n[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(t){if(r("SemVer.compare",this.version,this.options,t),!(t instanceof c)){if("string"==typeof t&&t===this.version)return 0;t=new c(t,this.options)}return t.version===this.version?0:this.compareMain(t)||this.comparePre(t)}compareMain(t){return t instanceof c||(t=new c(t,this.options)),l(this.major,t.major)||l(this.minor,t.minor)||l(this.patch,t.patch)}comparePre(t){if(t instanceof c||(t=new c(t,this.options)),this.prerelease.length&&!t.prerelease.length)return-1;if(!this.prerelease.length&&t.prerelease.length)return 1;if(!this.prerelease.length&&!t.prerelease.length)return 0;let e=0;do{const n=this.prerelease[e],i=t.prerelease[e];if(r("prerelease compare",e,n,i),void 0===n&&void 0===i)return 0;if(void 0===i)return 1;if(void 0===n)return-1;if(n!==i)return l(n,i)}while(++e)}compareBuild(t){t instanceof c||(t=new c(t,this.options));let e=0;do{const n=this.build[e],i=t.build[e];if(r("build compare",e,n,i),void 0===n&&void 0===i)return 0;if(void 0===i)return 1;if(void 0===n)return-1;if(n!==i)return l(n,i)}while(++e)}inc(t,e,n){switch(t){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",e,n);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",e,n);break;case"prepatch":this.prerelease.length=0,this.inc("patch",e,n),this.inc("pre",e,n);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",e,n),this.inc("pre",e,n);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{const t=Number(n)?1:0;if(!e&&!1===n)throw new Error("invalid increment argument: identifier is empty");if(0===this.prerelease.length)this.prerelease=[t];else{let r=this.prerelease.length;for(;--r>=0;)"number"==typeof this.prerelease[r]&&(this.prerelease[r]++,r=-2);if(-1===r){if(e===this.prerelease.join(".")&&!1===n)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(t)}}if(e){let r=[e,t];!1===n&&(r=[e]),0===l(this.prerelease[0],e)?isNaN(this.prerelease[1])&&(this.prerelease=r):this.prerelease=r}break}default:throw new Error(`invalid increment argument: ${t}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}t.exports=c},560:(t,e,n)=>{const r=n(908);t.exports=(t,e,n)=>new r(t,n).compare(new r(e,n))},580:(t,e,n)=>{const r=n(560);t.exports=(t,e,n)=>r(t,e,n)>0},874:t=>{const e=Number.MAX_SAFE_INTEGER||9007199254740991;t.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:e,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}},272:t=>{const e="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...t)=>console.error("SEMVER",...t):()=>{};t.exports=e},123:t=>{const e=/^[0-9]+$/,n=(t,n)=>{const r=e.test(t),i=e.test(n);return r&&i&&(t=+t,n=+n),t===n?0:r&&!i?-1:i&&!r?1:t<n?-1:1};t.exports={compareIdentifiers:n,rcompareIdentifiers:(t,e)=>n(e,t)}},587:t=>{const e=Object.freeze({loose:!0}),n=Object.freeze({});t.exports=t=>t?"object"!=typeof t?e:t:n},718:(t,e,n)=>{const{MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:i,MAX_LENGTH:s}=n(874),a=n(272),o=(e=t.exports={}).re=[],u=e.safeRe=[],l=e.src=[],c=e.t={};let h=0;const d="[a-zA-Z0-9-]",p=[["\\s",1],["\\d",s],[d,i]],f=(t,e,n)=>{const r=(t=>{for(const[e,n]of p)t=t.split(`${e}*`).join(`${e}{0,${n}}`).split(`${e}+`).join(`${e}{1,${n}}`);return t})(e),i=h++;a(t,i,e),c[t]=i,l[i]=e,o[i]=new RegExp(e,n?"g":void 0),u[i]=new RegExp(r,n?"g":void 0)};f("NUMERICIDENTIFIER","0|[1-9]\\d*"),f("NUMERICIDENTIFIERLOOSE","\\d+"),f("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${d}*`),f("MAINVERSION",`(${l[c.NUMERICIDENTIFIER]})\\.(${l[c.NUMERICIDENTIFIER]})\\.(${l[c.NUMERICIDENTIFIER]})`),f("MAINVERSIONLOOSE",`(${l[c.NUMERICIDENTIFIERLOOSE]})\\.(${l[c.NUMERICIDENTIFIERLOOSE]})\\.(${l[c.NUMERICIDENTIFIERLOOSE]})`),f("PRERELEASEIDENTIFIER",`(?:${l[c.NUMERICIDENTIFIER]}|${l[c.NONNUMERICIDENTIFIER]})`),f("PRERELEASEIDENTIFIERLOOSE",`(?:${l[c.NUMERICIDENTIFIERLOOSE]}|${l[c.NONNUMERICIDENTIFIER]})`),f("PRERELEASE",`(?:-(${l[c.PRERELEASEIDENTIFIER]}(?:\\.${l[c.PRERELEASEIDENTIFIER]})*))`),f("PRERELEASELOOSE",`(?:-?(${l[c.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${l[c.PRERELEASEIDENTIFIERLOOSE]})*))`),f("BUILDIDENTIFIER",`${d}+`),f("BUILD",`(?:\\+(${l[c.BUILDIDENTIFIER]}(?:\\.${l[c.BUILDIDENTIFIER]})*))`),f("FULLPLAIN",`v?${l[c.MAINVERSION]}${l[c.PRERELEASE]}?${l[c.BUILD]}?`),f("FULL",`^${l[c.FULLPLAIN]}$`),f("LOOSEPLAIN",`[v=\\s]*${l[c.MAINVERSIONLOOSE]}${l[c.PRERELEASELOOSE]}?${l[c.BUILD]}?`),f("LOOSE",`^${l[c.LOOSEPLAIN]}$`),f("GTLT","((?:<|>)?=?)"),f("XRANGEIDENTIFIERLOOSE",`${l[c.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),f("XRANGEIDENTIFIER",`${l[c.NUMERICIDENTIFIER]}|x|X|\\*`),f("XRANGEPLAIN",`[v=\\s]*(${l[c.XRANGEIDENTIFIER]})(?:\\.(${l[c.XRANGEIDENTIFIER]})(?:\\.(${l[c.XRANGEIDENTIFIER]})(?:${l[c.PRERELEASE]})?${l[c.BUILD]}?)?)?`),f("XRANGEPLAINLOOSE",`[v=\\s]*(${l[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[c.XRANGEIDENTIFIERLOOSE]})(?:${l[c.PRERELEASELOOSE]})?${l[c.BUILD]}?)?)?`),f("XRANGE",`^${l[c.GTLT]}\\s*${l[c.XRANGEPLAIN]}$`),f("XRANGELOOSE",`^${l[c.GTLT]}\\s*${l[c.XRANGEPLAINLOOSE]}$`),f("COERCEPLAIN",`(^|[^\\d])(\\d{1,${r}})(?:\\.(\\d{1,${r}}))?(?:\\.(\\d{1,${r}}))?`),f("COERCE",`${l[c.COERCEPLAIN]}(?:$|[^\\d])`),f("COERCEFULL",l[c.COERCEPLAIN]+`(?:${l[c.PRERELEASE]})?`+`(?:${l[c.BUILD]})?(?:$|[^\\d])`),f("COERCERTL",l[c.COERCE],!0),f("COERCERTLFULL",l[c.COERCEFULL],!0),f("LONETILDE","(?:~>?)"),f("TILDETRIM",`(\\s*)${l[c.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",f("TILDE",`^${l[c.LONETILDE]}${l[c.XRANGEPLAIN]}$`),f("TILDELOOSE",`^${l[c.LONETILDE]}${l[c.XRANGEPLAINLOOSE]}$`),f("LONECARET","(?:\\^)"),f("CARETTRIM",`(\\s*)${l[c.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",f("CARET",`^${l[c.LONECARET]}${l[c.XRANGEPLAIN]}$`),f("CARETLOOSE",`^${l[c.LONECARET]}${l[c.XRANGEPLAINLOOSE]}$`),f("COMPARATORLOOSE",`^${l[c.GTLT]}\\s*(${l[c.LOOSEPLAIN]})$|^$`),f("COMPARATOR",`^${l[c.GTLT]}\\s*(${l[c.FULLPLAIN]})$|^$`),f("COMPARATORTRIM",`(\\s*)${l[c.GTLT]}\\s*(${l[c.LOOSEPLAIN]}|${l[c.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",f("HYPHENRANGE",`^\\s*(${l[c.XRANGEPLAIN]})\\s+-\\s+(${l[c.XRANGEPLAIN]})\\s*$`),f("HYPHENRANGELOOSE",`^\\s*(${l[c.XRANGEPLAINLOOSE]})\\s+-\\s+(${l[c.XRANGEPLAINLOOSE]})\\s*$`),f("STAR","(<|>)?=?\\s*\\*"),f("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),f("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")},986:(t,e,n)=>{"use strict";n.r(e),n.d(e,{request:()=>Gt,settings:()=>Wt,storage:()=>Vt,type:()=>zt});var r=n(986),i=n(812),s=n(994);const a={async set(t,e){const n={};return n[t]=e,new Promise(((e,r)=>{o(t).set(n,(function(){chrome.runtime.lastError?r(chrome.runtime.lastError):e()}))}))},get:async t=>new Promise(((e,n)=>{o(t).get(t,(function(r){chrome.runtime.lastError?n(chrome.runtime.lastError):e(r[t])}))})),remove:async t=>new Promise(((e,n)=>{o(t).remove(t,(function(){chrome.runtime.lastError?n(chrome.runtime.lastError):e()}))})),list:async(t="local")=>new Promise(((e,n)=>{"local"===t?chrome.storage.local.get(null,(function(t){e(t)})):chrome.storage.sync.get(null,(function(t){e(t)}))})),async addStyle(t){try{const e=document.createElement("style");e.textContent=t,(document.head||document.body||document.documentElement||document).appendChild(e)}catch(t){console.log(`Could not add css:${t}`)}},version:()=>chrome.runtime.getManifest().version,lang(t,e){if(r.settings.get("forceEn")&&"undefined"!=typeof i18n){let n=i18n[t];if(void 0!==e)for(let t=0;t<e.length;t++)n=n.replace(`$${t+1}`,e[t]);return n}return chrome.i18n.getMessage(t,e)},langDirection(){try{const t=chrome.i18n.getUILanguage();if(/^(ar)(-|$)/i.test(t)&&!r.settings.get("forceEn"))return"rtl"}catch(t){i.error(t)}return"ltr"},assetUrl:t=>chrome.runtime.getURL(`assets/${t}`),injectCssResource(t,e){alert("injectCssResource not supported in webextension")},injectjsResource(t,e){const n=document.createElement("script");n.src=chrome.runtime.getURL(`vendor/${t}`),n.onload=function(){this.remove()},e.get(0).appendChild(n)},addProxyScriptToTag:(t,e)=>(t.src=chrome.runtime.getURL(`/content/proxy/proxy_${e}.js`),t),updateDom(t){const e=document.createElement("script");e.text="\n        document.getElementsByTagName('head')[0].onclick = function(e){\n          try{\n            componentHandler.upgradeDom();\n          }catch(e){\n            console.log(e);\n            setTimeout(function(){\n              componentHandler.upgradeDom();\n            },500);\n          }\n        }",e.onload=function(){this.remove()},t.get(0).appendChild(e)},storageOnChanged(t){chrome.storage.onChanged.addListener(t)}};function o(t){return s.syncRegex.test(t)?chrome.storage.sync:chrome.storage.local}const u={async xhr(t,e){if(void 0!==u.sendMessage)return u.sendMessage({name:"xhr",method:t,url:e}).then((t=>{if(429===t.status)throw"Rate limit Timeout";if(0===t.status)throw t.responseText;return t}));throw"Could not send xhr"},sendMessage:async t=>new Promise(((e,n)=>{chrome.runtime.sendMessage(t,(function(t){e(t)}))})),notification(t){this.sendMessage({name:"notification",options:t})},database(t,e){return this.sendMessage({name:"database",options:{call:t,param:e}})}};function l(t,e){const n=new Set(t.split(","));return e?t=>n.has(t.toLowerCase()):t=>n.has(t)}Object.assign;const c=Object.prototype.hasOwnProperty,h=(t,e)=>c.call(t,e),d=Array.isArray,p=t=>"[object Map]"===y(t),f=t=>"symbol"==typeof t,m=t=>null!==t&&"object"==typeof t,g=Object.prototype.toString,y=t=>g.call(t),v=t=>y(t).slice(8,-1),_=t=>"string"==typeof t&&"NaN"!==t&&"-"!==t[0]&&""+parseInt(t,10)===t,b=t=>{const e=Object.create(null);return n=>e[n]||(e[n]=t(n))},w=/-(\w)/g,E=(b((t=>t.replace(w,((t,e)=>e?e.toUpperCase():"")))),/\B([A-Z])/g),I=(b((t=>t.replace(E,"-$1").toLowerCase())),b((t=>t.charAt(0).toUpperCase()+t.slice(1)))),S=(b((t=>t?`on${I(t)}`:"")),(t,e)=>!Object.is(t,e));let k;class T{constructor(t,e,n,r){this.fn=t,this.trigger=e,this.scheduler=n,this.active=!0,this.deps=[],this._dirtyLevel=5,this._trackId=0,this._runnings=0,this._shouldSchedule=!1,this._depsLength=0,function(t,e){e&&e.active&&e.effects.push(t)}(this,r)}get dirty(){if(2===this._dirtyLevel)return!1;if(3===this._dirtyLevel||4===this._dirtyLevel){this._dirtyLevel=1,C();for(let t=0;t<this._depsLength;t++){const e=this.deps[t];if(e.computed){if(2===e.computed.effect._dirtyLevel)return R(),!0;if(e.computed.value,this._dirtyLevel>=5)break}}1===this._dirtyLevel&&(this._dirtyLevel=0),R()}return this._dirtyLevel>=5}set dirty(t){this._dirtyLevel=t?5:0}run(){if(this._dirtyLevel=0,!this.active)return this.fn();let t=P,e=k;try{return P=!0,k=this,this._runnings++,x(this),this.fn()}finally{L(this),this._runnings--,k=e,P=t}}stop(){this.active&&(x(this),L(this),this.onStop&&this.onStop(),this.active=!1)}}function x(t){t._trackId++,t._depsLength=0}function L(t){if(t.deps.length>t._depsLength){for(let e=t._depsLength;e<t.deps.length;e++)O(t.deps[e],t);t.deps.length=t._depsLength}}function O(t,e){const n=t.get(e);void 0!==n&&e._trackId!==n&&(t.delete(e),0===t.size&&t.cleanup())}let P=!0,N=0;const A=[];function C(){A.push(P),P=!1}function R(){const t=A.pop();P=void 0===t||t}function M(){N++}function j(){for(N--;!N&&K.length;)K.shift()()}function D(t,e,n){if(e.get(t)!==t._trackId){e.set(t,t._trackId);const n=t.deps[t._depsLength];n!==e?(n&&O(n,t),t.deps[t._depsLength++]=e):t._depsLength++}}const K=[];function U(t,e,n){M();for(const n of t.keys()){let r;!t.computed&&n.computed&&n._runnings>0&&(null!=r?r:r=t.get(n)===n._trackId)?n._dirtyLevel=2:(n._dirtyLevel<e&&(null!=r?r:r=t.get(n)===n._trackId)&&(n._shouldSchedule||(n._shouldSchedule=0===n._dirtyLevel),n.computed&&2===n._dirtyLevel&&(n._shouldSchedule=!0),n._dirtyLevel=e),n._shouldSchedule&&(null!=r?r:r=t.get(n)===n._trackId)&&(n.trigger(),n._runnings&&!n.allowRecurse||3===n._dirtyLevel||(n._shouldSchedule=!1,n.scheduler&&K.push(n.scheduler))))}j()}const F=(t,e)=>{const n=new Map;return n.cleanup=t,n.computed=e,n},B=new WeakMap,q=Symbol(""),V=Symbol("");function G(t,e,n){if(P&&k){let e=B.get(t);e||B.set(t,e=new Map);let r=e.get(n);r||e.set(n,r=F((()=>e.delete(n)))),D(k,r)}}function W(t,e,n,r,i,s){const a=B.get(t);if(!a)return;let o=[];if("clear"===e)o=[...a.values()];else if("length"===n&&d(t)){const t=Number(r);a.forEach(((e,n)=>{("length"===n||!f(n)&&n>=t)&&o.push(e)}))}else switch(void 0!==n&&o.push(a.get(n)),e){case"add":d(t)?_(n)&&o.push(a.get("length")):(o.push(a.get(q)),p(t)&&o.push(a.get(V)));break;case"delete":d(t)||(o.push(a.get(q)),p(t)&&o.push(a.get(V)));break;case"set":p(t)&&o.push(a.get(q))}M();for(const t of o)t&&U(t,5);j()}const z=l("__proto__,__v_isRef,__isVue"),H=new Set(Object.getOwnPropertyNames(Symbol).filter((t=>"arguments"!==t&&"caller"!==t)).map((t=>Symbol[t])).filter(f)),X=Y();function Y(){const t={};return["includes","indexOf","lastIndexOf"].forEach((e=>{t[e]=function(...t){const n=Nt(this);for(let t=0,e=this.length;t<e;t++)G(n,0,t+"");const r=n[e](...t);return-1===r||!1===r?n[e](...t.map(Nt)):r}})),["push","pop","shift","unshift","splice"].forEach((e=>{t[e]=function(...t){C(),M();const n=Nt(this)[e].apply(this,t);return j(),R(),n}})),t}function J(t){f(t)||(t=String(t));const e=Nt(this);return G(e,0,t),e.hasOwnProperty(t)}class Q{constructor(t=!1,e=!1){this._isReadonly=t,this._isShallow=e}get(t,e,n){const r=this._isReadonly,i=this._isShallow;if("__v_isReactive"===e)return!r;if("__v_isReadonly"===e)return r;if("__v_isShallow"===e)return i;if("__v_raw"===e)return n===(r?i?Tt:kt:i?St:It).get(t)||Object.getPrototypeOf(t)===Object.getPrototypeOf(n)?t:void 0;const s=d(t);if(!r){if(s&&h(X,e))return Reflect.get(X,e,n);if("hasOwnProperty"===e)return J}const a=Reflect.get(t,e,n);return(f(e)?H.has(e):z(e))?a:(r||G(t,0,e),i?a:Dt(a)?s&&_(e)?a:a.value:m(a)?r?$t(a):xt(a):a)}}class Z extends Q{constructor(t=!1){super(!1,t)}set(t,e,n,r){let i=t[e];if(!this._isShallow){const e=Ot(i);if(Pt(n)||Ot(n)||(i=Nt(i),n=Nt(n)),!d(t)&&Dt(i)&&!Dt(n))return!e&&(i.value=n,!0)}const s=d(t)&&_(e)?Number(e)<t.length:h(t,e),a=Reflect.set(t,e,n,r);return t===Nt(r)&&(s?S(n,i)&&W(t,"set",e,n):W(t,"add",e,n)),a}deleteProperty(t,e){const n=h(t,e),r=(t[e],Reflect.deleteProperty(t,e));return r&&n&&W(t,"delete",e,void 0),r}has(t,e){const n=Reflect.has(t,e);return f(e)&&H.has(e)||G(t,0,e),n}ownKeys(t){return G(t,0,d(t)?"length":q),Reflect.ownKeys(t)}}class tt extends Q{constructor(t=!1){super(!0,t)}set(t,e){return!0}deleteProperty(t,e){return!0}}const et=new Z,nt=new tt,rt=t=>t,it=t=>Reflect.getPrototypeOf(t);function st(t,e,n=!1,r=!1){const i=Nt(t=t.__v_raw),s=Nt(e);n||(S(e,s)&&G(i,0,e),G(i,0,s));const{has:a}=it(i),o=r?rt:n?Ct:At;return a.call(i,e)?o(t.get(e)):a.call(i,s)?o(t.get(s)):void(t!==i&&t.get(e))}function at(t,e=!1){const n=this.__v_raw,r=Nt(n),i=Nt(t);return e||(S(t,i)&&G(r,0,t),G(r,0,i)),t===i?n.has(t):n.has(t)||n.has(i)}function ot(t,e=!1){return t=t.__v_raw,!e&&G(Nt(t),0,q),Reflect.get(t,"size",t)}function ut(t){t=Nt(t);const e=Nt(this);return it(e).has.call(e,t)||(e.add(t),W(e,"add",t,t)),this}function lt(t,e){e=Nt(e);const n=Nt(this),{has:r,get:i}=it(n);let s=r.call(n,t);s||(t=Nt(t),s=r.call(n,t));const a=i.call(n,t);return n.set(t,e),s?S(e,a)&&W(n,"set",t,e):W(n,"add",t,e),this}function ct(t){const e=Nt(this),{has:n,get:r}=it(e);let i=n.call(e,t);i||(t=Nt(t),i=n.call(e,t)),r&&r.call(e,t);const s=e.delete(t);return i&&W(e,"delete",t,void 0),s}function ht(){const t=Nt(this),e=0!==t.size,n=t.clear();return e&&W(t,"clear",void 0,void 0),n}function dt(t,e){return function(n,r){const i=this,s=i.__v_raw,a=Nt(s),o=e?rt:t?Ct:At;return!t&&G(a,0,q),s.forEach(((t,e)=>n.call(r,o(t),o(e),i)))}}function pt(t,e,n){return function(...r){const i=this.__v_raw,s=Nt(i),a=p(s),o="entries"===t||t===Symbol.iterator&&a,u="keys"===t&&a,l=i[t](...r),c=n?rt:e?Ct:At;return!e&&G(s,0,u?V:q),{next(){const{value:t,done:e}=l.next();return e?{value:t,done:e}:{value:o?[c(t[0]),c(t[1])]:c(t),done:e}},[Symbol.iterator](){return this}}}}function ft(t){return function(...e){return"delete"!==t&&("clear"===t?void 0:this)}}function mt(){const t={get(t){return st(this,t)},get size(){return ot(this)},has:at,add:ut,set:lt,delete:ct,clear:ht,forEach:dt(!1,!1)},e={get(t){return st(this,t,!1,!0)},get size(){return ot(this)},has:at,add:ut,set:lt,delete:ct,clear:ht,forEach:dt(!1,!0)},n={get(t){return st(this,t,!0)},get size(){return ot(this,!0)},has(t){return at.call(this,t,!0)},add:ft("add"),set:ft("set"),delete:ft("delete"),clear:ft("clear"),forEach:dt(!0,!1)},r={get(t){return st(this,t,!0,!0)},get size(){return ot(this,!0)},has(t){return at.call(this,t,!0)},add:ft("add"),set:ft("set"),delete:ft("delete"),clear:ft("clear"),forEach:dt(!0,!0)};return["keys","values","entries",Symbol.iterator].forEach((i=>{t[i]=pt(i,!1,!1),n[i]=pt(i,!0,!1),e[i]=pt(i,!1,!0),r[i]=pt(i,!0,!0)})),[t,n,e,r]}const[gt,yt,vt,_t]=mt();function bt(t,e){const n=e?t?_t:vt:t?yt:gt;return(e,r,i)=>"__v_isReactive"===r?!t:"__v_isReadonly"===r?t:"__v_raw"===r?e:Reflect.get(h(n,r)&&r in e?n:e,r,i)}const wt={get:bt(!1,!1)},Et={get:bt(!0,!1)},It=new WeakMap,St=new WeakMap,kt=new WeakMap,Tt=new WeakMap;function xt(t){return Ot(t)?t:Lt(t,!1,et,wt,It)}function $t(t){return Lt(t,!0,nt,Et,kt)}function Lt(t,e,n,r,i){if(!m(t))return t;if(t.__v_raw&&(!e||!t.__v_isReactive))return t;const s=i.get(t);if(s)return s;const a=function(t){return t.__v_skip||!Object.isExtensible(t)?0:function(t){switch(t){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}(v(t))}(t);if(0===a)return t;const o=new Proxy(t,2===a?r:n);return i.set(t,o),o}function Ot(t){return!(!t||!t.__v_isReadonly)}function Pt(t){return!(!t||!t.__v_isShallow)}function Nt(t){const e=t&&t.__v_raw;return e?Nt(e):t}const At=t=>m(t)?xt(t):t,Ct=t=>m(t)?$t(t):t;class Rt{constructor(t,e,n,r){this.getter=t,this._setter=e,this.dep=void 0,this.__v_isRef=!0,this.__v_isReadonly=!1,this.effect=new T((()=>t(this._value)),(()=>jt(this,3===this.effect._dirtyLevel?3:4))),this.effect.computed=this,this.effect.active=this._cacheable=!r,this.__v_isReadonly=n}get value(){const t=Nt(this),e=t.effect._dirtyLevel;return t._cacheable&&!t.effect.dirty||!S(t._value,t._value=t.effect.run())||3!==e&&jt(t,5),Mt(t),t.effect._dirtyLevel>=2&&jt(t,3),t._value}set value(t){this._setter(t)}get _dirty(){return this.effect.dirty}set _dirty(t){this.effect.dirty=t}}function Mt(t){var e;P&&k&&(t=Nt(t),D(k,null!=(e=t.dep)?e:t.dep=F((()=>t.dep=void 0),t instanceof Rt?t:void 0)))}function jt(t,e=5,n,r){const i=(t=Nt(t)).dep;i&&U(i,e)}function Dt(t){return!(!t||!0!==t.__v_isRef)}class Kt{constructor(t,e){this.__v_isShallow=e,this.dep=void 0,this.__v_isRef=!0,this._rawValue=e?t:Nt(t),this._value=e?t:At(t)}get value(){return Mt(this),this._value}set value(t){const e=this.__v_isShallow||Pt(t)||Ot(t);t=e?t:Nt(t),S(t,this._rawValue)&&(this._rawValue,this._rawValue=t,this._value=e?t:At(t),jt(this,5))}}var Ut=n(986),Ft=n(812),Bt=n(994);const qt={options:xt({autoTrackingModeanime:"video",readerTracking:!0,askBefore:!0,autoTrackingModemanga:"instant",enablePages:{},forceEn:!1,rpc:!0,presenceLargeImage:"cover",presenceShowButtons:!0,presenceShowMalsync:!1,userscriptModeButton:!1,syncMode:"MAL",syncModeSimkl:"MAL",localSync:!0,delay:0,videoDuration:85,malTags:!1,malContinue:!0,malResume:!0,usedPage:!0,epPredictions:!0,theme:"auto",themeSidebars:!0,themeColor:"#000000",themeOpacity:100,themeImage:"",minimalWindow:!1,posLeft:"left",miniMALonMal:!1,floatButtonStealth:!1,minimizeBigPopup:!1,floatButtonCorrection:!0,floatButtonHide:!1,autoCloseMinimal:!1,outWay:!0,miniMalWidth:"550px",miniMalHeight:"90%",malThumbnail:100,friendScore:!0,loadPTWForProgress:!1,quicklinks:["Aniwave","Crunchyroll","Gogoanime","Mangadex","MangaNato","MangaFox","MangaSee","MangaFire","YugenAnime","HiAnime","Hulu","Netflix","Hidive","VIZ","MangaPlus","MangaReader","ComicK"],quicklinksPosition:"default",autofull:!1,autoresume:!1,autoNextEp:!1,highlightAllEp:!1,checkForFiller:!0,crashReport:!0,introSkip:85,introSkipFwd:[17,39],introSkipBwd:[17,37],nextEpShort:[],correctionShort:[67],syncShort:[],progressInterval:120,progressIntervalDefaultAnime:"en/sub",progressIntervalDefaultManga:"en/sub",progressNotificationsAnime:!0,progressNotificationsManga:!0,notificationsSticky:!0,bookMarksList:!1,customDomains:[],anilistUpdateUi:!0,anilistToken:"",anilistOptions:{displayAdultContent:!0,scoreFormat:"POINT_10"},kitsuToken:"",kitsuOptions:{titleLanguagePreference:"canonical",sfwFilter:!1,ratingSystem:"regular"},simklToken:"",malToken:"",malRefresh:"",shikiToken:"",shikiOptions:{locale:"ru"}}),debounceArray:{},isInit:function(t){return n=!1,Dt(e=t)?e:new Kt(e,n);var e,n}(!1),async init(){const t=[];for(const e in this.options){const n=await Ut.storage.get(`settings/${e}`);void 0!==n&&(this.options[e]=n,t[e]=/(token|refresh)/i.test(e)&&n?"********":n)}let e;return Ft.log("Settings",t),Ut.storage.storageOnChanged(((t,n)=>{if("sync"===n)for(const e in t){const n=t[e];/^settings\//i.test(e)&&(this.options[e.replace("settings/","")]=n.newValue,Ft.info(`Update ${e} option to ${JSON.stringify(n.newValue,null,2)}`))}if("local"===n&&t.rateLimit)try{clearTimeout(e),t.rateLimit.newValue?(Ft.log("Rate limited"),$(".type-rate").length||Bt.flashm("Rate limited. Retrying in a moment",{error:!0,type:"rate",permanent:!0})):e=setTimeout((()=>{Ft.log("No Rate limited"),$(".type-rate").remove()}),5e3)}catch(t){Ft.error(t)}})),this.isInit.value=!0,this},get(t){if(!this.isInit.value)throw"Settings not initialized";return this.options[t]},set(t,e){if(!Object.prototype.hasOwnProperty.call(this.options,t)){const e=Error(`${t} is not a defined option`);throw Ft.error(e),e}return this.options[t]=e,Ut.storage.set(`settings/${t}`,e)},setDebounce(t,e){this.options[t]=e,clearTimeout(this.debounceArray[t]),this.debounceArray[t]=setTimeout((()=>{this.set(t,e),delete this.debounceArray[t]}),1e3)},async getAsync(t){const e=await Ut.storage.get(`settings/${t}`);return void 0===e&&void 0!==this.options[t]?this.options[t]:e}},Vt=a,Gt=u,Wt=qt,zt="webextension"},812:(t,e,n)=>{"use strict";n.r(e),n.d(e,{debug:()=>a,error:()=>i,info:()=>s,log:()=>r,m:()=>o});const r=Function.prototype.bind.call(console.log,console,"%cMAL-Sync-BG","background-color: #2e51a2; color: white; padding: 2px 10px; border-radius: 3px;"),i=Function.prototype.bind.call(console.error,console,"%cMAL-Sync-BG","background-color: #8f0000; color: white; padding: 2px 10px; border-radius: 3px;"),s=Function.prototype.bind.call(console.info,console,"%cMAL-Sync-BG","background-color: wheat; color: black; padding: 2px 10px; border-radius: 3px;"),a=Function.prototype.bind.call(console.debug,console,"%cMAL-Sync-BG","background-color: steelblue; color: black; padding: 2px 10px; border-radius: 3px;"),o=(t,e="",n=[])=>{let r="white";e||(e=function(t){if(!t)return"#ffffff";t=String(t);let e=0;for(let n=0;n<t.length;n++)e=t.charCodeAt(n)+((e<<5)-e);let n="#";for(let t=0;t<3;t++)n+=`00${(e>>8*t&255).toString(16)}`.substr(-2);return n}(t)),"#"===e[0]&&(r=parseInt(e.replace("#",""),16)>8388607.5?"#000":"#fff");const i=`background-color: ${e}; color: ${r}; padding: 2px 10px; border-radius: 3px; margin-left: -5px; border-left: 1px solid white;`;n.push({name:t,style:i});const s={m:(t,e="")=>o(t,e,[...n])},a=n.reduce(((t,e)=>`${t}%c${e.name}`),""),u=n.map((t=>t.style));return s.log=Function.prototype.bind.call(console.log,console,`%cMB ${a}`,"background-color: #2e51a2; color: white; padding: 2px 10px; border-radius: 3px;",...u),s.error=Function.prototype.bind.call(console.error,console,`%cMB ${a}`,"background-color: #8f0000; color: white; padding: 2px 10px; border-radius: 3px;",...u),s.info=Function.prototype.bind.call(console.info,console,`%cMB ${a}`,"background-color: wheat; color: black; padding: 2px 10px; border-radius: 3px;",...u),s.debug=Function.prototype.bind.call(console.debug,console,`%cMB ${a}`,"background-color: steelblue; color: black; padding: 2px 10px; border-radius: 3px;",...u),s}},994:(t,e,n)=>{"use strict";n.r(e),n.d(e,{absoluteLink:()=>v,canHideTabs:()=>U,changeDetect:()=>E,checkDoubleExecution:()=>T,clearCache:()=>rt,elementInViewport:()=>Y,episode:()=>p,favicon:()=>c,flashConfirm:()=>W,flashm:()=>G,fullUrlChangeDetect:()=>w,getAsyncWaitUntilTrue:()=>S,getBaseText:()=>l,getContinueWaching:()=>A,getEntrySettings:()=>R,getResumeWaching:()=>P,getStatusText:()=>B,getTooltip:()=>D,getUrlFromTags:()=>x,getselect:()=>y,handleMalImages:()=>M,htmlDecode:()=>tt,isDomainMatching:()=>st,isFirefox:()=>et,lazyload:()=>X,notifications:()=>q,pageUrl:()=>Q,parseHtml:()=>_,planTo:()=>d,rateLimitExclude:()=>m,returnYYYYMMDD:()=>Z,setContinueWaching:()=>N,setEntrySettings:()=>C,setResumeWaching:()=>O,setUrlInTags:()=>L,sortAlphabetically:()=>it,status:()=>g,statusTag:()=>F,syncRegex:()=>f,timeCache:()=>V,timeDiffToText:()=>K,upperCaseFirstLetter:()=>at,urlChangeDetect:()=>b,urlParam:()=>u,urlPart:()=>a,urlStrip:()=>o,wait:()=>J,waitForPageToBeVisible:()=>nt,waitUntilTrue:()=>I,watching:()=>h});var r=n(986),i=n(812),s=n(994);function a(t,e){if(!t)return"";const n=t.split("/");return n[e]?n[e].replace(/[#?].*/,""):""}function o(t){return t.replace(/[#?].*/,"")}function u(t,e){const n=new RegExp(`[?&]${e}=([^&#]*)`).exec(t);return null===n?null:decodeURI(n[1])||0}function l(t){let e=t.text();return t.children().each((function(){e=e.replace(j.$(this).text(),"")})),e}function c(t){if(!t)return"";const e=t.match(/^(https?:\/\/)?[^/]+/);return e&&(t=e[0]),`https://favicon.malsync.moe/?domain=${t}`}function h(t){return"manga"===t?"Reading":"Watching"}function d(t){return"manga"===t?"Plan to Read":"Plan to Watch"}function p(t){return"manga"===t?r.storage.lang("UI_Chapter"):r.storage.lang("UI_Episode")}const f=/(^settings\/.*|^updateCheckTime$|^tempVersion$|^local:\/\/|^list-tagSettings$)/,m=/^https:\/\/api.malsync.moe\/(shark|mal\/|nc\/mal\/.*\/progress$)/i;var g;function y(t,e){let n=t.split(`name="${e}"`)[1].split("</select>")[0];if(n.indexOf('selected="selected"')>-1){n=n.split("<option");for(let t=0;t<n.length;++t)if(n[t].indexOf('selected="selected"')>-1)return n[t].split('value="')[1].split('"')[0]}return""}function v(t,e){return void 0===t||t.startsWith("http")||("/"!==t.charAt(0)&&(t=`/${t}`),t=e+t),t}function _(t){return(new DOMParser).parseFromString(`<!doctype html><body>${t}`,"text/html").body.textContent}function b(t){let e=window.location.href;return setInterval((function(){e!==window.location.href&&(e=window.location.href,t())}),100)}function w(t,e=!1){let n="";const r=setInterval((function(){const r=e?o(window.location.href):window.location.href;n!==r&&(n=r,t())}),100);return Number(r)}function E(t,e,n=!1){let r=e();const i=setInterval((function(){const n=e();void 0!==n&&r!==n&&(r=e(),t())}),500);return n&&t(),Number(i)}function I(t,e,n=100){const r=setInterval((function(){t()&&(clearInterval(r),e())}),n);return r}function S(t,e=100){let n,r;const i=()=>{clearTimeout(n),r&&r("AsyncWait stopped")};return{asyncWaitUntilTrue:()=>(i(),new Promise(((i,s)=>{r=s,n=I(t,(()=>i()),e)}))),reset:i}}!function(t){t[t.watching=1]="watching",t[t.completed=2]="completed",t[t.onhold=3]="onhold",t[t.dropped=4]="dropped",t[t.planToWatch=6]="planToWatch"}(g||(g={}));const k=Math.random();function T(){$(".mal-sync-double-detect").length&&$(".mal-sync-double-detect").each((function(t){$(this).text()!==k.toString()&&alert("Double execution detected! Please run MAL-Sync once only.")})),$("body").after(j.html(`<div class="mal-sync-double-detect" style="display: none;">${k.toString()}</div>`))}function x(t){return/malSync::[\d\D]+::/.test(t)?e(t.split("malSync::")[1].split("::")[0]):/last::[\d\D]+::/.test(t)?e(t.split("last::")[1].split("::")[0]):void 0;function e(t){try{return atob(t)}catch(e){return t}}}function L(t,e){if(""===t)return e.replace(/,?(malSync|last)::[^ \n]+?::/,"");if(!r.settings.get("malTags"))return e;const n=`malSync::${btoa(t)}::`;return/(last|malSync)::[\d\D]+::/.test(e)?e.replace(/(last|malSync)::[^^]*?::/,n):`${e},${n}`}async function O(t,e,n,i){return r.storage.set(`resume/${n}/${i}`,{url:t,ep:e})}async function P(t,e){if(r.settings.get("malResume"))return r.storage.get(`resume/${t}/${e}`)}async function N(t,e,n,i){return r.storage.set(`continue/${n}/${i}`,{url:t,ep:e})}async function A(t,e){if(r.settings.get("malContinue"))return r.storage.get(`continue/${t}/${e}`)}async function C(t,e,n,i=""){const s={};if(n){for(const t in n)switch(t){case"u":case"p":s[t]=n[t]}r.settings.get("malTags")?i=L(JSON.stringify(s),i):await r.storage.set(`tagSettings/${t}/${e}`,JSON.stringify(s))}return Object.values(s).find((t=>Boolean(t)))||(i=L("",i),r.settings.get("malTags")||await r.storage.remove(`tagSettings/${t}/${e}`)),i}async function R(t,e,n=""){const s={u:null,c:null,r:null,p:""};if(r.settings.get("malTags")){const t=x(n);if(t)if("{"===t[0])try{const e=JSON.parse(t);for(const t in s)e[t]&&(s[t]=e[t])}catch(t){i.error(t)}else s.u=t}else{let n=await r.storage.get(`tagSettings/${t}/${e}`);if(n){n=JSON.parse(n);for(const t in s)n[t]&&(s[t]=n[t])}}const a=await A(t,e);a&&(s.c=a);const o=await P(t,e);return o&&(s.r=o),r.settings.get("usedPage")||(s.u=null),s}function M(t){return-1!==t.indexOf("questionmark")?r.storage.assetUrl("questionmark.gif"):t}function D(t,e="",n="top"){const r=Math.floor(1e3*Math.random()+1);return`<div id="tt${r}" class="icon material-icons" style="font-size:16px; line-height: 0; color: #7f7f7f; padding-bottom: 20px; padding-left: 3px; ${e}">contact_support</div>  <div class="mdl-tooltip mdl-tooltip--${n} mdl-tooltip--large" for="tt${r}">${t}</div>`}function K(t){let e="";t/=1e3;const n=Math.floor(t/31536e3);t-=31536e3*n,n&&(e+=`${n}y `);const r=Math.floor(t/86400);t-=86400*r,r&&(e+=`${r}d `);const i=Math.floor(t/3600)%24;t-=3600*i,i&&r<2&&(e+=`${i}h `);const s=Math.floor(t/60)%60;return t-=60*s,s&&!r&&i<3&&(e+=`${s}min `),e}function U(){return"undefined"!=typeof browser&&void 0!==browser.tabs.hide}function F(t,e,n){const i={anime:{1:{class:"watching",text:"CW",title:r.storage.lang(`UI_Status_watching_${e}`)},2:{class:"completed",text:"CMPL",title:r.storage.lang("UI_Status_Completed")},3:{class:"on-hold",text:"HOLD",title:r.storage.lang("UI_Status_OnHold")},4:{class:"dropped",text:"DROP",title:r.storage.lang("UI_Status_Dropped")},6:{class:"plantowatch",text:"PTW",title:r.storage.lang(`UI_Status_planTo_${e}`)},23:{class:"rewatching",text:"RE",title:r.storage.lang(`UI_Status_Rewatching_${e}`)}},manga:{1:{class:"reading",text:"CR",title:r.storage.lang(`UI_Status_watching_${e}`)},2:{class:"completed",text:"CMPL",title:r.storage.lang("UI_Status_Completed")},3:{class:"on-hold",text:"HOLD",title:r.storage.lang("UI_Status_OnHold")},4:{class:"dropped",text:"DROP",title:r.storage.lang("UI_Status_Dropped")},6:{class:"plantoread",text:"PTR",title:r.storage.lang(`UI_Status_planTo_${e}`)},23:{class:"rewatching",text:"RE",title:r.storage.lang(`UI_Status_Rewatching_${e}`)}}};if($.each([1,2,3,4,6,23],(function(t,e){i.anime[i.anime[e].title]=i.anime[e],i.manga[i.manga[e].title]=i.manga[e]})),t&&i[e][t]){const r=i[e][t];return` <a href="https://myanimelist.net/ownlist/${e}/${n}/edit?hideLayout=1" title="${r.title}" class="Lightbox_AddEdit button_edit ${r.class}">${r.text}</a>`}return!1}function B(t,e){switch(e){case 1:return r.storage.lang(`UI_Status_watching_${t}`);case 2:return r.storage.lang("UI_Status_Completed");case 3:return r.storage.lang("UI_Status_OnHold");case 4:return r.storage.lang("UI_Status_Dropped");case 6:return r.storage.lang(`UI_Status_planTo_${t}`);case 7:return r.storage.lang("UI_Status_All");case 23:return r.storage.lang(`UI_Status_Rewatching_${t}`);default:return""}}function q(t,e,n,s=""){const a={type:"basic",title:e,message:n,iconUrl:s};i.log("Notification",t,a),r.storage.get("notificationHistory").then((e=>{void 0===e&&(e=[]),"object"==typeof e&&(e.length>=10&&e.shift(),e.push({url:t,title:a.title,message:a.message,iconUrl:a.iconUrl,timestamp:Date.now()}),r.storage.set("notificationHistory",e))}));try{return chrome.notifications.create(t,a)}catch(t){i.error(t)}}async function V(t,e,n){const i=await r.storage.get(t);if("object"==typeof i&&(new Date).getTime()<i.timestamp)return i.data;const s=await e();return r.storage.set(t,{data:s,timestamp:(new Date).getTime()+n}).then((()=>s))}function G(t,e){j.$("#flash-div-top").length||function(){r.storage.addStyle('.flashinfo{\n                    transition: max-height 2s, opacity 2s 2s;\n                 }\n                 .mini-stealth .flashinfo{\n                    opacity: 0;\n                 }\n                  #flashinfo-div.hover.mini-stealth .flashinfo.type-update{\n                    opacity: 0.7;\n                 }\n                 #flashinfo-div.hover .flashinfo{\n                    opacity: 1;\n                 }\n                 .flashinfo:hover{\n                    max-height:5000px !important;\n                    z-index: 2147483647;\n                    opacity: 1;\n                    transition: max-height 2s;\n                 }\n                 .flashinfo .synopsis{\n                    transition: max-height 2s, max-width 2s ease 2s;\n                 }\n                 .flashinfo:hover .synopsis{\n                    max-height:9999px !important;\n                    max-width: 500px !important;\n                    transition: max-height 2s;\n                 }\n                 #flashinfo-div{\n                  z-index: 2;\n                  transition: 2s;\n                 }\n                 #flashinfo-div:hover, #flashinfo-div.hover{\n                  z-index: 2147483647;\n                 }\n                 #flashinfo-div.player-error {\n                   z-index: 2147483647;\n                 }\n                 #flashinfo-div.player-error .type-update{\n                  overflow: visible !important;\n                  opacity: 1 !important;\n                 }\n                 #flashinfo-div.player-error .player-error{\n                  display: block !important\n                 }\n                 #flashinfo-div.player-error-missing-permissions .player-error-missing-permissions{\n                  display: block !important\n                 }\n                 #flashinfo-div.player-error-missing-permissions .player-error-default{\n                  display: none !important\n                 }\n\n                 #flash-div-top, #flash-div-bottom, #flashinfo-div{\n                    font-family: "Helvetica","Arial",sans-serif;\n                    color: white;\n                    font-size: 14px;\n                    font-weight: 400;\n                    line-height: 17px;\n                 }\n                 #flash-div-top h2, #flash-div-bottom h2, #flashinfo-div h2{\n                    font-family: "Helvetica","Arial",sans-serif;\n                    color: white;\n                    font-size: 14px;\n                    font-weight: 700;\n                    line-height: 17px;\n                    padding: 0;\n                    margin: 0;\n                 }\n                 #flash-div-top a, #flash-div-bottom a, #flashinfo-div a{\n                    color: #DF6300;\n                 }');let t="";r.settings.get("floatButtonStealth")&&(t="mini-stealth"),j.$("body").after(j.html(`<div id="flash-div-top" dir="${r.storage.langDirection()}" style="text-align: center;pointer-events: none;position: fixed;top:-5px;width:100%;z-index: 2147483647;left: 0;"></div>        <div id="flash-div-bottom" dir="${r.storage.langDirection()}" style="text-align: center;pointer-events: none;position: fixed;bottom:0px;width:100%;z-index: 2147483647;left: 0;"><div id="flash" style="display:none;  background-color: red;padding: 20px; margin: 0 auto;max-width: 60%;          -webkit-border-radius: 20px;-moz-border-radius: 20px;border-radius: 20px;background:rgba(227,0,0,0.6);"></div></div>        <div id="flashinfo-div" dir="${r.storage.langDirection()}" class="${t}" style="text-align: center;pointer-events: none;position: fixed;bottom:0px;width:100%;left: 0;">`))}(),i.log("[Flash] Message:",t);let n="#323232";void 0!==e&&void 0!==e.error&&e.error&&(n="#3e0808");let s="#flash-div-bottom";void 0!==e&&void 0!==e.position&&e.position&&(s=`#flash-div-${e.position}`);let a="flash";if(void 0!==e&&void 0!==e.type&&e.type){const t=`type-${e.type}`;j.$(`${s} .${t}, #flashinfo-div .${t}`).removeClass(t).fadeOut({duration:1e3,queue:!1,complete(){j.$(this).remove()}}),a+=` ${t}`}let o,u=`<div class="${a}" style="display:none;">        <div style="display:table; pointer-events: all; padding: 14px 24px 14px 24px; margin: 0 auto; margin-top: 5px; max-width: 60%; -webkit-border-radius: 20px;-moz-border-radius: 20px;border-radius: 2px;color: white;background:${n}; ">          ${t}        </div>      </div>`;return void 0!==e&&void 0!==e.hoverInfo&&e.hoverInfo?(a+=" flashinfo",u=`<div class="${a}" style="display:none; max-height: 5000px; overflow: hidden;"><div style="display:table; pointer-events: all; margin: 0 auto; margin-top: -2px; max-width: 60%; -webkit-border-radius: 20px;-moz-border-radius: 20px;border-radius: 2px;color: white;background:${n}; position: relative;"><div style="max-height: 60vh; overflow-y: auto; padding: 14px 24px 14px 24px;">${t}</div></div></div>`,j.$("#flashinfo-div").addClass("hover"),o=j.$(j.html(u)).appendTo("#flashinfo-div"),void 0!==e&&void 0!==e.minimized&&e.minimized&&o.css("max-height","8px")):o=j.$(j.html(u)).appendTo(s),void 0!==e&&void 0!==e.permanent&&e.permanent?o.slideDown(800):void 0!==e&&void 0!==e.hoverInfo&&e.hoverInfo?o.slideDown(800).delay(4e3).queue((function(){j.$("#flashinfo-div").removeClass("hover"),o.css("max-height","8px")})):o.slideDown(800).delay(4e3).slideUp(800,(()=>{j.$(this).remove()})),o}async function W(t,e,n=(()=>{}),i=(()=>{}),s=!1){return new Promise((function(a,o){let u=r.storage.lang("Ok"),l=r.storage.lang("Cancel");s&&(u=r.storage.lang("Yes"),l=r.storage.lang("No"));const c=G(t=`<div style="text-align: center;">${t}</div><div style="display: flex; justify-content: space-around;"><button class="Yes" style="background-color: transparent; border: none; color: rgb(255,64,129);margin-top: 10px; cursor:pointer;">${u}</button><button class="Cancel" style="background-color: transparent; border: none; color: rgb(255,64,129);margin-top: 10px; cursor:pointer;">${l}</button></div>`,{permanent:!0,position:"top",type:e});c.find(".Yes").click((function(t){a(!0),j.$(t.target).parentsUntil(".flash").fadeOut(300,(function(){j.$(this).remove()})),n()})),c.find(".Cancel").click((function(t){a(!1),j.$(t.target).parentsUntil(".flash").fadeOut(300,(function(){j.$(this).remove()})),i()}))}))}let z=!1,H=[];function X(t,e=".mdl-layout__content"){function n(t,e){if(!j.$(t).is(":visible"))return!1;if(j.$(t).hasClass("lazyBack"))j.$(t).css("background-image",`url(${t.getAttribute("data-src")})`).removeClass("lazyBack");else{const n=new Image,r=t.getAttribute("data-src");n.onload=function(){t.parent?t.parent.replaceChild(n,t):t.src=r,e&&e()},n.src=r}}for(let t=0;t<H.length;t++)$(H[t]).addClass("init");H=[];const r=t.find("img.lazy.init, .lazyBack.init"),i=function(){for(let t=0;t<H.length;t++)s.elementInViewport(H[t],600)&&n(H[t],(function(){H.splice(t,t)})),$(H[t]).length||H.splice(t,t)};for(let t=0;t<r.length;t++)H.push(r[t]),$(r[t]).removeClass("init");i(),z||(z=!0,t.find(e).scroll((function(){i()})))}function Y(t,e=0){const n=t.getBoundingClientRect();return n.top>=0&&n.left>=0&&n.top-e<=(window.innerHeight||document.documentElement.clientHeight)}function J(t){return new Promise((e=>{setTimeout(e,t)}))}function Q(t,e,n){switch(t){case"mal":return`https://myanimelist.net/${e}/${n}`;case"anilist":return`https://anilist.co/${e}/${n}`;case"kitsu":return`https://kitsu.app/${e}/${n}`;case"simkl":return`https://simkl.com/${e}/${n}`;default:throw`${t} not a valid page`}}function Z(t=0){const e=new Date;e.setDate(e.getDate()+t);const n=e.getMonth()<9?`0${e.getMonth()+1}`:e.getMonth()+1,r=e.getDate()<10?`0${e.getDate()}`:e.getDate();return`${e.getFullYear()}-${n}-${r}`}function tt(t){return $("<textarea/>").html(j.html(t)).text()}function et(){return Boolean("undefined"!=typeof browser&&"undefined"!=typeof chrome)}function nt(){const t=()=>Boolean(!document.visibilityState||"visible"===document.visibilityState);if(t())return Promise.resolve();i.log("Page in background");const{asyncWaitUntilTrue:e}=S((()=>t()));return e().then((()=>{i.log("Page is visible")}))}async function rt(){const t=await r.storage.list();let e=0;j.$.each(t,(function(t,n){s.syncRegex.test(String(t))||/(^tagSettings\/.*)/.test(String(t))||(r.storage.remove(String(t)),e++)})),s.flashm(`Cache Cleared [${e}]`)}function it(t,e){return t.toLowerCase()<e.toLowerCase()?-1:t.toLowerCase()>e.toLowerCase()?1:0}function st(t,e){const n=new URL(t),{host:r}=n;return r===e||r.endsWith(`.${e}`)}function at(t){return!t||t.length<2?t:t.charAt(0).toUpperCase()+t.slice(1)}}},e={};function n(r){var i=e[r];if(void 0!==i)return i.exports;var s=e[r]={exports:{}};return t[r].call(s.exports,s,s.exports,n),s.exports}n.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return n.d(e,{a:e}),e},n.d=(t,e)=>{for(var r in e)n.o(e,r)&&!n.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{"use strict";var t=n(744);const e=Symbol.for("Dexie"),r=globalThis[e]||(globalThis[e]=t);if(t.semVer!==r.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${t.semVer} and ${r.semVer}`);const{liveQuery:i,mergeRanges:s,rangesOverlap:a,RangeSet:o,cmp:u,Entity:l,PropModSymbol:c,PropModification:h,replacePrefix:d,add:p,remove:f}=r,m=r;var g=n(11),y=n(812),v=n(986);const _=Math.floor(1e9*Math.random()),b=new g.EventEmitter2({wildcard:!0});function w(t,...e){y.m("Global").m("Emit").debug(t,...e),b.emit(`${t}`,...e),void 0!==v&&v&&"webextension"===v.type&&chrome.runtime.sendMessage({name:"emitter",item:{event:t,params:e,id:_}})}void 0!==v&&v&&"webextension"===v.type&&chrome.runtime.onMessage.addListener(((t,e,n)=>{t.name&&"emitter"===t.name&&(y.m("Global").m("Event").debug(t.item.id,t.item.event,t.item.params),t.item.id!==_&&b.emit(t.item.event,...t.item.params))}));var E=n(986);function I(t=""){const e=E.settings.get("syncMode");return"SIMKL"!==e||"manga"!==t&&-1===t.indexOf("/manga/")?e:E.settings.get("syncModeSimkl")}var S=n(812);let k;if(function(){try{return localStorage.getItem("x"),!0}catch(t){return S.info("Local storage is not available",t),!1}}())k=localStorage;else{let t={};k={getItem:e=>e in t?t[e]:null,setItem(e,n){t[e]=n},removeItem(e){e in t&&delete t[e]},clear(){t={}}}}const T=k;var x=n(986);class ${constructor(t,e,n=!0,r=0){return this.key=t,this.ttl=e,this.localStorage=n,this.refetchTtl=r,this}containsValue(t){return null!=t}valueValid(t,e){return!(!t||!t.timestamp)&&(new Date).getTime()<t.timestamp+e}ttlValid(t){return this.valueValid(t,this.ttl)}refetchTtlValid(t){return this.valueValid(t,this.refetchTtl)}async hasValue(){const t=await this.getStorage();return!(!this.containsValue(t)||!this.ttlValid(t))}async hasValueAndIsNotEmpty(){const t=await this.getStorage();return!!(this.containsValue(t)&&void 0!==t.data&&null!==t.data&&Object.keys(t.data).length&&this.ttlValid(t))}async fullState(){const t=await this.getStorage(),e=this.containsValue(t)&&this.refetchTtlValid(t),n=this.ttlValid(t);return{value:t,hasValue:e,isValid:n,refetch:e&&!n}}async getValue(){return(await this.getStorage()).data}async setValue(t){const e={data:t,timestamp:(new Date).getTime()};return this.localStorage?T.setItem(this.key,JSON.stringify(e)):x.storage.set(this.key,e)}async clearValue(){return this.localStorage?T.removeItem(this.key):x.storage.remove(this.key)}async getStorage(){return this.localStorage?JSON.parse(T.getItem(this.key)):x.storage.get(this.key)}}var L=n(986),O=n(994),P=n(812);async function N(t,e){if(!e)return{};const n=await L.request.xhr("GET",`https://api.malsync.moe/nc/mal/${t}/${e}/pr`);return JSON.parse(n.responseText)}function A(t,e,n){const r={};if(!t.length)return null;let i;if("default"===e?(r.mainId="anime"===n?L.settings.get("progressIntervalDefaultAnime"):L.settings.get("progressIntervalDefaultManga"),r.fallback="en/sub"):r.mainId=e,r.fallbackPrediction="jp/dub",r.mainId){const e=t.find((t=>t.id===r.mainId));e&&(i=e)}if(r.fallback&&!i){const e=t.find((t=>t.id===r.fallback));e&&(i=e)}if(r.fallbackPrediction&&i&&!i.predicition&&i.lastEp&&i.lastEp.timestamp){const e=t.find((t=>t.id===r.fallbackPrediction)),n=i.lastEp.timestamp+6048e5;n&&e&&e.predicition&&(i.lastEp.total===e.lastEp.total?Math.abs(n-e.predicition.timestamp)<108e6&&(i.predicition={timestamp:n,probability:"medium"}):e.lastEp.total&&i.lastEp.total===e.lastEp.total-1&&Math.abs(n-(e.predicition.timestamp-6048e5))<108e6&&(i.predicition={timestamp:n,probability:"medium"}))}if(r.fallbackPrediction&&!i){const e=t.find((t=>t.id===r.fallbackPrediction));e&&e.lastEp&&e.predicition&&0===e.lastEp.total&&(i=e,i.predicition.probability="medium")}return i||null}async function C(t,e,n,r){try{if("anime"===r&&!L.settings.get("progressNotificationsAnime")||"manga"===r&&!L.settings.get("progressNotificationsManga"))return;if(t&&n&&n&&e.lastEp&&void 0!==e.lastEp.total&&n.lastEp&&n.lastEp.total&&e.lang===n.lang&&e.type===n.type&&e.lastEp.total<n.lastEp.total&&t.watchedEp+1===n.lastEp.total){let e;e=t.single?{title:t.title,text:L.storage.lang(`syncPage_malObj_nextEp_${r}`,[n.lastEp.total]),sticky:L.settings.get("notificationsSticky"),image:await t.single.getImage(),url:t.single.getStreamingUrl()?t.single.getStreamingUrl():t.single.getUrl()}:{title:t.title,text:L.storage.lang(`syncPage_malObj_nextEp_${r}`,[n.lastEp.total]),sticky:L.settings.get("notificationsSticky"),image:t.image,url:t.options&&t.options.u?t.options.u:t.url},L.request.notification(e)}}catch(t){P.error("Could not check notification Progress",t)}}var R=n(986);function M(t,e=!0){if(!t)return"";const n=Date.now();let r,i;if(n>t?(i=!1,r=n-t):(i=!0,r=t-n),r<3e4)return R.storage.lang("bookmarksItem_now");let s=function(t){let e="";return 1===t.y?e+=` ${t.y} ${R.storage.lang("bookmarksItem_Year")}`:t.y>1&&(e+=` ${t.y} ${R.storage.lang("bookmarksItem_Years")}`),1===t.d?e+=` ${t.d} ${R.storage.lang("bookmarksItem_Day")}`:t.d>1&&(e+=` ${t.d} ${R.storage.lang("bookmarksItem_Days")}`),1===t.h?e+=` ${t.h} ${R.storage.lang("bookmarksItem_Hour")}`:t.h>1&&(e+=` ${t.h} ${R.storage.lang("bookmarksItem_Hours")}`),1===t.m?e+=` ${t.m} ${R.storage.lang("bookmarksItem_min")}`:t.m>1&&(e+=` ${t.m} ${R.storage.lang("bookmarksItem_mins")}`),1===t.s?e+=` ${t.s} ${R.storage.lang("bookmarksItem_sec")}`:t.s>1&&(e+=` ${t.s} ${R.storage.lang("bookmarksItem_secs")}`),e.trim()}((a=function(t){let e,n,r,i;i=Math.floor(t/1e3),r=Math.floor(i/60),i%=60,n=Math.floor(r/60),r%=60,e=Math.floor(n/24),n%=24;const s=Math.floor(e/365);return e%=365,{y:s,d:e,h:n,m:r,s:i}}(r)).y>1?a.d>182?{y:a.y+1,d:0,h:0,m:0,s:0}:{y:a.y,d:0,h:0,m:0,s:0}:a.y?{y:a.y,d:a.d,h:0,m:0,s:0}:a.d>3?a.h>11?{y:0,d:a.d+1,h:0,m:0,s:0}:{y:0,d:a.d,h:0,m:0,s:0}:a.d?{y:0,d:a.d,h:a.h,m:0,s:0}:a.h>5?a.m>29?{y:0,d:0,h:a.h+1,m:0,s:0}:{y:0,d:0,h:a.h,m:0,s:0}:a.h?{y:0,d:0,h:a.h,m:a.m,s:0}:a.m>14?{y:0,d:0,h:0,m:a.m,s:0}:{y:0,d:0,h:0,m:a.m,s:a.s});var a;return!i&&e&&(s=R.storage.lang("bookmarksItem_ago",[s])),s}var D=n(812),K=n(986);class U{constructor(t,e){return this.cacheKey=t,this.type=e,this.releaseItem=void 0,this.logger=D.m("progress").m(t.toString()),this}async initReleaseProgress(t){t&&await async function(t,e,n="default",r=P.m("release")){if(n||(n="default"),(r=r.m(t.uid.toString())).log(t.title,t.cacheKey,t.apiCacheKey,`Mode: ${n}`),!t.apiCacheKey)return void r.log("No Api Cache Id");if(!L.settings.get("epPredictions"))return void r.log("epPredictions disabled");const i=await L.storage.get(`release/${e}/${t.cacheKey}`);r.m("Load").log(i);let s,a=!1;if(i&&i.mode&&i.mode!==n&&(a=!0),i&&i.timestamp&&Date.now()-i.timestamp<12e4&&!a)return void r.log("Up to date");if(i&&i.finished&&i.timestamp&&Date.now()-i.timestamp<6048e5&&!a)return void r.log("Fininshed");if(i&&!i.value&&i.timestamp&&Date.now()-i.timestamp<864e5&&!a)return void r.log("Nulled");a&&r.log("Update forced"),"off"===n&&(r.log("Disabled"),t.xhr=[]),void 0!==t.xhr?s=t.xhr:(s=await N(e,t.apiCacheKey),await O.wait(500)),r.log(s);const o=A(s,n,e);o||r.log("No value for the selected mode");let u=!1;o&&o.state&&"complete"===o.state&&(u=!0),r.m("Save").log(o),i&&i.value&&C(t,i.value,o,e),await L.storage.set(`release/${e}/${t.cacheKey}`,{timestamp:Date.now(),value:o,mode:n,finished:u})}(t,this.type,t.progressMode);const e=await K.storage.get(`release/${this.type}/${this.cacheKey}`);this.logger.m("Init Release").log(e),e&&(function(t){if(t&&t.timestamp){const e=(new Date).getTime()-t.timestamp;if(t.finished&&e<6048e5)return!1;if(!t.value&&e<864e5)return!1;if(e<864e5)return!1}return!0}(e)?this.logger.log("Too old"):this.releaseItem=e)}getProgressCurrentEpisode(){const t=this.releaseItem;return t&&t.value&&t.value.lastEp&&t.value.lastEp.total?t.value.lastEp.total:null}isProgressFinished(){const t=this.releaseItem;return!(!t||!t.finished)}getProgressPrediction(){const t=this.releaseItem;return t&&t.value&&t.value.predicition&&t.value.predicition.timestamp?t.value.predicition.timestamp:null}getProgressLastTimestamp(){const t=this.releaseItem;return t&&t.value&&t.value.lastEp&&t.value.lastEp.timestamp?t.value.lastEp.timestamp:null}async init(t=!1){return await Promise.all([this.initReleaseProgress(t)]),this}getCurrentEpisode(){return K.settings.get("epPredictions")?this.getProgressCurrentEpisode():null}isFinished(){return this.isProgressFinished()}isAiring(){return!this.isFinished()}getPredictionTimestamp(){return!this.getProgressPrediction()||(new Date).getTime()>this.getProgressPrediction()?NaN:this.getProgressPrediction()}getPrediction(){return M(this.getPredictionTimestamp())}getPredictionText(){const t=this.getPrediction();return t?K.storage.lang(`prediction_Episode_${this.type}`,[t]):""}getLastTimestamp(){return this.getProgressLastTimestamp()}getLast(t=!0){return M(this.getLastTimestamp(),t)}getLastText(){const t=this.getLast(!1);return t?K.storage.lang(`prediction_Last_${this.type}`,[t]):""}getAuto(){const t=this.getPrediction();if(t)return t;return this.getLast()||""}getAutoText(){const t=this.getPredictionText();if(t)return t;return this.getLastText()||""}getColor(){return"#f57c00"}getBars(t,e){const n=this.getCurrentEpisode(),r={totalWidth:100,epWidth:0,predWidth:0};if(!e)if(r.totalWidth=0,t&&(!n||t>=n))e=Math.ceil(1.2*t);else{if(!n||t&&!(t<n))return r;e=Math.ceil(1.2*n)}return t&&(r.epWidth=t/e*100,r.epWidth>100&&(r.epWidth=100)),n&&(r.predWidth=n/e*100,r.predWidth>100&&(r.predWidth=100)),r}}var F=n(986);class B extends Error{constructor(t){super(t),this.name="NotAutenticatedError"}}class q extends Error{constructor(t){super(t),this.name="UrlNotSupportedError"}}class V extends Error{constructor(t){super(t),this.name="ServerOfflineError"}}class G extends Error{constructor(t){super(t),this.name="NotFoundError"}}class W extends Error{constructor(t){super(t),this.name="UnexpectedResponseError"}}function z(t){try{return JSON.parse(t)}catch(t){throw new W(t.message)}}function H(t,e){return t instanceof B?F.storage.lang("Error_Authenticate",[e]):t instanceof V?"Server Offline":t instanceof q?`Incorrect url provided [${t.message}]`:t instanceof G?"Could not find this entry":t.message}var X=n(986),Y=n(812),J=n(994);Object.seal(b);class Q{constructor(t=1,e="anime",n="default"){return this.status=t,this.listType=e,this.sort=n,this.done=!1,this.loading=!1,this.firstLoaded=!1,this.seperateRewatching=!1,this.modes={frontend:!1,sortAiring:!1,initProgress:!1,cached:!1},this.username="",this.offset=0,this.templist=[],this.api=X,this.cacheObj=void 0,this.status=Number(this.status),this.logger=Y.m("[S]","#348fff"),this}setTemplist(t){return this.templist=t,this}getTemplist(){return this.templist}setSort(t){if(this.firstLoaded||this.loading)throw"To late to change sort";this.sort=t}isDone(){return this.done}isLoading(){return this.loading}isFirstLoaded(){return this.firstLoaded}async getCompleteList(){do{await this.getNext()}while(!this.done);return this.modes.sortAiring&&await this.sortAiringList(),this.modes.cached&&this.getCache().setValue(this.templist.slice(0,18)),this.firstLoaded=!0,this.templist}async getNextPage(){return this.done?this.templist:!this.modes.frontend||1!==this.status||"default"!==this.sort&&"unread"!==this.sort?(await this.getNext(),this.modes.cached&&this.getCache().setValue(this.templist.slice(0,24)),this.firstLoaded=!0,this.templist):(this.modes.sortAiring=!0,this.getCompleteList())}async getNext(){this.loading=!0;const t=await this.getPart();this.templist=this.templist.concat(t),this.loading=!1}async getCached(){if(await this.getCache().hasValue()){const t=await this.getCache().getValue();return t.forEach((t=>{(t=this.fn(t)).watchedEp="",t.score=""})),t}return[]}initFrontendMode(){this.modes.frontend=!0,this.updateListener=b.on("update.*",(t=>{if(Y.log("update",t),t.cacheKey){const e=this.templist.find((e=>e.cacheKey===t.cacheKey));Y.log(e),e&&t.state&&(e.watchedEp=t.state.episode,e.score=t.state.score,e.status=t.state.status)}}),{objectify:!0})}destroy(){this.updateListener&&this.updateListener.off()}getUsername(){return this.getUserObject().then((t=>t.username))}getSortingOptions(t=!1){const e=[{icon:"filter_list",title:X.storage.lang("settings_progress_default"),value:"default"}];return 1===this.status&&"manga"===this.listType&&e.push({icon:"adjust",title:X.storage.lang("list_sorting_unread"),value:"unread"}),this._getSortingOptions().forEach((n=>{if(!t){if(n.asc){const t={...n};delete t.asc,t.value+="_asc",t.title+=" Ascending",e.push(t)}delete n.asc}e.push(n)})),e}flashmError(t){J.flashm(this.errorMessage(t),{error:!0,type:"error"})}errorMessage(t){return H(t,this.authenticationUrl)}async fn(t,e=""){let n=null;return t.fn={continueUrl:()=>null!==n?n:J.getContinueWaching(t.type,t.cacheKey).then((e=>{const r=parseInt(t.watchedEp.toString());return void 0===e||e.ep!==r+1?"":(n=e.url,n)})),initProgress:()=>new U(t.cacheKey,t.type).init().then((e=>{t.fn.progress=e})),progress:!1},t.options=await J.getEntrySettings(t.type,t.cacheKey,t.tags),e&&(t.options.u=e),(this.modes.sortAiring||this.modes.initProgress)&&await t.fn.initProgress(),t}async initProgress(){const t=[];this.templist.forEach((e=>{t.push(e.fn.initProgress())})),await Promise.all(t)}async sortAiringList(){if("unread"===this.sort)return void this.sortUnread();const t=[];let e=[],n=[];function r(t,e){let n=t.fn.progress.getPredictionTimestamp(),r=e.fn.progress.getPredictionTimestamp();return n||(n=999999999999),r||(r=n),n-r}this.templist.forEach((r=>{const i=r.fn.progress;"anime"===this.listType?i&&i.isAiring()&&i.getPredictionTimestamp()?r.watchedEp<i.getCurrentEpisode()?e.push(r):n.push(r):t.push(r):i&&i.isAiring()&&i.getCurrentEpisode()&&r.watchedEp&&r.watchedEp<i.getCurrentEpisode()&&r.watchedEp+6>i.getCurrentEpisode()?e.push(r):t.push(r)})),e=e.sort(r).reverse(),n=n.sort(r),this.templist=e.concat(n,t)}sortUnread(){this.templist=this.templist.sort((function(t,e){let n=1e4,r=1e4;if(t.fn.progress&&t.fn.progress.getCurrentEpisode()){const e=t.fn.progress.getCurrentEpisode()-t.watchedEp;e>0&&(n=e)}if(e.fn.progress&&e.fn.progress.getCurrentEpisode()){const t=e.fn.progress.getCurrentEpisode()-e.watchedEp;t>0&&(r=t)}return n-r}))}getCache(){return this.cacheObj||(this.cacheObj=new $(`list/${this.name}/${this.listType}/${this.status}/${this.sort}`,1728e5)),this.cacheObj}}n(994),n(986);var Z=n(986);const tt="https://malsync.moe/mal/oauth";async function et(t){let e="https://api.myanimelist.net/v2/"+t.path;t.fields&&t.fields.length&&(e+=e.includes("?")?"&":"?",e+=`fields=${t.fields.join(",")}`);const n={Authorization:`Bearer ${Z.settings.get("malToken")}`,"Content-Type":"application/x-www-form-urlencoded"};let r="";if(t.dataObj){const e=[];for(const n in t.dataObj){const r=encodeURIComponent(n),i=encodeURIComponent(t.dataObj[n]);e.push(`${r}=${i}`)}r=e.join("&")}return Z.request.xhr(t.type,{url:e,headers:n,data:r}).then((async e=>{if(e.status>499&&e.status<600||0===e.status)throw new V(`Server Offline status: ${e.status}`);let n;try{n=JSON.parse(e.responseText)}catch(t){if(nt(e.responseText))throw new Error(Z.storage.lang("Error_Blocked",["MyAnimeList"]));throw t}if(n&&n.error)switch(n.error){case"forbidden":case"invalid_token":if(await async function(t){const e=t.m("Refresh");e.log("Refresh Access Token");const n=Z.settings.get("malRefresh");return!!n&&Z.request.xhr("POST",{url:"https://myanimelist.net/v1/oauth2/token",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:`client_id=10093a3f9f0174b6b5577c40e9accdae&grant_type=refresh_token&refresh_token=${n}`}).then((t=>{try{return z(t.responseText)}catch(e){if(nt(t.responseText))throw new Error(Z.storage.lang("Error_Blocked",["MyAnimeList"]));throw e}})).then((t=>t&&t.refresh_token&&t.access_token?(Z.settings.set("malToken",t.access_token),Z.settings.set("malRefresh",t.refresh_token),!0):t&&t.error?(e.error(t.error,"|",t.message),Z.settings.set("malRefresh",""),!1):(e.error("Something went wrong"),!1)))}(this.logger))return this.apiCall(t);throw new B(n.message??n.error);case"not_found":throw new G(n.message??n.error);case"invalid_content":throw new Error("This Entry is currently pending approval. It can´t be saved to mal for now");default:throw new Error(n.message??n.error)}if(400===e.status)throw new Error("Invalid Parameters");return n}))}function nt(t){return Boolean(t.includes("Request blocked")||t.includes("your IP has been banned"))}var rt,it;!function(t){t[t.watching=1]="watching",t[t.completed=2]="completed",t[t.on_hold=3]="on_hold",t[t.dropped=4]="dropped",t[t.plan_to_watch=6]="plan_to_watch"}(rt||(rt={})),function(t){t[t.reading=1]="reading",t[t.completed=2]="completed",t[t.on_hold=3]="on_hold",t[t.dropped=4]="dropped",t[t.plan_to_read=6]="plan_to_read"}(it||(it={}));var st=n(986),at=n(812);class ot extends Q{constructor(){super(...arguments),this.name="MyAnimeList",this.authenticationUrl=tt,this.limit=100,this.apiCall=et}async getUserObject(){return this.apiCall({type:"GET",path:"users/@me"}).then((t=>({username:t.name,picture:t.picture,href:`https://myanimelist.net/profile/${t.name}`})))}deauth(){return st.settings.set("malToken","").then((()=>st.settings.set("malRefresh","")))}_getSortingOptions(){return[{icon:"sort_by_alpha",title:st.storage.lang("list_sorting_alpha"),value:"alpha"},{icon:"history",title:st.storage.lang("list_sorting_history"),value:"updated"},{icon:"score",title:st.storage.lang("list_sorting_score"),value:"score"},{icon:"calendar_month",title:st.storage.lang("list_sorting_airing_date"),value:"airing_date"}]}getOrder(t){switch(t){case"alpha":return`${this.listType}_title`;case"updated":return"list_updated_at";case"score":return"list_score";case"airing_date":return`${this.listType}_start_date`;default:return 1===this.status||6===this.status?this.getOrder("updated"):this.getOrder("alpha")}}async getPart(){this.limit=100,this.modes.frontend&&(this.limit=24);const t=this.getOrder(this.sort);let e="";t&&(e=`&sort=${t}`),at.log("[UserList][MAL]",`username: ${this.username}`,`status: ${this.status}`,`offset: ${this.offset}`,`sorting: ${e}`);let n="";return 7!==this.status&&(n="manga"===this.listType?`&status=${it[this.status]}`:`&status=${rt[this.status]}`),this.apiCall({type:"GET",path:`users/@me/${this.listType}list?nsfw=true&limit=${this.limit}&offset=${this.offset}${n}${e}`,fields:["list_status{tags,is_rewatching,is_rereading,start_date,finish_date}","num_episodes","num_chapters","num_volumes"]}).then((t=>(t.paging&&t.paging.next?this.offset+=this.limit:this.done=!0,this.prepareData(t.data))))}async prepareData(t){const e=[];for(let n=0;n<t.length;n++){const r=t[n];"anime"===this.listType?e.push(await this.fn({uid:r.node.id,malId:r.node.id,apiCacheKey:r.node.id,cacheKey:r.node.id,type:this.listType,title:r.node.title,url:`https://myanimelist.net/${this.listType}/${r.node.id}`,watchedEp:r.list_status.num_episodes_watched,totalEp:r.node.num_episodes,status:parseInt(rt[r.list_status.status]),score:r.list_status.score,image:r.node.main_picture?.medium??"",imageLarge:r.node.main_picture?.large||r.node.main_picture?.medium||"",tags:r.list_status.tags.length?r.list_status.tags.join(","):"",airingState:r.anime_airing_status})):e.push(await this.fn({uid:r.node.id,malId:r.node.id,apiCacheKey:r.node.id,cacheKey:r.node.id,type:this.listType,title:r.node.title,url:`https://myanimelist.net/${this.listType}/${r.node.id}`,watchedEp:r.list_status.num_chapters_read,totalEp:r.node.num_chapters,status:parseInt(it[r.list_status.status]),score:r.list_status.score,image:r.node.main_picture?.medium??"",imageLarge:r.node.main_picture?.large||r.node.main_picture?.medium||"",tags:r.list_status.tags.length?r.list_status.tags.join(","):"",airingState:r.anime_airing_status}))}return console.log(e),e}}const ut=ot;var lt=n(812),ct=n(986);const ht=lt.m("anilist","#3db4f2");function dt(t,e=null){const n={CURRENT:1,PLANNING:6,COMPLETED:2,DROPPED:4,PAUSED:3,REPEATING:1};return null!==e?Object.keys(n).find((t=>n[t]===e)):n[t]}var pt;function ft(t,e){return Number.isNaN(t)||!t?`anilist:${e}`:t}async function mt(t,e,n=!0){if(n&&!ct.settings.get("anilistToken"))throw new B("No token found");const r={"Content-Type":"application/json",Accept:"application/json"};return ct.settings.get("anilistToken")&&(r.Authorization=`Bearer ${ct.settings.get("anilistToken")}`),ct.request.xhr("POST",{url:"https://graphql.anilist.co",headers:r,data:JSON.stringify({query:t,variables:e})}).then((r=>{if(r.status>499&&r.status<600||0===r.status)throw new V(`Server Offline status: ${r.status}`);if(403===r.status)throw new Error(ct.storage.lang("Error_Blocked",["AniList"]));const i=z(r.responseText);if(void 0!==i.errors&&i.errors.length){ht.error("[SINGLE]","Error",i.errors);const r=i.errors[0];switch(r.status){case 400:if("Invalid token"===r.message&&!n)return ct.settings.set("anilistToken",null),mt(t,e,n);if("validation"===r.message)throw new Error("Wrong request format");if(r.message.includes("invalid"))throw new Error("Wrong request format");throw new B(r.message);case 404:throw new G(r.message);default:throw new Error(r.message)}}return i}))}function gt(t){return!t||t.endsWith("/default.jpg")?"":t}!function(t){t[t.CURRENT=1]="CURRENT",t[t.PLANNING=6]="PLANNING",t[t.COMPLETED=2]="COMPLETED",t[t.DROPPED=4]="DROPPED",t[t.PAUSED=3]="PAUSED",t[t.REPEATING=23]="REPEATING"}(pt||(pt={}));var yt=n(986),vt=n(812);class _t extends Q{constructor(){super(...arguments),this.name="AniList",this.compact=!1,this.seperateRewatching=!0,this.authenticationUrl="https://anilist.co/api/v2/oauth/authorize?client_id=1487&response_type=token"}getUserObject(){return mt("\n    query {\n      Viewer {\n        name\n        id\n        avatar {\n          large\n        }\n        options {\n          displayAdultContent\n        }\n        mediaListOptions {\n          scoreFormat\n        }\n      }\n    }\n    ",[],!0).then((t=>{if(t.data.Viewer.options&&t.data.Viewer.mediaListOptions){const e=yt.settings.get("anilistOptions");e.displayAdultContent=t.data.Viewer.options.displayAdultContent,e.scoreFormat=t.data.Viewer.mediaListOptions.scoreFormat,yt.settings.set("anilistOptions",e)}return{username:t.data.Viewer.name,picture:t.data.Viewer.avatar.large||"",href:`https://anilist.co/user/${t.data.Viewer.id}`}}))}deauth(){return yt.settings.set("anilistToken","")}accessToken(){return this.api.settings.get("anilistToken")}_getSortingOptions(){return[{icon:"sort_by_alpha",title:yt.storage.lang("list_sorting_alpha"),value:"alpha"},{icon:"history",title:yt.storage.lang("list_sorting_history"),value:"updated",asc:!0},{icon:"score",title:yt.storage.lang("list_sorting_score"),value:"score",asc:!0}]}getOrder(t){switch(t){case"alpha":return"MEDIA_TITLE_ENGLISH";case"updated":return"UPDATED_TIME_DESC";case"updated_asc":return"UPDATED_TIME";case"score":return"SCORE_DESC";case"score_asc":return"SCORE";default:return 1===this.status||this.status,this.getOrder("updated")}}async getPart(){this.offset<1&&(this.offset=1),vt.log("[UserList][AniList]",`username: ${this.username}`,`status: ${this.status}`,`offset: ${this.offset}`),this.username||(this.username=await this.getUsername());let t="\n    query ($page: Int, $userName: String, $type: MediaType, $status: MediaListStatus, $sort: [MediaListSort] ) {\n      Page (page: $page, perPage: 100) {\n        pageInfo {\n          hasNextPage\n        }\n        mediaList (status: $status, type: $type, userName: $userName, sort: $sort) {\n          status\n          score(format: POINT_100)\n          progress\n          progressVolumes\n          notes\n          media {\n            siteUrl\n            id\n            idMal\n            episodes\n            chapters\n            volumes\n            status\n            averageScore\n            coverImage{\n              large\n              extraLarge\n            }\n            bannerImage\n            title {\n              userPreferred\n            }\n          }\n        }\n      }\n    }\n    ";this.compact&&(t="\n      query ($page: Int, $userName: String, $type: MediaType, $status: MediaListStatus, $sort: [MediaListSort]) {\n        Page (page: $page, perPage: 100) {\n          pageInfo {\n            hasNextPage\n          }\n          mediaList (status: $status, type: $type, userName: $userName, sort: $sort) {\n            progress\n            media {\n              id\n              idMal\n            }\n          }\n        }\n      }\n      ");const e={page:this.offset,userName:this.username,type:this.listType.toUpperCase(),status:pt[parseInt(this.status.toString())],sort:null},n=this.getOrder(this.sort);return n&&(e.sort=n),mt(t,e,!0).then((t=>{vt.log("res",t);const e=t.data.Page.mediaList;return this.offset+=1,t.data.Page.pageInfo.hasNextPage||(this.done=!0),this.prepareData(e,this.listType)}))}async prepareData(t,e){const n=[];for(let r=0;r<t.length;r++){const i=t[r];let s;s="anime"===e?await this.fn({uid:i.media.id,malId:i.media.idMal,apiCacheKey:i.media.idMal??`anilist:${i.media.id}`,cacheKey:ft(i.media.idMal,i.media.id),type:e,title:i.media.title.userPreferred,url:i.media.siteUrl,watchedEp:i.progress,totalEp:i.media.episodes,status:dt(i.status),score:Math.round(i.score/10),image:gt(i.media.coverImage.large),imageLarge:gt(i.media.coverImage.extraLarge),imageBanner:gt(i.media.bannerImage),tags:i.notes,airingState:i.anime_airing_status}):await this.fn({uid:i.media.id,malId:i.media.idMal,apiCacheKey:i.media.idMal??`anilist:${i.media.id}`,cacheKey:ft(i.media.idMal,i.media.id),type:e,title:i.media.title.userPreferred,url:i.media.siteUrl,watchedEp:i.progress,totalEp:i.media.chapters,status:dt(i.status),score:Math.round(i.score/10),image:gt(i.media.coverImage.large),imageLarge:gt(i.media.coverImage.extraLarge),imageBanner:gt(i.media.bannerImage),tags:i.notes,airingState:i.anime_airing_status}),null===s.totalEp&&(s.totalEp=0),n.push(s)}return n}prepareCompact(t,e){const n=[];for(let e=0;e<t.length;e++){const r=t[e];n.push({malid:r.media.idMal,id:r.media.id,watchedEp:r.progress,cacheKey:ft(r.media.idMal,r.media.id)})}return n}}var bt=n(812),wt=n(986);const Et=bt.m("kitsu","#d65e43");function It(t,e=null){const n={current:1,planned:6,completed:2,dropped:4,on_hold:3};return null!==e?Object.keys(n).find((t=>n[t]===e)):n[t]}function St(t,e){let n;switch(wt.settings.get("kitsuOptions").titleLanguagePreference){case"english":n=t.en;break;case"romanized":n=t.en_jp;break;default:n=e}if(void 0!==n&&n||(n=t.en),void 0!==n&&n||(n=t.en_jp),void 0!==n&&n||(n=t.ja_jp),void 0===n||!n){const e=Object.keys(t);if(!e.length)return"No Title";n=t[e[0]]}return n}function kt(t,e){return Number.isNaN(t)||!t?`kitsu:${e}`:t}function Tt(t,e,n={},r=!0){const i={"Content-Type":"application/vnd.api+json",Accept:"application/vnd.api+json"};return r&&(i.Authorization=`Bearer ${wt.settings.get("kitsuToken")}`),wt.request.xhr(t,{url:e,headers:i,data:"GET"!==t?JSON.stringify(n):void 0}).then((t=>{if(t.status>499&&t.status<600||0===t.status)throw new V(`Server Offline status: ${t.status}`);if(204===t.status)return{};const e=z(t.responseText);if(void 0!==e.errors&&e.errors.length){Et.error("[SINGLE]","Error",e.errors);const t=e.errors[0];switch(parseInt(t.status)){case 401:case 403:throw new B(t.detail);case 404:throw new G(t.detail);default:throw new Error(t.detail)}}return e}))}var xt=n(986),$t=n(812);class Lt extends Q{constructor(){super(...arguments),this.name="Kitsu",this.authenticationUrl="https://kitsu.app/404?mal-sync=authentication"}async getUserObject(){const t=await this.userRequest(),e=xt.settings.get("kitsuOptions");return e.titleLanguagePreference=t.attributes.titleLanguagePreference,e.sfwFilter=t.attributes.sfwFilter,e.ratingSystem=t.attributes.ratingSystem,xt.settings.set("kitsuOptions",e),{username:t.attributes.name,picture:t.attributes.avatar?.large||"",href:`https://kitsu.app/users/${t.attributes.slug||t.id}`}}async getUserId(){const t=await xt.storage.get("kitsuUserId");if(void 0!==t&&t)return t;const e=await this.userRequest();return xt.storage.set("kitsuUserId",e.id),e.id}userRequest(){return Tt("GET","https://kitsu.app/api/edge/users?filter[self]=true").then((t=>{if($t.log(t),void 0===t.data[0])throw new B("Not Authenticated");return t.data[0]}))}deauth(){return xt.settings.set("kitsuToken","").then((()=>xt.storage.set("kitsuUserId","")))}accessToken(){return xt.settings.get("kitsuToken")}_getSortingOptions(){return[{icon:"sort_by_alpha",title:xt.storage.lang("list_sorting_alpha"),value:"alpha",asc:!0},{icon:"history",title:xt.storage.lang("list_sorting_history"),value:"updated",asc:!0},{icon:"score",title:xt.storage.lang("list_sorting_score"),value:"score",asc:!0}]}getOrder(t){let e="";switch(t.endsWith("_asc")||(e="-"),t.replace("_asc","")){case"alpha":return e=e?"":"-",`${e}${this.listType}.titles.en`;case"updated":return`${e}progressed_at`;case"score":return`${e}rating`;default:return 1===this.status||6===this.status?this.getOrder("updated"):this.getOrder("alpha")}}async getPart(){const t=await this.getUserId();let e="",n="";const r=this.getOrder(this.sort);return r&&(n=`&sort=${r}`),7!==this.status&&(e=`&filter[status]=${It(this.status,this.status)}`),$t.log("[UserList][Kitsu]",`user: ${t}`,`status: ${this.status}`,`offset: ${this.offset}`),Tt("GET",`https://kitsu.app/api/edge/library-entries?filter[user_id]=${t}${e}&filter[kind]=${this.listType}&page[offset]=${this.offset}&page[limit]=50${n}&include=${this.listType},${this.listType}.mappings,${this.listType}.mappings.item&fields[${this.listType}]=slug,titles,canonicalTitle,averageRating,posterImage,coverImage,${"anime"===this.listType?"episodeCount":"chapterCount,volumeCount"}`).then((t=>($t.log(t),this.offset+=50,t.meta.count>this.offset||(this.done=!0),this.prepareData(t,this.listType))))}async prepareData(t,e){const n=[];for(let r=0;r<t.data.length;r++){const i=t.data[r],s=t.included[r],a=St(s.attributes.titles,s.attributes.canonicalTitle);let o,u=NaN;for(let n=0;n<t.included.length;n++){const r=t.included[n];if("mappings"===r.type&&r.attributes.externalSite===`myanimelist/${e}`&&r.relationships.item.data.id===s.id){u=Number(r.attributes.externalId),t.included.splice(n,1);break}}o="anime"===e?await this.fn({malId:u,apiCacheKey:u,uid:Number(s.id),cacheKey:kt(u,s.id),kitsuSlug:s.attributes.slug,type:e,title:a,url:`https://kitsu.app/${e}/${s.attributes.slug}`,watchedEp:i.attributes.progress,totalEp:s.attributes.episodeCount,status:It(i.attributes.status),score:Math.round(i.attributes.ratingTwenty/2),image:s.attributes.posterImage&&s.attributes.posterImage.small?s.attributes.posterImage.small:"",imageLarge:s.attributes.posterImage&&s.attributes.posterImage.original?s.attributes.posterImage.original:"",imageBanner:s.attributes.coverImage&&s.attributes.coverImage.large?s.attributes.coverImage.large:"",tags:i.attributes.notes,airingState:s.anime_airing_status}):await this.fn({malId:u,apiCacheKey:u,uid:Number(s.id),cacheKey:kt(u,s.id),kitsuSlug:s.attributes.slug,type:e,title:a,url:`https://kitsu.app/${e}/${s.attributes.slug}`,watchedEp:i.attributes.progress,totalEp:s.attributes.chapterCount,status:It(i.attributes.status),score:Math.round(i.attributes.ratingTwenty/2),image:s.attributes.posterImage&&s.attributes.posterImage.small?s.attributes.posterImage.small:"",imageLarge:s.attributes.posterImage&&s.attributes.posterImage.original?s.attributes.posterImage.original:"",imageBanner:s.attributes.coverImage&&s.attributes.coverImage.large?s.attributes.coverImage.large:"",tags:i.attributes.notes,airingState:s.anime_airing_status}),null===o.totalEp&&(o.totalEp=0),n.push(o)}return n}}var Ot=n(812),Pt=n(986);const Nt="39e8640b6f1a60aaf60f3f3313475e830517badab8048a4e52ff2d10deb2b9b0";function At(){return`https://simkl.com/oauth/authorize?response_type=code&client_id=${Nt}&redirect_uri=https://simkl.com/apps/chrome/mal-sync/connected/`}function Ct(t,e=null){const n={watching:1,plantowatch:6,completed:2,notinteresting:4,hold:3};return null!==e?Object.keys(n).find((t=>n[t]===e)):n[t]}function Rt(t,e){return Number.isNaN(t)||!t?`simkl:${e}`:t}function Mt(t){if("number"==typeof t)return t;if(t){const e=t.match(/e\d+/i);if(null!==e){const t=parseInt(e[0].replace(/\D/,""));return Number.isNaN(t)?0:t}}return 0}let jt;async function Dt(t=!1){const e=Ot.m("Simkl","#9b7400").m("list");if(void 0===jt)jt=await Pt.storage.get("simklList");else if(t)return jt;const n=await Pt.storage.get("simklLastCheck"),r=await this.call("https://api.simkl.com/sync/activities");if(e.log("Activity",n,r.anime),n&&n.removed_from_list!==r.anime.removed_from_list){const t=await this.call("https://api.simkl.com/sync/all-items/anime"),n={};if(t)for(let e=0;e<t.anime.length;e++){const r=t.anime[e];void 0!==jt[r.show.ids.simkl]&&(n[r.show.ids.simkl]=jt[r.show.ids.simkl])}jt=n,e.log("remove",jt)}let i="";if(n&&jt&&(i=`date_from=${n.all}`,n.all===r.anime.all))return e.log("Up to date"),jt;if(jt||(jt={}),n&&n.rated_at!==r.anime.rated_at){const t=await this.call(`https://api.simkl.com/sync/ratings/anime?${i}`);if(e.log("ratedUpdate",t),t)for(let e=0;e<t.anime.length;e++){const n=t.anime[e];jt[n.show.ids.simkl]=n}}const s=await this.call(`https://api.simkl.com/sync/all-items/anime?${i}`);if(e.log("listUpdate",s),s)for(let t=0;t<s.anime.length;t++){const e=s.anime[t];jt[e.show.ids.simkl]=e}return e.log("totalList",jt),await Pt.storage.set("simklList",jt),await Pt.storage.set("simklLastCheck",r.anime),jt}async function Kt(t,e=!1){const n=await this.syncList(e);if(t.simkl){if(void 0!==n[t.simkl])return n[t.simkl]}else{if(!t.mal)throw"No id passed";{const e=Object.values(n);for(let n=0;n<e.length;n++){const r=e[n];if(void 0!==r.show.ids.mal&&Number(r.show.ids.mal)===Number(t.mal))return r}}}return null}async function Ut(t,e={},n=!1,r="GET",i=!0){const s=Ot.m("Simkl","#9b7400").m("call");n&&(t+=`?${new URLSearchParams(Object.entries(e))}`,e=void 0),s.log(r,t,e);const a={"simkl-api-key":Nt,Accept:"application/vnd.api+json","Content-Type":"application/json"};return i?a.Authorization=`Bearer ${Pt.settings.get("simklToken")}`:s.log("No login"),"GET"===r&&(e=void 0),Pt.request.xhr(r,{url:t,headers:a,data:e}).then((async t=>{const e=z(t.responseText);return this.errorHandling(e,t.status),e}))}function Ft(t,e){if(e>499&&e<600||0===e)throw new V(`Server Offline status: ${e}`);if(t&&void 0!==t.error){this.logger.error("[SINGLE]","Error",t.error);const{error:e}=t;if(e.code)throw e.code,new Error(e.error);if("user_token_failed"===e)throw new B("user_token_failed");throw e}}var Bt=n(986),qt=n(812);class Vt extends Q{constructor(){super(...arguments),this.name="Simkl",this.authenticationUrl=At(),this.errorHandling=Ft,this.syncList=Dt,this.translateList=Ct,this.getCacheKey=Rt,this.getEpisode=Mt,this.call=Ut}async getUserObject(){return this.call("https://api.simkl.com/users/settings").then((t=>{if(t&&t.user&&void 0!==t.user.name)return{username:t.user.name,picture:t.user.avatar||"",href:`https://simkl.com/${t.account.id}`};throw new B("Not Authenticated")}))}deauth(){return Bt.settings.set("simklToken","")}_getSortingOptions(){return[]}async getPart(){if(qt.log("[UserList][Simkl]",`status: ${this.status}`),"manga"===this.listType)throw new Error("Does not support manga");return this.syncList().then((async t=>{this.done=!0;const e=await this.prepareData(Object.values(t),this.listType,this.status);return qt.log(e),e}))}async prepareData(t,e,n){const r=[];for(let i=0;i<t.length;i++){const s=t[i],a=this.translateList(s.status);if(7!==n&&parseInt(a)!==n)continue;let o=this.getEpisode(s.last_watched);if(2===a&&(o=s.total_episodes_count),"anime"===e){const t=await this.fn({malId:s.show.ids.mal,apiCacheKey:s.show.ids.mal,uid:s.show.ids.simkl,cacheKey:this.getCacheKey(s.show.ids.mal,s.show.ids.simkl),type:e,title:s.show.title,url:`https://simkl.com/${e}/${s.show.ids.simkl}`,watchedEp:o,totalEp:s.total_episodes_count,status:a,score:s.user_rating?s.user_rating:0,image:`https://simkl.in/posters/${s.show.poster}_ca.jpg`,imageLarge:`https://simkl.in/posters/${s.show.poster}_m.jpg`,imageBanner:`https://simkl.in/posters/${s.show.poster}_w.jpg`,tags:s.private_memo,airingState:s.anime_airing_status});r.push(t)}}return r}}var Gt=n(986);const Wt="z3NJ84kK9iy5NU6SnhdCDB38rr4-jFIJ67bMIUDzdoo",zt=`https://shikimori.one/oauth/authorize?client_id=${Wt}&redirect_uri=https%3A%2F%2Fmalsync.moe%2Fshikimori%2Foauth&response_type=code&scope=user_rates`,Ht="https://shikimori.one/api/",Xt="https://shikimori.one";async function Yt(t){const e=t.type||"GET",n=Gt.settings.get("shikiToken");if(!n&&!n.access_token&&!t.auth)throw new B("No token set");let r=Ht+t.path;if(t.parameter&&Object.keys(t.parameter).length){r+=r.includes("?")?"&":"?";const e=[];for(const n in t.parameter)e.push(`${n}=${t.parameter[n]}`);r+=e.join("&")}const i={Authorization:`Bearer ${n.access_token}`,"User-Agent":"MAL-Sync","Content-Type":"application/json"};let s="";return t.dataObj&&(s=JSON.stringify(t.dataObj)),t.auth&&(delete i.Authorization,r="https://shikimori.one/oauth/token"),Gt.request.xhr(e,{url:r,headers:i,data:s}).then((async e=>{if(e.status>499&&e.status<600||0===e.status)throw new V(`Server Offline status: ${e.status}`);let r=null;if(e.responseText&&(r=JSON.parse(e.responseText)),401===e.status){if(t.auth)throw new B(r.message??r.error);return await Jt(n.refresh_token),Yt(t)}if(r&&r.error)switch(r.error){case"forbidden":case"invalid_token":if(t.auth)throw new B(r.message??r.error);return await Jt(n.refresh_token),Yt(t);case"not_found":throw new G(r.message??r.error);default:throw new Error(r.message??r.error)}if(400===e.status)throw new Error("Invalid Parameters");return r}))}async function Jt(t){const e=await function(t){const e={client_id:Wt,client_secret:"6vkFaJN_wxQHmBoq23ac1z6tZKiAD7xqsXGudkkOqTg",redirect_uri:"https://malsync.moe/shikimori/oauth"};return"code"in t&&(e.code=t.code,e.grant_type="authorization_code"),"refresh_token"in t&&(e.refresh_token=t.refresh_token,e.grant_type="refresh_token"),Yt({type:"POST",path:"oauth/token",auth:!0,dataObj:e})}({refresh_token:t}).catch((t=>{throw"invalid_request"===t.message&&Gt.settings.set("shikiToken",""),t}));await Gt.settings.set("shikiToken",{access_token:e.access_token,refresh_token:e.refresh_token})}function Qt(){return Yt({type:"GET",path:"users/whoami"}).then((t=>(t.locale&&Gt.settings.set("shikiOptions",{locale:t.locale}),t)))}function Zt(t,e,n=!1){const r=Gt.settings.get("shikiOptions");return"ru"===(r&&r.locale?r.locale:"ru")?t||e:n&&e&&t?`${e} / ${t}`:e||t}var te;!function(t){t[t.watching=1]="watching",t[t.planned=6]="planned",t[t.completed=2]="completed",t[t.dropped=4]="dropped",t[t.on_hold=3]="on_hold",t[t.rewatching=23]="rewatching"}(te||(te={}));var ee=n(986),ne=n(812);class re extends Q{constructor(){super(...arguments),this.name="Shiki",this.seperateRewatching=!0,this.authenticationUrl=zt,this.tempList=[]}getUserObject(){return Qt().then((t=>({username:t.nickname,picture:t.image.x80,href:t.url})))}deauth(){return ee.settings.set("shikiToken","")}_getSortingOptions(){return[]}getSortingOptions(){return[]}async getPart(){if(this.offset<2&&(this.offset=0),ne.log("[UserList][Shiki]",`username: ${this.username}`,`status: ${this.status}`,`offset: ${this.offset}`),!this.tempList.length){let t="";7!==this.status&&(t=te[this.status]);const e=await async function(){const t=new $("shiki/userId",144e5);if(await t.hasValue())return t.getValue();const e=await Qt();return e.id&&t.setValue(e.id),e.id}();this.tempList=await Yt({path:"v2/user_rates",type:"GET",parameter:{user_id:e,target_type:"anime"===this.listType?"Anime":"Manga",status:t}})}const t=this.tempList.slice(this.offset,this.offset+25);this.offset+=25,this.offset>=this.tempList.length&&(this.done=!0);const e=t.map((t=>t.target_id)),n=await Yt({path:`${this.listType}s`,parameter:{ids:e.join(","),limit:25},type:"GET"}),r={};for(const t in n){const e=n[t];r[e.id]=e}if("manga"===this.listType){const t=Object.keys(r),n=e.filter((e=>!t.includes(e)));if(n.length){const t=await Yt({path:"ranobe",parameter:{ids:n.join(","),limit:25},type:"GET"});for(const e in t){const n=t[e];r[n.id]=n}}}return this.prepareData(t,r)}async prepareData(t,e){const n=[];for(const r in t){const i=t[r],s=e[i.target_id],a=await this.fn({malId:i.target_id,apiCacheKey:i.target_id,uid:i.target_id,cacheKey:i.target_id,type:"Anime"===i.target_type?"anime":"manga",title:Zt(s.russian,s.name),url:`${Xt}${s.url}`,watchedEp:"Anime"===i.target_type?i.episodes:i.chapters,totalEp:"Anime"===i.target_type?s.episodes:s.chapters,status:te[i.status],score:i.score?i.score:0,image:s.image.original?`${Xt}${s.image.original}`:"",imageLarge:s.image.original?`${Xt}${s.image.original}`:"",tags:i.text});n.push(a)}return n}}var ie=n(986);function se(t,e){return`local:${t}:${e}`}async function ae(){let t;if("userscript"===ie.type){const e=await ie.storage.list("sync");for(const t in e)e[t]=await ie.storage.get(t);t=e}else t=ie.storage.list("sync");return t}function oe(t){return new RegExp(`^local://[^/]*/${t}`,"i")}var ue=n(812),le=n(994);class ce extends Q{constructor(){super(...arguments),this.name="local",this.authenticationUrl="",this.getRegex=oe,this.getSyncList=ae,this.getCacheKey=se}async getUserObject(){return Promise.resolve({username:"local",picture:"",href:""})}_getSortingOptions(){return[]}async getPart(){return ue.log("[UserList][Local]",`status: ${this.status}`),this.done=!0,await this.prepareData(await this.getSyncList(),this.listType,this.status)}async prepareData(t,e,n){const r=[];for(const i in t)if(this.getRegex(e).test(i)){const s=t[i];if(ue.log(i,s),7!==n&&parseInt(s.status)!==n)continue;"anime"===e?r.push(await this.fn({airingState:2,image:s.image??"",imageLarge:s.image??"",malId:0,apiCacheKey:0,tags:s.tags,title:`[L] ${s.name}`,totalEp:0,status:s.status,score:s.score,type:"anime",uid:i,url:i,cacheKey:this.getCacheKey(le.urlPart(i,4),le.urlPart(i,2)),watchedEp:s.progress},s.sUrl)):r.push(await this.fn({airingState:2,image:s.image??"",imageLarge:s.image??"",malId:0,apiCacheKey:0,tags:s.tags,title:`[L] ${s.name}`,totalEp:0,status:s.status,score:s.score,type:"manga",uid:i,url:i,cacheKey:this.getCacheKey(le.urlPart(i,4),le.urlPart(i,2)),watchedEp:s.progress},s.sUrl))}return ue.log("data",r),r}}var he=n(986);async function de(...t){let e=[];if(he.settings.get("localSync")){const[n,r]=t,i=new ce(n,r);i.modes.initProgress=!0,e=await i.getCompleteList()}const n=function(t,e=""){e||(e=I(t[1]?t[1]:"anime"));const[n,r,i]=t;if("MAL"===e)return new ut(n,r,i);if("MALAPI"===e)return new ot(n,r,i);if("ANILIST"===e)return new _t(n,r,i);if("KITSU"===e)return new Lt(n,r,i);if("SIMKL"===e)return new Vt(n,r,i);if("SHIKI"===e)return new re(n,r,i);throw"Unknown sync mode"}(t);return n.setTemplist(e),n}var pe=n(812),fe=n(986);const me=6048e5,ge=pe.m("Database"),ye=new m("malsync");async function ve(t){pe.log("update",t),t.id&&t.state.onList&&async function(t){("anime"===t.type?ye.table("anime"):ye.table("manga")).put(t)}({uid:t.id,type:t.type,title:t.meta.title,malId:t.meta.malId,cacheKey:t.cacheKey,image:t.meta.image,score:t.state.score,status:t.state.status,watchedEp:t.state.episode,totalEp:t.meta.totalEp,url:t.meta.url})}async function _e(){const t=["anime","manga"],e=await fe.settings.getAsync("syncMode");for(let n=0;n<t.length;n++){const r=t[n],i=await be(`update_${r}`),s=await be(`update_mode_${r}`);(!i||i<Date.now()-me||s!==e)&&await Ie(r)}}async function be(t){return ye.table("storage").get(t).then((t=>void 0===t?t:t.value))}async function we(t,e){return ye.table("storage").put({key:t,value:e})}const Ee={anime:!1,manga:!1};async function Ie(t){if(Ee[t])ge.log("Import already running");else{Ee[t]=!0,ge.log(`Import ${t} database`);try{await fe.settings.init();const e=await de(7,t),n=await e.getCompleteList();await async function(t,e){const n="anime"===t?ye.table("anime"):ye.table("manga");return await n.clear(),n.bulkPut(e)}(t,n.map((t=>({uid:t.uid,type:t.type,title:t.title,malId:t.malId,cacheKey:t.cacheKey,image:t.image,score:t.score,status:t.status,watchedEp:t.watchedEp,totalEp:t.totalEp,url:t.url})))).then((()=>{Ee[t]=!1,we(`update_${t}`,Date.now()),we(`update_mode_${t}`,fe.settings.get("syncMode"))}))}catch(e){throw Ee[t]=!1,e}}}var Se,ke,Te;(ke=Se||(Se={}))[ke.NoState=0]="NoState",ke[ke.Watching=1]="Watching",ke[ke.Completed=2]="Completed",ke[ke.Onhold=3]="Onhold",ke[ke.Dropped=4]="Dropped",ke[ke.PlanToWatch=6]="PlanToWatch",ke[ke.All=7]="All",ke[ke.Rewatching=23]="Rewatching",function(t){t[t.NoScore=0]="NoScore",t[t.R1=1]="R1",t[t.R2=2]="R2",t[t.R3=3]="R3",t[t.R4=4]="R4",t[t.R5=5]="R5",t[t.R6=6]="R6",t[t.R7=7]="R7",t[t.R8=8]="R8",t[t.R9=9]="R9",t[t.R10=10]="R10"}(Te||(Te={})),Error;class xe extends Error{constructor(t){super(t),this.name="SafeError"}}Error,Error;var $e=n(986);const Le={ui:{module:"dropdown"},getOptions:()=>[{value:0,label:$e.storage.lang("UI_Score_Not_Rated")},{value:100,label:$e.storage.lang("UI_Score_Masterpiece")},{value:90,label:$e.storage.lang("UI_Score_Great")},{value:80,label:$e.storage.lang("UI_Score_VeryGood")},{value:70,label:$e.storage.lang("UI_Score_Good")},{value:60,label:$e.storage.lang("UI_Score_Fine")},{value:50,label:$e.storage.lang("UI_Score_Average")},{value:40,label:$e.storage.lang("UI_Score_Bad")},{value:30,label:$e.storage.lang("UI_Score_VeryBad")},{value:20,label:$e.storage.lang("UI_Score_Horrible")},{value:10,label:$e.storage.lang("UI_Score_Appalling")}],valueToOptionValue:t=>t?t<10?10:10*Math.round(t/10):0,optionValueToValue:t=>t?Number(t):0};var Oe=n(812),Pe=n(986),Ne=n(994);Object.seal(b);class Ae{constructor(t){return this.url=t,this.type=null,this.askCompleted=!1,this.rewatchingSupport=!0,this.ids={mal:NaN,ani:NaN,kitsu:{id:NaN,slug:""},simkl:NaN},this.options=null,this.progress=!1,this.updateProgress=!1,this._onList=!1,this._authenticated=!1,this.handleUrl(t),this.logger=Oe.m("[S]","#348fff"),this}getType(){return this.type}getUrl(){return this.url}supportsRewatching(){return this.rewatchingSupport}getApiCacheKey(){return this.getKey(["ANILIST"])}getRulesCacheKey(){return this.getKey(["ANILIST","KITSU"],!1)}setStatus(t){return t=Number(t),this._setStatus(t),this}getStatus(){return this.isOnList()?this._getStatus():Se.NoState}getScoreMode(){return Le}setScore(t){return(t=parseInt(`${t}`))||(t=0),this._setScore(t),this}getScore(){return this._getScore()||0}setAbsoluteScore(t){return t=parseInt(`${t}`),this._setAbsoluteScore(t),this}getAbsoluteScore(){return this._getAbsoluteScore()||0}setEpisode(t){return t=parseInt(`${t}`),this.getTotalEpisodes()&&t>this.getTotalEpisodes()&&(t=this.getTotalEpisodes()),this._setEpisode(t),this}getEpisode(){return this._getEpisode()}setVolume(t){return this._setVolume(t),this}getVolume(){return this._getVolume()}setStreamingUrl(t){return this.options&&(this.options.u=t),this}getStreamingUrl(){if(this.options&&this.options.u)return this.options.u}cleanTags(){this.options=null}async initProgress(){const t=await N(this.getType(),this.getApiCacheKey());return new U(this.getCacheKey(),this.getType()).init({uid:this.getCacheKey(),apiCacheKey:this.getApiCacheKey(),title:this.getTitle(),cacheKey:this.getCacheKey(),progressMode:this.getProgressMode(),watchedEp:this.getEpisode(),single:this,xhr:t}).then((e=>{this.updateProgress=!1,this.progress=e,this.progressXhr=t}))}getProgress(){return!!this.progress&&this.progress}getProgressFormated(){const t=[],e=new Intl.DisplayNames("en",{type:"language"});return Oe.log(this.progressXhr),this.progressXhr&&Object.keys(this.progressXhr).length&&this.progressXhr.forEach((n=>{t.push({type:n.type,key:n.id,state:n.state,label:e.of(n.lang.replace(/^jp$/,"ja"))||n.lang,dropped:"dropped"===n.state||"discontinued"===n.state,episode:n.lastEp&&n.lastEp.total?n.lastEp.total:0,lastEp:n.lastEp,predicition:n.prediction})})),t}getProgressOptions(){return this.getProgressFormated().filter((t=>"complete"!==t.state))}getProgressCompleted(){return this.getProgressFormated().filter((t=>"complete"===t.state))}getProgressMode(){return this.options&&this.options.p?this.options.p:""}setProgressMode(t){this.options&&(this.options.p=t,this.updateProgress=!0),Pe.settings.get("malTags")||Ne.setEntrySettings(this.type,this.getCacheKey(),this.options,this._getTags()).then((()=>this.initProgress()))}getProgressKey(){let t=this.getProgressMode();if(t||(t="anime"===this.getType()?Pe.settings.get("progressIntervalDefaultAnime"):Pe.settings.get("progressIntervalDefaultManga")),!t)return null;const e=/^([^/]*)\/(.*)$/.exec(t);return e?{key:t,lang:e[1],type:e[2]}:null}getPageRelations(){const t=this.shortName,e=[];return this.ids.mal&&"MAL"!==t&&e.push({name:"MAL",icon:"https://cdn.myanimelist.net/images/favicon.ico",link:`https://myanimelist.net/${this.type}/${this.ids.mal}`}),this.ids.ani&&"AniList"!==t&&e.push({name:"AniList",icon:"https://anilist.co/img/icons/favicon-32x32.png",link:`https://anilist.co/${this.type}/${this.ids.ani}`}),this.ids.kitsu.id&&"Kitsu"!==t&&e.push({name:"Kitsu",icon:"https://kitsu.app/favicon-32x32-3e0ecb6fc5a6ae681e65dcbc2bdf1f17.png",link:`https://kitsu.app/${this.type}/${this.ids.kitsu.id}`}),this.ids.simkl&&"Simkl"!==t&&e.push({name:"Simkl",icon:"https://eu.simkl.in/img_favicon/v2/favicon-32x32.png",link:`https://simkl.com/${this.type}/${this.ids.simkl}`}),e}fillRelations(){return Promise.resolve()}update(){return this.logger.log("[SINGLE]","Update info",this.ids),this.lastError=null,this._update().catch((t=>{throw this.lastError=t,t})).then((()=>(this.persistanceState=this.getStateEl(),Ne.getEntrySettings(this.type,this.getCacheKey(),this._getTags())))).then((t=>{this.options=t,this.registerEvent(),this.emitUpdate("state")}))}async sync(){return this.logger.log("[SINGLE]","Sync",this.ids),this.lastError=null,this._setTags(await Ne.setEntrySettings(this.type,this.getCacheKey(),this.options,this._getTags())),this._sync().catch((t=>{throw this.lastError=t,t})).then((()=>{this.undoState=this.persistanceState,this.updateProgress&&this.initProgress(),this._onList=!0,this.emitUpdate()}))}emitUpdate(t="update"){w(`${t}.${this.getCacheKey()}`,{id:this.getPageId(),type:this.getType(),cacheKey:this.getCacheKey(),state:this.getStateEl(),meta:{title:this.getTitle(),image:this.getImage(),malId:this.getMalId(),totalEp:this.getTotalEpisodes(),url:this.getUrl()}})}async delete(){return this._delete().then((()=>{this._onList=!1,w(`delete.${this.getCacheKey()}`,{id:this.getPageId(),type:this.getType(),cacheKey:this.getCacheKey()})}))}registerEvent(){this.globalUpdateEvent||(this.globalUpdateEvent=b.on(`update.${this.getCacheKey()}`,(t=>this.updateEvent(t))))}updateEvent(t){this.isDirty()?this.logger.log("Ignore event"):t&&t.state&&(this.setStateEl(t.state),this.persistanceState=this.getStateEl(),b.emit("syncPage_fillUi"))}isDirty(){return JSON.stringify(this.persistanceState)!==JSON.stringify(this.getStateEl())||this.updateProgress}undo(){if(this.logger.log("[SINGLE]","Undo",this.undoState),!this.undoState)throw new xe("No undo state found");if(!this.undoState.onList){if(void 0===this.delete)throw new Error("Deleting an entry is not supported");return this.delete().then((()=>{this.setStateEl(this.undoState),this.undoState=null}))}return this.setStateEl(this.undoState),this.sync().then((()=>{this.undoState=null}))}getTitle(t=!1){return this._getTitle(t)}getTotalEpisodes(){let t=this._getTotalEpisodes();return t||(t=0),t}getTotalVolumes(){return this._getTotalVolumes()}isOnList(){return this._onList}isAuthenticated(){return this._authenticated}getDisplayUrl(){return this._getDisplayUrl()}getMalUrl(){return Number.isNaN(this.ids.mal)?null:`https://myanimelist.net/${this.getType()}/${this.ids.mal}`}getMalId(){return Number.isNaN(this.ids.mal)?null:this.ids.mal}getIds(){return this.ids}getImage(){return this._getImage()}getRating(){return this._getRating().then((t=>t||"N/A"))}setResumeWatching(t,e){return Ne.setResumeWaching(t,e,this.type,this.getCacheKey())}getResumeWatching(){return this.options&&this.options.r?this.options.r:null}setContinueWatching(t,e){return Ne.setContinueWaching(t,e,this.type,this.getCacheKey())}getContinueWatching(){return this.options&&this.options.c?this.options.c:null}increaseRewatchCount(){}getStateEl(){return{onList:this.isOnList(),episode:this.getEpisode(),volume:this.getVolume(),status:this.getStatus(),score:this.getScore(),absoluteScore:this.getAbsoluteScore()}}setStateEl(t){this._onList=t.onList,this.setEpisode(t.episode),this.setVolume(t.volume),this.setStatus(t.status),this.setScore(t.score),t.absoluteScore&&this.setAbsoluteScore(t.absoluteScore)}getStateDiff(){const t=this.getStateEl();if(t&&this.undoState){const e={};for(const n in t)t[n]!==this.undoState[n]&&(e[n]=t[n]);return e}}async lifeCycleHook(t){this.askCompleted&&("afterCheckSync"===t&&Pe.settings.get("askBefore")||"beforeSync"===t&&!Pe.settings.get("askBefore"))&&(this.askCompleted=!1,this.getStatus()===Se.Rewatching?await this.finishRewatchingMessage():await this.finishWatchingMessage())}async checkSync(t,e){const n=this.getEpisode(),r=this.getStatus(),i=this.getVolume();return r===Se.Completed?1===t&&this.startRewatchingMessage():!(n>=t&&!(void 0!==e&&(i||e>1||!t)&&e>i))&&(t&&t===this.getTotalEpisodes()?(this.askCompleted=!0,!0):r===Se.Watching||r===Se.Rewatching||this.startWatchingMessage())}async startWatchingMessage(){return Ne.flashConfirm(Pe.storage.lang(`syncPage_flashConfirm_start_${this.getType()}`),"add").then((t=>(t&&this.setStatus(Se.Watching),t)))}async finishWatchingMessage(){const t=this.getScoreCheckboxValue();let e='<div><select id="finish_score" style="margin-top:5px; color:white; background-color:#4e4e4e; border: none;">';return this.getScoreCheckbox().forEach((n=>{e+=`<option value="${n.value}" ${t===n.value?"selected":""}>${n.label}</option>`})),e+="</select></div>",Ne.flashConfirm(Pe.storage.lang("syncPage_flashConfirm_complete")+e,"complete").then((t=>(t&&(this.setStatus(Se.Completed),Number(j.$("#finish_score").val())>0&&(this.logger.log(`finish_score: ${j.$("#finish_score :selected").val()}`),this.handleScoreCheckbox(j.$("#finish_score :selected").val()))),t)))}async startRewatchingMessage(){return Ne.flashConfirm(Pe.storage.lang(`syncPage_flashConfirm_rewatch_start_${this.getType()}`),"add").then((t=>(t&&this.setStatus(Se.Rewatching),t)))}async finishRewatchingMessage(){return Ne.flashConfirm(Pe.storage.lang(`syncPage_flashConfirm_rewatch_finish_${this.getType()}`),"complete").then((t=>(t&&(this.setStatus(Se.Completed),this.increaseRewatchCount()),t)))}getScoreCheckbox(){return this.getScoreMode().getOptions()}getScoreCheckboxValue(){return this.getScoreMode().valueToOptionValue(this.getAbsoluteScore())}handleScoreCheckbox(t){this.setAbsoluteScore(this.getScoreMode().optionValueToValue(t))}getDisplayScoreCheckbox(){const t=this.getScoreCheckboxValue(),e=this.getScoreCheckbox().filter((e=>e.value===t));return e.length?e[0].label:""}getStatusCheckbox(){const t=[{value:"1",label:Pe.storage.lang(`UI_Status_watching_${this.getType()}`)},{value:"2",label:Pe.storage.lang("UI_Status_Completed")},{value:"3",label:Pe.storage.lang("UI_Status_OnHold")},{value:"4",label:Pe.storage.lang("UI_Status_Dropped")},{value:"6",label:Pe.storage.lang(`UI_Status_planTo_${this.getType()}`)}];return this.rewatchingSupport&&t.push({value:"23",label:Pe.storage.lang(`UI_Status_Rewatching_${this.getType()}`)}),t}handleStatusCheckbox(t){this.setStatus(t)}getStatusCheckboxValue(){return this.getStatus()}getKey(t,e=!0){return e&&this.ids.mal?this.ids.mal:this.ids.ani&&t.includes("ANILIST")?`anilist:${this.ids.ani}`:this.ids.kitsu.id&&t.includes("KITSU")?`kitsu:${this.ids.kitsu.id}`:this.ids.simkl&&t.includes("SIMKL")?`simkl:${this.ids.simkl}`:this.ids.mal}getLastError(){return this.lastError}getLastErrorMessage(){return this.errorMessage(this.getLastError())}flashmError(t){Ne.flashm(this.errorMessage(t),{error:!0,type:"error"})}errorMessage(t){return H(t,this.authenticationUrl)}}var Ce=n(994),Re=n(812),Me=n(994);const je=class extends Ae{constructor(t){return super(t),this.url=t,this.displayUrl="",this.pending=!1,this.shortName="MAL",this.authenticationUrl=tt,this.apiCall=et,this.logger=Re.m(this.shortName,"#2e51a2"),this}handleUrl(t){if(t.match(/myanimelist\.net\/(anime|manga)\/\d*/i))return this.type="anime"===Me.urlPart(t,3)?"anime":"manga",void(this.ids.mal=Number(Me.urlPart(t,4)));throw new q(t)}getCacheKey(){return this.ids.mal}getPageId(){return this.ids.mal}_getStatus(){let t;return t="manga"===this.type?parseInt(it[this.animeInfo.my_list_status.status]):parseInt(rt[this.animeInfo.my_list_status.status]),this.getRewatching()&&2===t?23:t}_setStatus(t){23===t?(t=2,this.setRewatching(!0)):this.setRewatching(!1),"manga"!==this.type?this.animeInfo.my_list_status.status=rt[t]:this.animeInfo.my_list_status.status=it[t]}increaseRewatchCount(){"manga"===this.type?this.animeInfo.my_list_status.num_times_reread++:this.animeInfo.my_list_status.num_times_rewatched++}_getScore(){return this.animeInfo.my_list_status.score}_setScore(t){this.animeInfo.my_list_status.score=t}_getAbsoluteScore(){return 10*this.getScore()}_setAbsoluteScore(t){t?t<10?this.setScore(1):this.setScore(Math.round(t/10)):this.setScore(0)}_getEpisode(){return"manga"===this.type?this.animeInfo.my_list_status.num_chapters_read:this.animeInfo.my_list_status.num_watched_episodes}_setEpisode(t){t||(t=0),"manga"!==this.type?this.animeInfo.my_list_status.num_watched_episodes=t:this.animeInfo.my_list_status.num_chapters_read=t}_getVolume(){return"manga"===this.type?this.animeInfo.my_list_status.num_volumes_read:0}_setVolume(t){"manga"===this.type&&(this.animeInfo.my_list_status.num_volumes_read=t)}_getTags(){return this.animeInfo.my_list_status.tags.length?this.animeInfo.my_list_status.tags.join(","):""}_setTags(t){t&&","!==t.trim()?this.animeInfo.my_list_status.tags=t.split(","):this.animeInfo.my_list_status.tags=[]}getRewatching(){return"manga"===this.type?this.animeInfo.my_list_status.is_rereading:this.animeInfo.my_list_status.is_rewatching}setRewatching(t){"manga"!==this.type?this.animeInfo.my_list_status.is_rewatching=t:this.animeInfo.my_list_status.is_rereading=t}_getTitle(){return this.animeInfo.title}_getTotalEpisodes(){return"manga"===this.type?this.animeInfo.num_chapters:this.animeInfo.num_episodes}_getTotalVolumes(){return"manga"===this.type?this.animeInfo.num_volumes:0}_getDisplayUrl(){return this.url}_getImage(){return this.animeInfo.main_picture?.medium??""}_getRating(){return Promise.resolve(this.animeInfo.mean)}async _update(){return this.apiCall({type:"GET",path:`${this.type}/${this.ids.mal}`,fields:["my_list_status{tags,is_rewatching,is_rereading,num_times_rewatched,num_times_reread,start_date,finish_date}","num_episodes","mean","num_chapters","num_volumes"]}).catch((t=>{throw t instanceof B&&(this._authenticated=!1),t})).then((t=>{this.logger.m("Api").log(t),this._authenticated=!0,this.animeInfo=t,this._onList=!0,this.animeInfo.my_list_status||(this._onList=!1,"manga"===this.type?this.animeInfo.my_list_status={is_rereading:!1,num_chapters_read:0,num_volumes_read:0,score:0,status:"plan_to_read",tags:[]}:this.animeInfo.my_list_status={is_rewatching:!1,num_watched_episodes:0,score:0,status:"plan_to_watch",tags:[]}),this.animeInfo.my_list_status&&void 0!==this.animeInfo.my_list_status.num_episodes_watched&&(this.animeInfo.my_list_status.num_watched_episodes=this.animeInfo.my_list_status.num_episodes_watched,delete this.animeInfo.my_list_status.num_episodes_watched)}))}async _sync(){void 0===this.animeInfo.my_list_status.start_date&&1===this._getStatus()&&this._getEpisode()>0&&(this.animeInfo.my_list_status.start_date=(0,Ce.returnYYYYMMDD)()),void 0===this.animeInfo.my_list_status.finish_date&&2===this._getStatus()&&(this.animeInfo.my_list_status.finish_date=(0,Ce.returnYYYYMMDD)(),void 0===this.animeInfo.my_list_status.start_date&&(this.animeInfo.my_list_status.start_date=(0,Ce.returnYYYYMMDD)()));const t={};for(const e in this.animeInfo.my_list_status)switch(e){case"priority":case"num_watched_episodes":case"num_volumes_read":case"num_chapters_read":case"score":case"is_rewatching":case"is_rereading":case"num_times_rewatched":case"num_times_reread":case"rewatch_value":case"reread_value":case"tags":case"comments":case"status":case"start_date":case"finish_date":t[e]=this.animeInfo.my_list_status[e]}return this.logger.m("Sync").log(this.ids.mal,t),this.apiCall({type:"PUT",path:`${this.type}/${this.ids.mal}/my_list_status`,dataObj:t}).then((t=>{this.logger.m("Sync").log("res",t)}))}_delete(){return this.apiCall({type:"DELETE",path:`${this.type}/${this.ids.mal}/my_list_status`})}async fillRelations(){const t=new $(`fillRelations/${this.ids.mal}/${this.getType()}`,6048e5);return t.hasValueAndIsNotEmpty().then((e=>e?t.getValue().then((t=>{t&&t.da&&parseInt(t.da)&&(this.ids.ani=parseInt(t.da))})):function(t,e){const n={id:t,type:e.toUpperCase()};return ct.request.xhr("POST",{url:"https://graphql.anilist.co",headers:{"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify({query:"\n  query ($id: Int, $type: MediaType) {\n    Media (idMal: $id, type: $type) {\n      id\n      idMal\n    }\n  }\n  ",variables:n})}).then((t=>{if(404===t.status)return NaN;const e=z(t.responseText);return lt.log(e),e.data.Media.id}))}(this.ids.mal,this.getType()).then((e=>(e&&parseInt(e)&&(this.ids.ani=parseInt(e)),t.setValue({da:e}))))))}};var De=n(986);const Ke={ui:{module:"input",pattern:"^([0-9]{1,2}|100)$"},getOptions(){const t=[{value:0,label:De.storage.lang("UI_Score_Not_Rated")}];for(let e=1;e<101;e++)t.push({value:e,label:String(e)});return t},valueToOptionValue:t=>t?Number(t):0,optionValueToValue:t=>t?Number(t):0};var Ue=n(986);const Fe={ui:{module:"click",type:"smiley"},getOptions:()=>[{value:0,label:Ue.storage.lang("UI_Score_Not_Rated")},{value:85,label:"🙂"},{value:60,label:"😐"},{value:35,label:"🙁"}],valueToOptionValue:t=>t?t>=73?85:t<=47?35:60:0,optionValueToValue:t=>t?Number(t):0};var Be=n(986);const qe={ui:{module:"click",type:"star"},getOptions:()=>[{value:0,label:Be.storage.lang("UI_Score_Not_Rated")},{value:90,label:"★★★★★"},{value:70,label:"★★★★"},{value:50,label:"★★★"},{value:30,label:"★★"},{value:10,label:"★"}],valueToOptionValue:t=>t?t<20?10:t<40?30:t<60?50:t<80?70:90:0,optionValueToValue:t=>t?Number(t):0};var Ve=n(986);const Ge={ui:{module:"input",pattern:"^([0-9](\\.[0-9]?)?|10(.0)?)$"},getOptions(){const t=[{value:0,label:Ve.storage.lang("UI_Score_Not_Rated")}];for(let e=1;e<101;e++)t.push({value:e/10,label:(e/10).toFixed(1)});return t},valueToOptionValue:t=>t?Number(t/10):0,optionValueToValue:t=>t?Number(10*t):0};var We=n(812),ze=n(994),He=n(986);class Xe extends Ae{constructor(t){return super(t),this.url=t,this.displayUrl="",this.shortName="AniList",this.authenticationUrl="https://anilist.co/api/v2/oauth/authorize?client_id=1487&response_type=token",this.logger=We.m(this.shortName,"#3db4f2"),this}handleUrl(t){if(t.match(/anilist\.co\/(anime|manga)\/\d*/i))return this.type="anime"===ze.urlPart(t,3)?"anime":"manga",void(this.ids.ani=Number(ze.urlPart(t,4)));if(t.match(/myanimelist\.net\/(anime|manga)\/\d*/i))return this.type="anime"===ze.urlPart(t,3)?"anime":"manga",void(this.ids.mal=Number(ze.urlPart(t,4)));throw new q(t)}getCacheKey(){return this.getKey(["ANILIST"])}getPageId(){return this.ids.ani}_getStatus(){return parseInt(pt[this.animeInfo.mediaListEntry.status])}_setStatus(t){this.animeInfo.mediaListEntry.status=pt[t]}_getScore(){if(0===Number(this.animeInfo.mediaListEntry.score))return 0;const t=Math.round(Number(this.animeInfo.mediaListEntry.score)/10);return 0===t?1:t}_setScore(t){this.animeInfo.mediaListEntry.score=10*t}_getAbsoluteScore(){return Number(this.animeInfo.mediaListEntry.score)}_setAbsoluteScore(t){this.animeInfo.mediaListEntry.score=Number(t)}_getEpisode(){return this.animeInfo.mediaListEntry.progress}_setEpisode(t){this.animeInfo.mediaListEntry.progress=parseInt(`${t}`)}_getVolume(){return this.animeInfo.mediaListEntry.progressVolumes}_setVolume(t){this.animeInfo.mediaListEntry.progressVolumes=t}_getTags(){let t=this.animeInfo.mediaListEntry.notes;return null!==t&&"null"!==t||(t=""),t}_setTags(t){this.animeInfo.mediaListEntry.notes=t}_getTitle(){return this.animeInfo.title.userPreferred}_getTotalEpisodes(){const t=this.animeInfo.episodes?this.animeInfo.episodes:this.animeInfo.chapters;return null===t?0:t}_getTotalVolumes(){return this.animeInfo.volumes||0}_getDisplayUrl(){return""!==this.displayUrl&&null!==this.displayUrl?this.displayUrl:this.url}_getImage(){return gt(this.animeInfo.coverImage.large)}_getRating(){return Promise.resolve(this.animeInfo.averageScore)}async _update(){let t=this.ids.mal,e="idMal";Number.isNaN(this.ids.mal)&&(t=this.ids.ani,e="id");const n=`\n    query ($id: Int, $type: MediaType) {\n      Media (${e}: $id, type: $type) {\n        id\n        idMal\n        siteUrl\n        episodes\n        chapters\n        volumes\n        averageScore\n        coverImage{\n          large\n        }\n        title {\n          userPreferred\n        }\n        mediaListEntry {\n          id\n          status\n          progress\n          progressVolumes\n          score(format: POINT_100)\n          repeat\n          notes\n        }\n      }\n    }\n    `,r={id:t,type:this.type.toUpperCase()};return this._authenticated=!0,this.apiCall(n,r).catch((t=>{if(t instanceof B)return this._authenticated=!1,this.apiCall(n,r,!1);throw t})).then((t=>{if(this.logger.log("[SINGLE]","Data",t),this.animeInfo=t.data.Media,this.ids.ani=this.animeInfo.id,Number.isNaN(this.ids.mal)&&this.animeInfo.idMal&&(this.ids.mal=this.animeInfo.idMal),this.displayUrl=this.animeInfo.siteUrl,this._onList=!0,null===this.animeInfo.mediaListEntry&&(this._onList=!1,this.animeInfo.mediaListEntry={notes:"",progress:0,progressVolumes:0,repeat:0,score:0,status:"PLANNING"}),!this._authenticated)throw new B("Not Authenticated")}))}async _sync(){let t="\n      mutation ($mediaId: Int, $status: MediaListStatus, $progress: Int, $scoreRaw: Int, $notes: String) {\n        SaveMediaListEntry (mediaId: $mediaId, status: $status, progress: $progress, scoreRaw: $scoreRaw, notes: $notes) {\n          id\n          status\n          progress\n        }\n      }\n    ";const e={mediaId:this.ids.ani,status:this.animeInfo.mediaListEntry.status,progress:this.animeInfo.mediaListEntry.progress,scoreRaw:this.animeInfo.mediaListEntry.score,notes:this.animeInfo.mediaListEntry.notes,volumes:null};return"manga"===this.type&&(t="\n        mutation ($mediaId: Int, $status: MediaListStatus, $progress: Int, $scoreRaw: Int, $notes: String, $volumes: Int) {\n          SaveMediaListEntry (mediaId: $mediaId, status: $status, progress: $progress, scoreRaw: $scoreRaw, notes: $notes, progressVolumes: $volumes) {\n            id\n            status\n            progress\n            progressVolumes\n          }\n        }\n      ",e.volumes=this.animeInfo.mediaListEntry.progressVolumes),this.apiCall(t,e).then((t=>(t&&t.data&&t.data.SaveMediaListEntry&&t.data.SaveMediaListEntry.id&&(this.animeInfo.mediaListEntry.id=t.data.SaveMediaListEntry.id),t)))}apiCall(t,e,n=!0){return mt(t,e,n)}getScoreMode(){switch(He.settings.get("anilistOptions").scoreFormat){case"POINT_100":return Ke;case"POINT_3":return Fe;case"POINT_5":return qe;case"POINT_10_DECIMAL":return Ge;default:return Le}}_delete(){const t={mediaId:this.animeInfo.mediaListEntry.id};return this.apiCall("\n      mutation ($mediaId: Int) {\n        DeleteMediaListEntry(id: $mediaId) {\n          deleted\n        }\n      }\n    ",t)}}var Ye=n(986);const Je={ui:{module:"dropdown"},getOptions(){const t=[{value:0,label:Ye.storage.lang("UI_Score_Not_Rated")}];for(let e=2;e<21;e++)t.push({value:5*e,label:(e/2).toFixed(1).toString()});return t},valueToOptionValue:t=>t?t<10?10:5*Math.round(Number(t)/5):0,optionValueToValue:t=>t?Number(t):0};var Qe=n(986);const Ze={ui:{module:"click",type:"smiley"},getOptions:()=>[{value:0,label:Qe.storage.lang("UI_Score_Not_Rated")},{value:100,label:"😀"},{value:70,label:"🙂"},{value:40,label:"😐"},{value:10,label:"🙁"}],valueToOptionValue:t=>t?t<25?10:t<55?40:t<85?70:100:0,optionValueToValue:t=>t?Number(t):0};var tn=n(986);const en={ui:{module:"dropdown"},getOptions(){const t=[{value:0,label:tn.storage.lang("UI_Score_Not_Rated")}];for(let e=1;e<11;e++)t.push({value:10*e,label:(e/2).toFixed(1).toString()});return t},valueToOptionValue:t=>t?t<10?10:10*Math.round(t/10):0,optionValueToValue:t=>t?Number(t):0};var nn=n(812),rn=n(994),sn=n(986);class an extends Ae{constructor(t){return super(t),this.url=t,this.shortName="Kitsu",this.authenticationUrl="https://kitsu.app/404?mal-sync=authentication",this.logger=nn.m(this.shortName,"#d65e43"),this}listI(){return this.animeInfo.data[0]}animeI(){return this.animeInfo.included[0]}handleUrl(t){if(t.match(/kitsu\.app\/(anime|manga)\/.*/i))return this.type="anime"===rn.urlPart(t,3)?"anime":"manga",void(this.ids.kitsu.slug=rn.urlPart(t,4));if(t.match(/myanimelist\.net\/(anime|manga)\/\d*/i))return this.type="anime"===rn.urlPart(t,3)?"anime":"manga",void(this.ids.mal=Number(rn.urlPart(t,4)));throw new q(t)}getCacheKey(){return this.getKey(["KITSU"])}getPageId(){return this.ids.kitsu.id}_getStatus(){return this.listI().attributes.reconsuming&&"current"===this.listI().attributes.status?23:parseInt(It(this.listI().attributes.status))}_setStatus(t){23===t?(t=1,this.listI().attributes.reconsuming=!0):this.listI().attributes.reconsuming=!1,this.listI().attributes.status=It(t,parseInt(t.toString()))}_getScore(){if(!this.listI().attributes.ratingHundred)return 0;const t=Math.round(this.listI().attributes.ratingHundred/10);return 0===t?1:t}_setScore(t){this.listI().attributes.ratingHundred=t?10*t:null}_getAbsoluteScore(){return Number(this.listI().attributes.ratingHundred)}_setAbsoluteScore(t){this.listI().attributes.ratingHundred=Number(t)}_getTwentyScore(){const t=this.listI().attributes.ratingHundred;return t?t<5?1:Math.round(t/5):null}_getEpisode(){return this.listI().attributes.progress}_setEpisode(t){this.listI().attributes.progress=parseInt(`${t}`)}_getVolume(){return this.listI().attributes.volumesOwned}_setVolume(t){this.listI().attributes.volumesOwned=t}_getTags(){let t=this.listI().attributes.notes;return null!==t&&"null"!==t||(t=""),t}_setTags(t){this.listI().attributes.notes=t}_getTitle(){try{return St(this.animeI().attributes.titles,this.animeI().attributes.canonicalTitle)}catch(t){return console.error("title",t),"Failed"}}_getTotalEpisodes(){const t=this.animeI().attributes.episodeCount?this.animeI().attributes.episodeCount:this.animeI().attributes.chapterCount;return null===t?0:t}_getTotalVolumes(){return this.animeI().attributes.volumeCount||0}_getDisplayUrl(){return`https://kitsu.app/${this.getType()}/${this.animeI().attributes.slug}`}_getImage(){return this.animeI().attributes.posterImage&&this.animeI().attributes.posterImage.large?this.animeI().attributes.posterImage.large:""}_getRating(){return null===this.animeI().attributes.averageRating?Promise.resolve(""):Promise.resolve(`${this.animeI().attributes.averageRating}%`)}async _update(){if(Number.isNaN(this.ids.mal)){var t=await this.kitsuSlugtoKitsu(this.ids.kitsu.slug,this.getType());try{this.ids.kitsu.id=Number(t.res.data[0].id),this.ids.mal=Number(t.malId)}catch(t){throw this._authenticated=!0,new G("Not found")}}if(Number.isNaN(this.ids.kitsu.id)){var e=await this.malToKitsu(this.ids.mal,this.getType());try{const t=e.data.find((t=>t.relationships.item.data.type===this.getType()));if(!t)throw new G("Not found");this.ids.kitsu.id=Number(t.relationships.item.data.id)}catch(t){throw this._authenticated=!0,new G(`No entry found for malId ${this.ids.mal}`)}}return this._authenticated=!0,this.userId().then((t=>this.apiCall("GET",`https://kitsu.app/api/edge/library-entries?filter[user_id]=${t}&filter[kind]=${this.getType()}&filter[${this.getType()}_id]=${this.ids.kitsu.id}&page[limit]=1&page[limit]=1&include=${this.getType()}&fields[${this.getType()}]=slug,titles,canonicalTitle,averageRating,posterImage,${"anime"===this.getType()?"episodeCount":"chapterCount,volumeCount"}`))).catch((t=>{if(t instanceof B)return this._authenticated=!1,{data:[],included:[]};throw t})).then((async n=>{const r=n;this._onList=!0,n.data.length||(this._onList=!1,r.data[0]={attributes:{notes:"",progress:0,volumesOwned:0,reconsuming:!1,reconsumeCount:!1,ratingTwenty:null,status:"planned"}},void 0!==e?r.included=e.included:t?r.included=t.res.data:(e=await this.malToKitsu(this.ids.mal,this.getType()),r.included=e.included)),r.data[0].attributes.ratingHundred?r.data[0].attributes.ratingHundred=0:r.data[0].attributes.ratingHundred=Number(5*r.data[0].attributes.ratingTwenty),this.animeInfo=r;try{this.animeI()}catch(t){throw this.logger.error(t),new G("Not found")}if(!this._authenticated)throw new B("Not Authenticated")}))}async _sync(){const t={data:{attributes:{notes:this.listI().attributes.notes,progress:this.listI().attributes.progress,volumesOwned:this.listI().attributes.volumesOwned,reconsuming:this.listI().attributes.reconsuming,reconsumeCount:this.listI().attributes.reconsumeCount,ratingTwenty:this._getTwentyScore(),status:this.listI().attributes.status},type:"library-entries"}},e=this.getType();if(!e)return Promise.resolve();let n,r;return this.isOnList()?(n=`https://kitsu.app/api/edge/library-entries/${this.listI().id}`,t.data.id=this.listI().id,r="PATCH"):(n="https://kitsu.app/api/edge/library-entries/",t.data.relationships={[e]:{data:{type:e,id:this.ids.kitsu.id}},user:{data:{type:"users",id:await this.userId()}}},r="POST"),this.logger.log(r,t),this.apiCall(r,n,t).then((t=>(t&&t.data&&t.data.id&&(this.listI().id=t.data.id),t)))}apiCall(t,e,n={},r=!0){return Tt(t,e,n,r).catch((t=>{if(t instanceof B)throw new B(t.message);throw t}))}kitsuSlugtoKitsu(t,e){return this.apiCall("GET",`https://kitsu.app/api/edge/${e}?filter[slug]=${t}&page[limit]=1&include=mappings`,{}).catch((n=>{if(n instanceof B)return this._authenticated=!1,this.apiCall("GET",`https://kitsu.app/api/edge/${e}?filter[slug]=${t}&page[limit]=1&include=mappings`,{},!1);throw n})).then((t=>{let n=NaN;if(void 0!==t&&void 0!==t.included)for(let r=0;r<t.included.length;r++){const i=t.included[r];if("mappings"===i.type){if(i.attributes.externalSite===`myanimelist/${e}`){n=Number(i.attributes.externalId),t.included.splice(r,1);break}i.attributes.externalSite===`anilist/${e}`&&(this.ids.ani=Number(i.attributes.externalId))}}return{res:t,malId:n}}))}malToKitsu(t,e){return this.apiCall("GET",`https://kitsu.app/api/edge/mappings?filter[externalSite]=myanimelist/${e}&filter[externalId]=${t}&include=item&fields[item]=id`,{}).catch((n=>{if(n instanceof B)return this._authenticated=!1,this.apiCall("GET",`https://kitsu.app/api/edge/mappings?filter[externalSite]=myanimelist/${e}&filter[externalId]=${t}&include=item&fields[item]=id`,{},!1);throw n})).then((t=>t))}async userId(){const t=await sn.storage.get("kitsuUserId");return void 0!==t&&t?t:this.apiCall("GET","https://kitsu.app/api/edge/users?filter[self]=true").then((t=>{if(void 0===t.data||!t.data.length||void 0===t.data[0])throw new B("Not Authenticated");return sn.storage.set("kitsuUserId",t.data[0].id),t.data[0].id}))}getScoreMode(){switch(sn.settings.get("kitsuOptions").ratingSystem){case"simple":return Ze;case"regular":return en;case"advanced":return Je;default:return Le}}_delete(){return this.apiCall("DELETE",`https://kitsu.app/api/edge/library-entries/${this.listI().id}`)}}var on=n(812),un=n(994);class ln extends Ae{constructor(t){return super(t),this.url=t,this.episodeUpdate=!1,this.statusUpdate=!1,this.ratingUpdate=!1,this.minWatchedEp=1,this.curWatchedEp=0,this.shortName="Simkl",this.authenticationUrl=At(),this.rewatchingSupport=!1,this.syncList=Dt,this.getSingle=Kt,this.call=Ut,this.errorHandling=Ft,this.logger=on.m(this.shortName,"#9b7400"),this}handleUrl(t){if(t.match(/simkl\.com\/(anime|manga)\/\d*/i)){if(this.type="anime"===un.urlPart(t,3)?"anime":"manga",this.ids.simkl=parseInt(un.urlPart(t,4)),"manga"===this.type)throw"Simkl has no manga support"}else{if(!t.match(/myanimelist\.net\/(anime|manga)\/\d*/i))throw new q(t);if(this.type="anime"===un.urlPart(t,3)?"anime":"manga",this.ids.mal=Number(un.urlPart(t,4)),"manga"===this.type)throw"Simkl has no manga support"}}getCacheKey(){return this.getKey(["SIMKL"])}getPageId(){return this.ids.simkl}_getStatus(){return parseInt(Ct(this.animeInfo.status))}_setStatus(t){23===t&&(t=1),(t=Ct(t,parseInt(t.toString())))!==this.animeInfo.status&&(this.statusUpdate=!0),this.animeInfo.status=t}_getScore(){const t=this.animeInfo.user_rating;return null===t?0:t}_setScore(t){0===t&&(t=null),t!==this.animeInfo.user_rating&&(this.ratingUpdate=!0),this.animeInfo.user_rating=t}_getAbsoluteScore(){return 10*this.getScore()}_setAbsoluteScore(t){t?t<10?this.setScore(1):this.setScore(Math.round(t/10)):this.setScore(0)}_getEpisode(){return 2===this._getStatus()?this._getTotalEpisodes():this.curWatchedEp}_setEpisode(t){t!==this.curWatchedEp&&(this.episodeUpdate=!0),this.curWatchedEp=t}_getVolume(){return 0}_setVolume(t){this.logger.error("You cant set Volumes for animes")}_getTags(){let t=this.animeInfo.private_memo;return null!==t&&"null"!==t||(t=""),t}_setTags(t){this.animeInfo.private_memo=t}_getTitle(){return this.animeInfo.show.title}_getTotalEpisodes(){const t=this.animeInfo.total_episodes_count;return null===t?0:t}_getTotalVolumes(){return 0}_getDisplayUrl(){return`https://simkl.com/${this.getType()}/${this.ids.simkl}`}_getImage(){return`https://simkl.in/posters/${this.animeInfo.show.poster}_ca.jpg`}async _getRating(){try{return(await this.call("https://api.simkl.com/ratings",{simkl:this.ids.simkl},!0)).simkl.rating}catch(t){return this.logger.error(t),"N/A"}}async _update(){let t;return t=Number.isNaN(this.ids.mal)?{simkl:this.ids.simkl}:{mal:this.ids.mal},this._authenticated=!0,this.getSingle(t).catch((t=>{if(t instanceof B)return this._authenticated=!1,"";throw t})).then((async e=>{if(this.logger.log(e),this.episodeUpdate=!1,this.statusUpdate=!1,this.ratingUpdate=!1,this.animeInfo=e,this._onList=!0,!this.animeInfo){let e;if(this._onList=!1,t.simkl){if(e=await this.call(`https://api.simkl.com/anime/${t.simkl}`,{extended:"full"},!0),!e)throw new G("Anime not found")}else{if(e=await this.call("https://api.simkl.com/search/id",t,!0),!e)throw new G("Anime not found");if(e[0].mal&&e[0].mal.type&&"Special"===e[0].mal.type)throw new Error("Is a special");e=e[0]}this.animeInfo={last_watched:"",last_watched_at:"",next_to_watch:"",not_aired_episodes_count:0,private_memo:"",status:"plantowatch",total_episodes_count:0,user_rating:null,watched_episodes_count:0,show:e},this.logger.log("Add anime",this.animeInfo)}if(Number.isNaN(this.ids.simkl)&&(this.ids.simkl=parseInt(this.animeInfo.show.ids.simkl)),Number.isNaN(this.ids.mal)&&void 0!==this.animeInfo.show.ids.mal&&(this.ids.mal=this.animeInfo.show.ids.mal),this.curWatchedEp=Mt(this.animeInfo.last_watched),!this.curWatchedEp&&this.animeInfo.next_to_watch){const t=Mt(this.animeInfo.next_to_watch);t&&(this.curWatchedEp=t-1)}if(this.minWatchedEp=this.curWatchedEp+1,!this._authenticated)throw new B("Not Authenticated")}))}async _sync(){if(this.logger.log("[SET] Object:",this.animeInfo,"status",this.statusUpdate,"episode",this.episodeUpdate,"rating",this.ratingUpdate,"minWatchedEp",this.minWatchedEp,"curWatchedEp",this.curWatchedEp),this.statusUpdate||!this.isOnList()){const t=await this.call("https://api.simkl.com/sync/add-to-list",JSON.stringify({shows:[{to:this.animeInfo.status,ids:{simkl:this.ids.simkl}}]}),!1,"POST");this.logger.log("Status response",t)}if(this.episodeUpdate||!this.isOnList()){const t=this.curWatchedEp,e=[];if(this.minWatchedEp<=t){if(t){for(let n=this.minWatchedEp;n<=t;n++)e.push({number:n});const n=await this.call("https://api.simkl.com/sync/history",JSON.stringify({shows:[{ids:{simkl:this.ids.simkl},private_memo:this.animeInfo.private_memo,seasons:[{number:1,episodes:e}]}]}),!1,"POST");this.logger.log("Episode response",n)}}else{for(let n=this.minWatchedEp-1;n>t;n-=1)e.push({number:n});const n=await this.call("https://api.simkl.com/sync/history/remove",JSON.stringify({shows:[{ids:{simkl:this.ids.simkl},seasons:[{number:1,episodes:e}]}]}),!1,"POST");this.logger.log("Episode remove response",n)}this.minWatchedEp=t+1}if(this.ratingUpdate)if(this.animeInfo.user_rating){const t=await this.call("https://api.simkl.com/sync/ratings",JSON.stringify({shows:[{rating:this.animeInfo.user_rating,ids:{simkl:this.ids.simkl}}]}),!1,"POST");this.logger.log("Rating response",t)}else{const t=await this.call("https://api.simkl.com/sync/ratings/remove",JSON.stringify({shows:[{ids:{simkl:this.ids.simkl}}]}),!1,"POST");this.logger.log("Rating remove response",t)}this.episodeUpdate=!1,this.statusUpdate=!1,this.ratingUpdate=!1}_delete(){return this.call("https://api.simkl.com/sync/history/remove",JSON.stringify({shows:[{ids:{simkl:this.ids.simkl}}]}),!1,"POST")}}var cn=n(994),hn=n(812),dn=n(986);function pn(t){if(cn.isDomainMatching(t,"anilist.co"))return"ANILIST";if(cn.isDomainMatching(t,"kitsu.app"))return"KITSU";if(cn.isDomainMatching(t,"myanimelist.net"))return"MAL";if(cn.isDomainMatching(t,"simkl.com"))return"SIMKL";throw"Type not found"}function fn(t,e,n=!1){for(let r=0;r<t.length;r++){const i=t[r];let s=e[i.malId];void 0===s&&(s={diff:!1,master:{},slaves:[]}),n?s.master=i:(i.diff={},s.slaves.push(i)),!Number.isNaN(i.malId)&&i.malId&&(e[i.malId]=s)}}function mn(t,e){if(t.master&&t.master.uid)for(let e=0;e<t.slaves.length;e++){const n=t.slaves[e];n.watchedEp!==t.master.watchedEp&&(2===t.master.status?n.watchedEp!==n.totalEp&&(t.diff=!0,n.diff.watchedEp=n.totalEp):(t.diff=!0,n.diff.watchedEp=t.master.watchedEp)),n.status!==t.master.status&&(t.diff=!0,n.diff.status=t.master.status),n.score!==t.master.score&&(t.diff=!0,n.diff.score=t.master.score)}}function gn(t,e,n,r){if(t.master&&t.master.uid){const r=[];r.push(pn(t.master.url));for(let e=0;e<t.slaves.length;e++){const n=t.slaves[e];r.push(pn(n.url))}for(const i in n){const s=n[i];r.includes(s)||e.push({title:t.master.title,syncType:s,malId:t.master.malId,watchedEp:t.master.watchedEp,score:t.master.score,status:t.master.status,url:`https://myanimelist.net/${t.master.type}/${t.master.malId}`,error:null})}}}async function yn(t){for(let e=0;e<t.slaves.length;e++){const n=t.slaves[e];hn.log("sync list item",n),await _n(n,pn(n.url))}}async function vn(t){return t.diff={watchedEp:t.watchedEp,status:t.status,score:t.score},_n(t,t.syncType)}function _n(t,e){if(0!==Object.keys(t.diff).length){let n;if("MAL"===e)n=new je(t.url);else if("ANILIST"===e)n=new Xe(t.url);else if("KITSU"===e)n=new an(t.url);else{if("SIMKL"!==e)throw"No sync type";n=new ln(t.url)}return n.update().then((()=>(void 0!==t.diff.watchedEp&&n.setEpisode(t.diff.watchedEp),void 0!==t.diff.status&&n.setStatus(t.diff.status),void 0!==t.diff.score&&n.setScore(t.diff.score),n.sync()))).then((()=>cn.wait(3e3))).catch((async t=>{throw await cn.wait(3e3),t}))}}function bn(t,e){const n=new t(7,e);return n.getCompleteList().then((t=>t)).catch((t=>{throw hn.m(n.name).error(t),n.errorMessage(t)}))}const wn={isEnabled:async()=>dn.storage.get("backgroundListSync").then((async function(t){return hn.info("background list sync state",t),!(!t||t.mode!==await dn.settings.getAsync("syncMode"))||(wn.disable(),!1)})),enable:async()=>dn.storage.set("backgroundListSync",{mode:await dn.settings.getAsync("syncMode")}),disable:()=>dn.storage.remove("backgroundListSync"),async sync(){return await wn.isEnabled()?(hn.log("Start Background list Sync"),En("♻"),t("anime").then((()=>t("manga"))).then((()=>{En("")})).catch((t=>{hn.error(t),En("")}))):(hn.error("Background list Sync not allowed"),[]);async function t(t){const e={},n=[],r=[{providerType:"MAL",providerSettings:(i={mal:{text:"Init",list:null,master:!1},anilist:{text:"Init",list:null,master:!1},kitsu:{text:"Init",list:null,master:!1},simkl:{text:"Init",list:null,master:!1}}).mal,listProvider:ut},{providerType:"ANILIST",providerSettings:i.anilist,listProvider:_t},{providerType:"KITSU",providerSettings:i.kitsu,listProvider:Lt},{providerType:"SIMKL",providerSettings:i.simkl,listProvider:Vt}];var i;const s=await async function(t,e,n){const r=[],i=I(e),s="MALAPI"===i?"MAL":i,a=[];t.forEach((t=>{t.providerSettings.text="Loading",a.push(n(t.listProvider,e).then((e=>{t.providerSettings.list=e,t.providerSettings.text="Done",s===t.providerType&&(t.providerSettings.master=!0),r.push(t.providerType)})).catch((e=>{t.providerSettings.text=e})))})),await Promise.all(a);let o=!1;const u=[];return t.forEach((function(t){t.providerSettings.master?o=t.providerSettings.list:null!==t.providerSettings.list&&u.push(t.providerSettings.list)})),{master:o,slaves:u,typeArray:r}}(r,t,bn);!function(t,e,n,r,i,s){fn(t,i,!0);for(const t in e)fn(e[t],i,!1);for(const t in i)mn(i[t]),gn(i[t],s,r)}(s.master,s.slaves,0,s.typeArray,e,n),hn.log("Start syncing",e,n),await async function(t,e){for(const e in t){const n=t[e];if(n.diff)try{await yn(n),n.diff=!1}catch(t){hn.error(t)}}const n=e.slice();for(const t in n){const r=n[t];hn.log("Sync missing",r),await vn(r).then((()=>{e.splice(e.indexOf(r),1)})).catch((t=>{hn.error("Error",t),r.error=t}))}}(e,n)}}};function En(t){if("userscript"!==dn.type)try{chrome.action.setBadgeText({text:t})}catch(t){hn.error(t)}}var In=n(986);class Sn{constructor(){this.timer=null}start(){"webextension"===In.type&&(this.timer=setInterval(chrome.runtime.getPlatformInfo,2e4))}stop(){"webextension"===In.type&&clearInterval(this.timer)}}var kn=n(986),Tn=n(812),xn=n(986),$n=n(812),Ln=n(994);async function On(t,e){const n=$n.m("release").m(e);return n.log("Start",e,t),(await de(t,e)).getCompleteList().then((async t=>{if(t.length>0)try{await async function(t,e,n=$n.m("release")){if(t?t.forEach((t=>{let e=t.options.p;e||(e="default"),n.m(t.apiCacheKey).log(t.title,t.cacheKey,t.apiCacheKey,`Mode: ${e}`)})):n.log("No MAL Id List"),!xn.settings.get("epPredictions"))return void n.log("epPredictions disabled");const r=[];await async function(t,e){for(let n=0;n<t.length;n++)await e(t[n],n,t)}(t,(async t=>{if(!t.apiCacheKey)return;const i=await xn.storage.get(`release/${e}/${t.cacheKey}`);i&&i.value&&(t.fn.progress=i.value);let s=t.options.p;s||(s="default"),n.m(t.apiCacheKey).m("Load").log(i),i&&i.mode&&i.mode!==s?r.push(t):i&&i.timestamp&&Date.now()-i.timestamp<12e4?n.m(t.apiCacheKey).log("Up to date"):i&&i.finished&&i.timestamp&&Date.now()-i.timestamp<6048e5?n.m(t.apiCacheKey).log("Fininshed"):i&&!i.value&&i.timestamp&&Date.now()-i.timestamp<864e5?n.m(t.apiCacheKey).log("Nulled"):r.push(t)}));let i=[];r.length>0&&(i=await async function(t,e){if(null===e)return[];if(e.length<=0)return[];const n=e.map((t=>t.apiCacheKey)),r=[];for(let e=0;e<=n.length;){const i=n.slice(e,e+49),s={url:`https://api.malsync.moe/nc/mal/${t}/POST/pr`,data:JSON.stringify({malids:i}),headers:{"Content-Type":"application/json"}};await O.wait(5e3);const a=await L.request.xhr("POST",s);r.push(JSON.parse(a.responseText)),e+=50}return r.reduce(((t,e)=>t.concat(e)),[])}(e,r),await Ln.wait(500)),i.forEach((async t=>{const i=r.find((e=>t.malid===e.apiCacheKey));if(!i)return;n.m(i.malId).log(t.data);let s=i.options.p;s||(s="default");const a=A(t.data,s,e);a||n.m(i.malId).log("No value for the selected mode");let o=!1;a&&a.state&&"complete"===a.state&&(o=!0),n.m(i.malId).m("Save").log(a),i.cacheKey&&(i&&i.fn&&i.fn.progress&&C(i,i.fn.progress,a,e),await xn.storage.set(`release/${e}/${i.cacheKey}`,{timestamp:Date.now(),value:a,mode:s,finished:o}))}))}(t,e,n)}catch(t){n.error(t)}})).catch((t=>{n.error(t)}))}function Pn(t){if("userscript"!==xn.type)try{chrome.action.setBadgeText({text:t})}catch(t){$n.error(t)}}var Nn=n(812),An=n(986);let Cn=0;function Rn(t,e){return Cn?Promise.resolve():(Nn.info("Save",t,"in sync list [",e,"]"),An.storage.get("list-tagSettings").then((n=>{try{if(n=JSON.parse(n),!Array.isArray(n))throw"Not an array"}catch(t){n=[]}for(n.push({key:t,value:e,timestamp:(new Date).getTime()});n.length>50;)n=n.shift();return An.storage.set("tm-list-tagSettings",(new Date).getTime()),Cn=1,An.storage.set("list-tagSettings",JSON.stringify(n)).then((()=>{Cn=0})).catch((t=>{Nn.error(t),Cn=0}))})))}function Mn(){Cn=1,Nn.info("Import sync list");let t=0;return An.storage.get("list-tagSettings").then((async e=>{try{e=JSON.parse(e)}catch(t){e=[]}let n=await An.storage.get("tm-list-tagSettings");n||(n=2);for(const r in e){const i=e[r];i.timestamp>n&&(Nn.info("Import",i.key,i.value),await An.storage.set(i.key,i.value),t++)}An.storage.set("tm-list-tagSettings",(new Date).getTime()),Nn.info("list imported",t),Cn=0})).catch((t=>{Nn.error(t),Cn=0}))}var jn=n(812);const Dn="https://raw.githubusercontent.com/MALSync/MALSync/master/assets/icons/icon128.png";async function Kn(t){t.image||(t.image=Dn),jn.m("Notification").log(t);const e=await Un(t.image),n={type:"basic",title:t.title,message:t.text,iconUrl:e,contextMessage:"MAL-Sync",requireInteraction:t.sticky??!1,eventTime:Date.now()};try{chrome.notifications.create(t.url,n)}catch(e){jn.error(e),delete n.requireInteraction,chrome.notifications.create(t.url,n)}}function Un(t,e=!1){return e&&(t=Dn),fetch(t).then((t=>{if(!t.ok)throw new Error("Could not get image");return t.blob()})).then((t=>function(t){return new Promise((e=>{const n=new FileReader;n.onloadend=()=>e(n.result),n.readAsDataURL(t)}))}(t))).catch((n=>{if(!e)return jn.info("Could not get image for notification",t),Un(t,!0);throw n}))}var Fn=n(986),Bn=n(994),qn=n(812);function Vn(t,e,n,r){switch(t.name){case"xhr":return Gn(t,e,n,r);case"videoTime":return function(t,e,n){chrome.tabs.sendMessage(e.tab.id,{action:"videoTime",item:t.item,sender:e})}(t,e);case"content":return function(t,e,n){chrome.tabs.sendMessage(e.tab.id,{action:"content",item:t.item,sender:e})}(t,e);case"videoTimeSet":return function(t,e,n){return t.sender?.tab?.id?void chrome.tabs.sendMessage(t.sender.tab.id,{action:"videoTimeSet",time:t.time,timeAdd:t.timeAdd},{frameId:t.sender.frameId}):void 0}(t);case"minimalWindow":return function(t,e,n){return Fn.storage.get("windowId").then((e=>{void 0===e&&(e=22),chrome.windows&&chrome.windows.update&&chrome.windows.create?chrome.windows.update(e,{focused:!0},(function(){if(chrome.runtime.lastError){const e={url:chrome.runtime.getURL("window.html"),type:"popup"};t.width&&(e.width=t.width),t.height&&(e.height=t.height),t.left&&(e.left=t.left),chrome.windows.create(e,(function(t){Fn.storage.set("windowId",t.id),n()}))}else n()})):chrome.tabs.update(e,{active:!0},(function(){if(chrome.runtime.lastError){const t={url:chrome.runtime.getURL("window.html"),active:!0};chrome.tabs.create(t,(function(t){Fn.storage.set("windowId",t.id),n()}))}}))})),!0}(t,0,n);case"emitter":return function(t,e,n){return chrome.runtime.sendMessage(t),void chrome.tabs.query({},(e=>{e.forEach((e=>{chrome.tabs.sendMessage(e.id,t)}))}))}(t);case"notification":return void Kn(t.options);case"database":return async function(t,e){switch(t){case"entry":return _e(),async function(t,e){return("anime"===t?ye.table("anime"):ye.table("manga")).get(e)}(e.type,e.id);case"entryByMalId":return _e(),async function(t,e){return("anime"===t?ye.table("anime"):ye.table("manga")).get({malId:e})}(e.type,e.id);default:throw`Unknown call "${t}"`}}(t.options.call,t.options.param).then((t=>n(t))),!0;default:throw new Error(`Unknown action: ${t.name}`)}}function Gn(t,e,n,r,i={try:0,date:new Date}){let s;const a={method:t.method,headers:[]};if("object"==typeof t.url){s=t.url.url,t.url.data&&(a.body=t.url.data);for(const e in t.url.headers)a.headers.push([e,t.url.headers[e]])}else s=t.url;return(Bn.isDomainMatching(s,"malsync.moe")||Bn.isDomainMatching(s,"simkl.com"))&&(a.headers.push(["version",Fn.storage.version()]),a.headers.push(["type","addon"])),fetch(s,a).then((async s=>{if(429===s.status){let a;if(a="content"===r?{timeout:3e4,tries:4,cutoff:18e4}:{timeout:3e5,tries:4,cutoff:18e5},i.try<a.tries&&!Bn.rateLimitExclude.test(s.url)&&(new Date).getTime()-i.date.getTime()<a.cutoff)return qn.error("RATE LIMIT"),setTimeout((()=>{i.try++,Gn(t,e,n,r,i),Fn.storage.set("rateLimit",!1)}),a.timeout),void("content"===r&&Fn.storage.set("rateLimit",!0))}"background"===r&&await Bn.wait(5e3);const a={finalUrl:s.url,responseText:await s.text(),status:s.status};n(a)})).catch((t=>{const e={finalUrl:"",responseText:t.message,status:0};n(e)})),!0}var Wn=n(580),zn=n.n(Wn),Hn=n(812),Xn=n(986),Yn=n(994);const Jn=/^(https?|wss?|file|ftp|\*):\/\/(\*|\*\.[^*/]+|[^*/]+)\/.*$|^file:\/\/\/.*$|^resource:\/\/(\*|\*\.[^*/]+|[^*/]+)\/.*$|^about:/,Qn=globalThis.navigator?.userAgent.includes("Firefox/"),Zn=Qn?/^(https?|wss?):[/][/][^/]+([/].*)?$/:/^https?:[/][/][^/]+([/].*)?$/,tr=/^(https?|file|ftp):[/]+/;function er(...t){return 0===t.length?/$./:t.includes("<all_urls>")?tr:t.includes("*://*/*")?Zn:new RegExp(t.map((t=>function(t){!function(t){if(!function(t){return"<all_urls>"===t||Jn.test(t)}(t))throw new Error(t+" is an invalid pattern, it must match "+String(Jn))}(t);let[,e,n="",r]=t.split(/(^[^:]+:[/][/])([^/]+)?/);return e=e.replace("*",Qn?"(https?|wss?)":"https?").replaceAll(/[/]/g,"[/]"),"*"===n?n="[^/]+":n&&(n=n.replace(/^[*][.]/,"([^/]+.)*").replaceAll(/[.]/g,"[.]").replace(/[*]$/,"[^.]+")),r=r.replaceAll(/[/]/g,"[/]").replaceAll(/[.]/g,"[.]").replaceAll(/[*]/g,".*"),"^"+e+n+"("+r+")?$"}(t))).join("|"))}var nr=n(812),rr=n(986);const ir=nr.m("Custom Domain");async function sr(){if(void 0===chrome.scripting)return void nr.error("Custom Domain is not possible");const t=await rr.settings.getAsync("customDomains");await chrome.scripting.unregisterContentScripts(),t&&await Promise.all(t.map(ar));const e=await chrome.scripting.getRegisteredContentScripts();ir.log(e)}async function ar(t){if("hostpermission"===t.page)return;const e=t.domain;try{const n={id:e,js:["vendor/jquery.min.js","i18n.js"],matches:[e],allFrames:!1,runAt:"document_start"};"iframe"===t.page?(n.js.push("content/iframe.js"),n.allFrames=!0):(n.js.push(`content/page_${t.page}.js`),n.js.push("content/content-script.js")),await chrome.scripting.registerContentScripts([n])}catch(t){return void ir.error(`Could not add listener for ${e}`,t)}ir.m("registred").m(t.page).log(e)}function or(t){const e=t.match(/^.+:\/\/?(.+)/);return e&&e.length>1?e[1].replace("*.","").replace(/(\/|\/?\*)$/,""):""}var ur=n(812);try{chrome.runtime.onStartup.addListener((()=>ur.log("Browser started")))}catch(t){ur.error(t)}try{chrome.runtime.onMessage.addListener(((t,e,n)=>Vn(t,e,n,"content"))),Fn.request.sendMessage=function(t){return new Promise(((e,n)=>{Vn(t,null,(function(t){e(t)}),"background")}))}}catch(t){ur.error(t)}try{!async function(){chrome.permissions.onAdded.addListener(sr),chrome.permissions.onRemoved.addListener(sr),rr.storage.storageOnChanged(((t,e)=>{"sync"===e&&t["settings/customDomains"]&&(ir.log("settings/customDomains changed"),sr())})),await sr(),ir.log("Initialed")}()}catch(t){ur.error(t)}try{Nn.info("SyncTags Loaded"),An.storage.storageOnChanged(((t,e)=>{if("local"===e)for(const e in t)/^tagSettings\//i.test(e)&&Rn(e,t[e].newValue);else for(const e in t)"list-tagSettings"!==e||Cn||Mn()})),Mn()}catch(t){ur.error(t)}try{!async function(){ge.log("Starting"),ye.version(1).stores({anime:"&uid, malId, cacheKey, title",manga:"&uid, malId, cacheKey, title",storage:"&key, value"}),b.on("update.*",(async t=>ve(t)),{objectify:!0}),b.on("state.*",(async t=>ve(t)),{objectify:!0}),b.on("delete.*",(async t=>{pe.log("delete",t),async function(t,e){("anime"===t?ye.table("anime"):ye.table("manga")).where("uid").equals(e).delete()}(t.type,t.id)}),{objectify:!0}),await _e(),ge.log("Ready")}()}catch(t){ur.error(t)}try{chrome.alarms.get("listSync",(async function(t){const e=await kn.storage.get("listSyncLast");void 0!==t&&Date.now()-e<828e5?Tn.log("listSync already set and on time",e,t):(t&&chrome.alarms.clear("listSync"),Tn.log("Create listSync Alarm",1380,e),chrome.alarms.create("listSync",{periodInMinutes:1380,when:Date.now()+1e3}))})),chrome.alarms.onAlarm.addListener((function(t){"listSync"===t.name&&(kn.storage.set("listSyncLast",Date.now()),kn.settings.init().then((async()=>{console.groupCollapsed("listSync");const t=new Sn;t.start(),wn.sync().finally((()=>{t.stop(),console.groupEnd()}))})))}))}catch(t){ur.error(t)}try{chrome.alarms.get("progressSync",(async t=>{const e=parseInt(await xn.settings.getAsync("progressInterval")),n=await xn.storage.get("progressSyncLast");if(!e)return $n.log("progressSync disabled",e),void(t&&chrome.alarms.clear("progressSync"));void 0!==t&&Date.now()-n<60*e*1e3?$n.log("progressSync already set and on time",n,t):(t&&chrome.alarms.clear("progressSync"),$n.log("Create progressSync Alarm",e,n),chrome.alarms.create("progressSync",{periodInMinutes:e,when:Date.now()+1e3}))})),chrome.alarms.onAlarm.addListener((t=>{"progressSync"===t.name&&(xn.storage.set("progressSyncLast",Date.now()),xn.settings.init().then((async()=>{console.groupCollapsed("Progress"),await async function(){const t=new Sn;t.start();try{if(Pn("⌛"),await xn.settings.init(),!xn.settings.get("epPredictions"))throw"epPredictions disabled";return await On(1,"anime"),await On(1,"manga"),xn.settings.get("loadPTWForProgress")&&(await On(6,"anime"),await On(6,"manga")),$n.log("Progress done"),Pn(""),t.stop(),!0}catch(t){$n.log("Progress Failed",t)}return Pn(""),t.stop(),!1}(),console.groupEnd()})))}))}catch(t){ur.error(t)}chrome.notifications.onClicked.addListener((function(t){chrome.tabs.create({url:t})})),chrome.runtime.onMessageExternal.addListener((function(t,e,n){return chrome.tabs.sendMessage(t.tab,{action:"presence",data:t.info},(function(t){n(t)})),!0})),chrome.runtime.onInstalled.addListener((async function(t){"install"===t.reason?chrome.tabs.create({url:chrome.runtime.getURL("install.html")},(function(t){ur.info("Open installPage")})):"update"===t.reason&&async function(t){if(!t)throw"No last Version";const e=Hn.m("Wizzard");e.log("Last version",t);const n=[{version:"0.7.8",name:"Set existing users to tags on",action:()=>Xn.storage.get("settings/malTags").then((t=>{void 0===t&&Xn.storage.set("settings/malTags",!0)}))},{version:"0.8.7",name:"Disable updateCheck",action:()=>Xn.storage.set("updateCheckTime",0)},{version:"0.8.8",name:"Reset to normal Mal api",action:()=>Xn.storage.get("settings/syncMode").then((t=>{"MALAPI"===t&&Xn.storage.set("settings/syncMode","MAL")}))},{version:"0.8.9",name:"Disable updateCheck",action:()=>Xn.storage.set("updateCheckTime",0)},{version:"0.8.12",name:"Clean up sync storage",action:()=>Xn.storage.list("sync").then((t=>{const n=Object.keys(t).filter((t=>!Yn.syncRegex.test(t)));e.log("Delete",n),n.length&&chrome.storage.sync.remove(n)}))},{version:"0.8.19",name:"Split notification options",action:()=>Xn.storage.get("settings/progressNotifications").then((t=>{let e=!0;void 0!==t&&!1===t&&(e=!1),Xn.storage.set("settings/progressNotificationsAnime",e),Xn.storage.set("settings/progressNotificationsManga",e)}))},{version:"0.9.0",name:"Migrate serial theme",action:()=>Xn.storage.get("settings/theme").then((t=>{void 0!==t&&"serial"===t&&Xn.storage.set("settings/theme","auto")}))},{version:"*",name:"Remove auto domain permissions",action:()=>Xn.settings.getAsync("customDomains").then((t=>{const e=t.filter((t=>!t.auto));return Xn.settings.set("customDomains",e)}))}];for(let r=0;r<n.length;r++){const i=n[r];if("*"===i.version||zn()(i.version,t)){e.m(i.version).log(i.name);try{await i.action()}catch(t){e.m(i.name).error(t)}}}}(t.previousVersion).finally((()=>async function(){const t=chrome.runtime.getManifest().content_scripts.filter((t=>t.js&&t.js.some((t=>/^content\/page_/.test(t)))));let e=[];t.forEach((t=>{e=e.concat(t.matches.map((t=>or(t))).filter((t=>t)))}));const n=await rr.settings.getAsync("customDomains");n&&rr.settings.set("customDomains",n.filter((t=>{const n=or(t.domain);return!n||!function(t){try{const e=chrome.runtime.getManifest().content_scripts.find((t=>t.js&&t.js.includes("content/iframe.js")));return!(!e||!e.matches)&&er(...e.matches).test(t)}catch(t){return!1}}(t.domain)&&!e.some((t=>t.startsWith(n)))})))}())),chrome.alarms.clearAll()}))})()})();
//# sourceMappingURL=background.js.map