import{r as R,E as L}from"./constants-e5712b98.js";import{u as C,A as V}from"./index-f00bab01.js";import{u as $}from"./button-e2ac6183.js";import{x as M,_ as z}from"./index-5ad58ea9.js";async function J(s,r){const e=s.getReader();let n;for(;!(n=await e.read()).done;)r(n.value)}function F(s){let r,e,n,o=!1;return function(u){r===void 0?(r=u,e=0,n=-1):r=X(r,u);const i=r.length;let c=0;for(;e<i;){o&&(r[e]===10&&(c=++e),o=!1);let f=-1;for(;e<i&&f===-1;++e)switch(r[e]){case 58:n===-1&&(n=e-c);break;case 13:o=!0;case 10:f=e;break}if(f===-1)break;s(r.subarray(c,f),n),c=e,n=-1}c===i?r=void 0:c!==0&&(r=r.subarray(c),e-=c)}}function G(s,r,e){let n=H();const o=new TextDecoder;return function(u,i){if(u.length===0)e==null||e(n),n=H();else if(i>0){const c=o.decode(u.subarray(0,i)),f=i+(u[i+1]===32?2:1),g=o.decode(u.subarray(f));switch(c){case"data":n.data=n.data?n.data+`
`+g:g;break;case"event":n.event=g;break;case"id":s(n.id=g);break;case"retry":const m=parseInt(g,10);isNaN(m)||r(n.retry=m);break}}}}function X(s,r){const e=new Uint8Array(s.length+r.length);return e.set(s),e.set(r,s.length),e}function H(){return{data:"",event:"",id:"",retry:void 0}}var Y=globalThis&&globalThis.__rest||function(s,r){var e={};for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&r.indexOf(n)<0&&(e[n]=s[n]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,n=Object.getOwnPropertySymbols(s);o<n.length;o++)r.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(s,n[o])&&(e[n[o]]=s[n[o]]);return e};const j="text/event-stream",Z=1e3,q="last-event-id";function k(s,r){var{signal:e,headers:n,onopen:o,onmessage:l,onclose:u,onerror:i,openWhenHidden:c,fetch:f}=r,g=Y(r,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((m,_)=>{const w=Object.assign({},n);w.accept||(w.accept=j);let b;function T(){b.abort(),document.hidden||h()}c||document.addEventListener("visibilitychange",T);let U=Z,v=0;function E(){document.removeEventListener("visibilitychange",T),window.clearTimeout(v),b.abort()}e==null||e.addEventListener("abort",()=>{E(),m()});const A=f??window.fetch,x=o??ee;async function h(){var S;b=new AbortController;try{const y=await A(s,Object.assign(Object.assign({},g),{headers:w,signal:b.signal}));await x(y),await J(y.body,F(G(O=>{O?w[q]=O:delete w[q]},O=>{U=O},l))),u==null||u(),E(),m()}catch(y){if(!b.signal.aborted)try{const O=(S=i==null?void 0:i(y))!==null&&S!==void 0?S:U;window.clearTimeout(v),v=window.setTimeout(h,O)}catch(O){E(),_(O)}}}h()})}function ee(s){const r=s.headers.get("content-type");if(!(r!=null&&r.startsWith(j)))throw new Error(`Expected content-type to be ${j}, Actual: ${r}`)}const te=1,oe=(s,r,e,n=!1)=>{var A,x,h,S;const[o,l]=R.useState(n?"pending":"idle"),[u,i]=R.useState(null),c=R.useRef(null),f=R.useRef([]),g=R.useRef(0),m=C(),_=$(),w=(x=(A=_.details)==null?void 0:A.apiKey)!=null&&x.isEnabled?{apiKey:(S=(h=_.details)==null?void 0:h.apiKey)==null?void 0:S.value}:{},{signOut:b}=R.useContext(V),T=R.useCallback(async()=>{try{await m.fetchQuery({...M.UserSession,staleTime:0})?E(...f.current):(l("error"),b())}catch{l("error"),b()}},[]),U=R.useCallback(()=>{c.current&&(!c.current.signal.aborted&&c.current.abort(),l("idle"),i(null),f.current=[])},[]),v=R.useCallback(()=>{var y;c.current&&(!c.current.signal.aborted&&c.current.abort(),l("idle"),i(null),f.current=[],(y=e.onClose)==null||y.call(e,!0),setTimeout(()=>{m.invalidateQueries(M.UserUsageUAM)},2e3))},[e]),E=R.useCallback(async y=>{var K,Q;l("pending"),y&&(f.current=[y]);const O=new AbortController;c.current=O;const B=z(),I=await m.fetchQuery(M.UserSession);try{await k(s,{body:JSON.stringify({...y,...w}),headers:{Authorization:`Bearer ${(I==null?void 0:I.accessToken)??null}`,"Content-Type":"application/json","x-merlin-version":B},method:e.method,onclose:()=>{var a;(a=e.onClose)==null||a.call(e)},onerror:a=>{var t,d;if((a==null?void 0:a.name)==="CUSTOM_ERROR"&&a.retry)if(g.current<te)g.current+=1,l("retrying"),(t=e.onRetry)==null||t.call(e),T();else{l("error"),b();try{(d=e.onRetryLimitReached)==null||d.call(e)}catch(N){console.error("Error in onMessage callback passed from component",N)}}throw a},onmessage:a=>{var d,N,p,D,W;const t=JSON.parse(a.data);if((t==null?void 0:t.status)==="error")throw{name:"CUSTOM_ERROR",retry:!1,...t==null?void 0:t.error};if((t==null?void 0:t.status)==="success"){l("streaming");try{(d=e.onMessage)==null||d.call(e,a)}catch(P){console.error("Error in onMessage callback passed from component",P)}}if((t==null?void 0:t.status)==="system"&&(((N=t==null?void 0:t.data)==null?void 0:N.eventType)==="DONE"&&(l("success"),g.current=0),((p=t==null?void 0:t.data)==null?void 0:p.eventType)==="SYSTEM"&&(t!=null&&t.data.hasOwnProperty("usage")&&m.setQueryData(M.UserUsageUAM.queryKey,(D=t==null?void 0:t.data)==null?void 0:D.usage),t!=null&&t.data.hasOwnProperty("questions")||t!=null&&t.data.hasOwnProperty("metadata")||t!=null&&t.data.hasOwnProperty("attachments")||t!=null&&t.data.hasOwnProperty("settings")||t!=null&&t.data.hasOwnProperty("messageType"))))try{(W=e.onMessage)==null||W.call(e,a)}catch(P){console.error("Error in onMessage callback passed from component",P)}},onopen:async a=>{var t;if(a.ok&&a.headers.get("content-type")===j){l("streaming");try{(t=e.onOpen)==null||t.call(e,a)}catch(d){console.error("Error in onOpen callback passed from component",d)}}else{if(a.status===401)throw{name:"CUSTOM_ERROR",retry:!0,...(await a.json()).error};if(a.status===413)throw{message:"Input size too large",name:"CUSTOM_ERROR",retry:!1,type:"INPUT_SIZE_TOO_LARGE"};{const d=await a.json();throw(d==null?void 0:d.status)==="error"?{name:"CUSTOM_ERROR",retry:!1,...d.error}:{message:"Something went wrong. Please try again later.",name:"CUSTOM_ERROR",retry:!1,type:L.UNKNOWN_ERROR}}}},openWhenHidden:!0,signal:O.signal})}catch(a){if((a==null?void 0:a.name)==="CUSTOM_ERROR"){if(a.retry){i(a);return}a.type===L.RATE_LIMITED&&setTimeout(()=>{m.invalidateQueries(M.UserUsageUAM)},100),l("error"),(K=e.onError)==null||K.call(e,a)}else l("error"),(Q=e.onError)==null||Q.call(e,{message:"Something went wrong. Please try again later.",name:"CUSTOM_ERROR",retry:!1,type:L.UNKNOWN_ERROR})}},[v,e,w,T]);return R.useMemo(()=>({[r]:{close:v,error:u,execute:E,loading:o==="pending"||o==="retrying",reset:U,setStatus:l,status:o}}),[r,u,v,E,o,U])};export{oe as u};
