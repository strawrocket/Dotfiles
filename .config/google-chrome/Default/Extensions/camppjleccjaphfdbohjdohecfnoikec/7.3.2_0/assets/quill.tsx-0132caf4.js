import{r as a,c as Oe,e as ht,j as e,E as xt,R as Y,k as we,h as vt}from"./constants-e5712b98.js";import{c as gt}from"./font-e4ec73e1.js";import{l as bt,m as wt,b as X,C as jt,R as yt,a as Nt}from"./index-f00bab01.js";import{C as Ct}from"./configContext-ec633c64.js";import{M as It}from"./messageContext-f7b272bf.js";import{T as kt}from"./themeContext-b5ecfc73.js";import{c as St,a as Tt}from"./atom-one-light-7372aee1.js";import{u as je,c as q,B as F,b as _e,o as Et,s as me,e as K}from"./button-e2ac6183.js";import{a as Rt,c as Lt}from"./cloudFunctions-51487c9d.js";import{c as Pt}from"./tooltip-8f9bc4e6.js";import{u as Be}from"./i18n-6c9556b7.js";import{P as Ee}from"./index-52d9b6b3.js";import{b as ie,c as ye,d as le,C as Ne,e as At,a as ge,u as Mt,t as Dt}from"./zod-24415ea2.js";import{A as Ge,a as Ue,B as ne}from"./avatar-1c1cd4d0.js";import{D as Ft,a as qt,b as Ot,d as Re,e as _t,c as W,f as Bt,g as Gt,h as Ut,i as ze,R as zt,I as Ht}from"./dropdown-menu-d663e728.js";import{P as He}from"./useMedia-c48a250e.js";import{D as Le,p as Pe,N as Qt,f as Qe,o as J,O as pe,g as Ae,L as se,i as Ce,P as Vt,h as Kt}from"./index-5ad58ea9.js";import{f as _}from"./analytics-e24f0cc0.js";import{u as $t,S as O,F as Wt,a as fe,b as he,c as xe,d as Yt,e as Jt,f as Xt,g as Zt,h as Me,i as De,j as Fe,L as ve}from"./select-cbc93c8d.js";import{u as es}from"./useSSE-d3d13984.js";import{v as z}from"./v4-4a60fe23.js";import{c as H}from"./createReactComponent-85aa5d18.js";import{S as ae,f as ts,l as ss,a as ns,T as Ve,I as as}from"./textarea-660024e1.js";import{S as re,I as Ke,u as rs,C as os}from"./Combination-0edb6dd9.js";import{I as is}from"./IconCheck-f452d2aa.js";import{I as ls}from"./IconCopy-a5a1449e.js";import{I as cs}from"./IconRefresh-ff2179ff.js";import{a as ds,I as qe}from"./IconSend-07f8814c.js";import{I as us}from"./IconChevronRight-89acbc25.js";import{e as ms}from"./backend-f1dada26.js";import{I as $e}from"./IconX-5b78e9ec.js";import{I as ps,a as fs,L as hs}from"./loader-c8887c7f.js";import{c as We,P as Ie,a as be,b as xs,u as vs,d as gs}from"./index-fe9d96fe.js";import{u as bs}from"./index-9ef95a97.js";import{c as ws}from"./index-0c67d257.js";import"./cache-2436a988.js";import"./index-3da7154a.js";var js=H("briefcase","IconBriefcase",[["path",{d:"M3 7m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v9a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z",key:"svg-0"}],["path",{d:"M8 7v-2a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v2",key:"svg-1"}],["path",{d:"M12 12l0 .01",key:"svg-2"}],["path",{d:"M3 13a20 20 0 0 0 18 0",key:"svg-3"}]]),ys=H("message-circle-2","IconMessageCircle2",[["path",{d:"M3 20l1.3 -3.9a9 8 0 1 1 3.4 2.9l-4.7 1",key:"svg-0"}]]),Ns=H("plus","IconPlus",[["path",{d:"M12 5l0 14",key:"svg-0"}],["path",{d:"M5 12l14 0",key:"svg-1"}]]),Cs=H("power","IconPower",[["path",{d:"M7 6a7.75 7.75 0 1 0 10 0",key:"svg-0"}],["path",{d:"M12 4l0 8",key:"svg-1"}]]),Is=H("replace","IconReplace",[["path",{d:"M3 3m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z",key:"svg-0"}],["path",{d:"M15 15m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z",key:"svg-1"}],["path",{d:"M21 11v-3a2 2 0 0 0 -2 -2h-6l3 3m0 -6l-3 3",key:"svg-2"}],["path",{d:"M3 13v3a2 2 0 0 0 2 2h6l-3 -3m0 6l3 -3",key:"svg-3"}]]),ks=H("square-filled","IconSquareFilled",[["path",{d:"M19 2h-14a3 3 0 0 0 -3 3v14a3 3 0 0 0 3 3h14a3 3 0 0 0 3 -3v-14a3 3 0 0 0 -3 -3z",fill:"currentColor",key:"svg-0",strokeWidth:"0"}]]),Ss=H("tool","IconTool",[["path",{d:"M7 10h3v-3l-3.5 -3.5a6 6 0 0 1 8 8l6 6a2 2 0 0 1 -3 3l-6 -6a6 6 0 0 1 -8 -8l3.5 3.5",key:"svg-0"}]]);const Ts=r=>a.createElement("svg",{viewBox:"0 0 893 900",fill:"none",xmlns:"http://www.w3.org/2000/svg",...r},a.createElement("g",{clipPath:"url(#clip0_31308_141500)"},a.createElement("path",{d:"M893 450C646.465 450 446.5 248.467 446.5 0C446.5 248.467 246.535 450 0 450C246.535 450 446.5 651.533 446.5 900C446.5 651.533 646.465 450 893 450Z",fill:"url(#paint0_linear_31308_141500)",fillOpacity:.7})),a.createElement("defs",null,a.createElement("linearGradient",{id:"paint0_linear_31308_141500",x1:44.5,y1:277,x2:818.5,y2:652.5,gradientUnits:"userSpaceOnUse"},a.createElement("stop",{stopColor:"#6C3BF9"}),a.createElement("stop",{offset:1,stopColor:"#EFCCFF",stopOpacity:.61})),a.createElement("clipPath",{id:"clip0_31308_141500"},a.createElement("rect",{width:893,height:900,fill:"white"})))),Es=bt(r=>({ctx:{obj:{},text:""},liveSelectionActive:!1,quickPrompts:[],requestIdHeader:"",setCtx:n=>r({ctx:n}),setLiveSelectionActive:n=>r({liveSelectionActive:n}),setQuickPrompts:n=>r({quickPrompts:n}),setRequestIdHeader:n=>r({requestIdHeader:n}),setUserInput:n=>r({userInput:n}),userInput:{prompt:""}})),Z=r=>wt(Es,r),Ye=a.createContext(null);function Rs({children:r}){const{...n}=a.useContext(X),[t]=He({instance:new Oe({area:"local"}),key:"quillSettings"},f=>f===void 0?{bio:"",model:"GPT 3",name:"",occupation:"",outputLang:"english",outputLength:"medium",tone:"empathetic",writingStyle:"professional"}:f),[i,m]=a.useState(null),p=a.useRef(null),c=a.useRef(null),l=a.useRef(null),s=$t(),{ctx:N,setCtx:C,setLiveSelectionActive:j,setRequestIdHeader:h,setUserInput:x}=Z(f=>({ctx:f.ctx,setCtx:f.setCtx,setLiveSelectionActive:f.setLiveSelectionActive,setRequestIdHeader:f.setRequestIdHeader,setUserInput:f.setUserInput})),y={onClose:()=>{var f;(f=p.current)==null||f.focus(),s.setIsPromptingAvailable(!0),s.editMessageNodeById(s.getLastMessage().id,g=>(g={...g,status:"SUCCESS"},g))},onError:f=>{var M;if(s.setIsPromptingAvailable(!0),console.error(f),s.deleteLastMessage(),(f==null?void 0:f.name)==="CUSTOM_ERROR")if(f.type===xt.RATE_LIMITED){s.setError(((M=n.usageDetails)==null?void 0:M.type)==="PAID"?"Your queries have exhausted. Please upgrade your plan to continue using Merlin.":"Your queries have exhausted for today. Subscribe to Merlin Pro to continue using Merlin or come back tomorrow.");return}else s.setError(f.message||"Something went wrong. Please try again later.");else s.setError("Something went wrong. Please try again later.");const g={description:f.message||"Something went wrong. Please try again later.",duration:3e3,title:"Error",variant:"destructive"};Qt.error(g.title,{description:g.description,duration:g.duration})},onMessage:f=>{var w,D,I,d,E;const g=JSON.parse(f.data),M=g.data.content;((w=g==null?void 0:g.data)==null?void 0:w.eventType)==="SYSTEM"&&(g!=null&&g.data.hasOwnProperty("settings")&&(s.setChatId((I=(D=g==null?void 0:g.data)==null?void 0:D.settings)==null?void 0:I.chatId),s.editMessageNodeById(s.getLastMessage().parentId,k=>(k={...k,id:g.data.settings.userMessage.id},k)),s.editMessageNodeById(s.getLastMessage().id,k=>(k={...k,id:g.data.settings.assistantMessage.id,parentId:g.data.settings.userMessage.id},k))),g!=null&&g.data.hasOwnProperty("questions")&&s.setQuestions((d=g==null?void 0:g.data)==null?void 0:d.questions),(E=g==null?void 0:g.data)!=null&&E.metadata&&s.editMessageNodeById(s.getLastMessage().id,k=>(k={...k,metadata:{...k.metadata,...g.data.metadata}},k))),s.editMessageNodeById(s.getLastMessage().id,k=>(k.status==="LOADING"?(k.content=M,k.role="assistant",k.status="STREAMING"):k.status==="STREAMING"&&(k.content=`${k.content}${M}`),k))},onOpen:async f=>{f.ok&&f.headers.get("X-Request-Id")&&h(f.headers.get("X-Request-Id"))}},{handleSSEQuill:o}=es(`${ht.DOMAIN}/api/v1/quill`,"handleSSEQuill",{method:"POST",...y}),u=a.useCallback(f=>{const g=f.prompt.trim().length>=2e4;if(!f.prompt.trim()||g||!s.isPromptingAvailable)return null;j(!1),s.setError("")},[s]),S=()=>{if(c.current){const f=c.current.querySelector("[data-radix-scroll-area-viewport]");f&&setTimeout(()=>f.scrollTo({behavior:"smooth",left:0,top:f.scrollHeight}),100)}},v=a.useCallback(async f=>{var d,E;if(u(f)===null)return;s.setIsPromptingAvailable(!1),o.reset(),s.setQuestions([]),s.appendMessageThread([{attachments:null,content:f.prompt,id:z(),metadata:{context:""},parentId:((d=s.activeThread[s.activeThread.length-1])==null?void 0:d.id)??"root",role:"user",status:"SUCCESS"},{content:"",id:z(),parentId:"",role:"system",status:"LOADING"}]),l.current.setAttribute("merlin-uid",z());const M=Le(),w={ADD_ATTR:["merlin-uid"],FORBID_ATTR:["data-*"],FORBID_TAGS:["style","noscript","script","aside"],USE_PROFILES:{html:!0}},D=Pe.sanitize(M,{...w}),I={message:{attachments:null,content:f.prompt,metadata:{context:N.text??""},parentId:((E=s.activeThread[s.activeThread.length-1])==null?void 0:E.id)??"root",role:"user"},metadata:{contextObj:N.obj,dom:D,domain:window.location.hostname},model:t!=null&&t.model&&(t==null?void 0:t.model)==="GPT 4"?"gpt-4":"gpt-3.5-turbo",thread:s.activeThread};l.current.removeAttribute("merlin-uid"),o.execute(I),s.setContext(null),x({prompt:""}),S(),_({eventName:"SubmitPrompt",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/store/context"})},[s,o,u,x,N,t==null?void 0:t.model]),T=a.useCallback(async()=>{var I;if(u({prompt:s.getLastMessage().content??""})===null)return;s.setIsPromptingAvailable(!1),s.insertMessageNode(s.activeThread[s.activeThread.length-2].id,{content:"",id:z(),parentId:s.activeThread[s.activeThread.length-2].id,role:"system",status:"LOADING"}),l.current.setAttribute("merlin-uid",z());const g=Le(),M={ADD_ATTR:["merlin-uid"],FORBID_ATTR:["data-*"],FORBID_TAGS:["style","noscript","script","aside"],USE_PROFILES:{html:!0}},w=Pe.sanitize(g,{...M}),D={message:{attachments:null,content:s.activeThread[s.activeThread.length-2].content,metadata:{context:N.text??""},parentId:((I=s.activeThread[s.activeThread.length-1])==null?void 0:I.id)??"root",role:"user"},metadata:{contextObj:N.obj,dom:w,domain:window.location.hostname},model:t!=null&&t.model&&(t==null?void 0:t.model)==="GPT 4"?"gpt-4":"gpt-3.5-turbo",thread:s.activeThread.splice(0,s.activeThread.length-2)};l.current.removeAttribute("merlin-uid"),o.execute(D),S(),_({eventName:"RegenerateButton",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/store/context"})},[u,s,o,N,t==null?void 0:t.model]),P=a.useMemo(()=>(o==null?void 0:o.loading)||(o==null?void 0:o.status)==="streaming",[o==null?void 0:o.loading,o==null?void 0:o.status]),A=a.useMemo(()=>(o==null?void 0:o.status)==="success"||(o==null?void 0:o.status)==="idle",[o==null?void 0:o.status]),B=a.useCallback(()=>{p.current&&(p.current.value=""),s.reset({}),s.setError(""),x({prompt:""}),o.reset(),j(!1),C({obj:{selectedText:""},text:""}),s==null||s.reset({})},[o,s]);a.useEffect(()=>{p.current&&p.current.focus(),(async()=>{const g=await Rt();m(g)})()},[]),a.useEffect(()=>{if(!c.current)return;const f=c.current.querySelector("div");if(f&&o.status==="success"){const g=f.scrollHeight,M=f.scrollTop,w=f.offsetHeight;M+w>=g-50&&S()}},[o.status]);const Q={chat:s,handleRegenerateLastMessage:T,handleSSEQuill:o,handleSubmit:v,inputRef:p,isSSELoadingOrStreaming:P,isSSESuccessOrIdle:A,quillPrompts:i,scrollAreaRef:c,startNewChat:B,textareaRef:l};return e.jsx(Ye.Provider,{value:Q,children:r})}function ee(){const r=Y.useContext(Ye);if(!r)throw new Error("useQuillContext must be used within a QuillContextProvider");return r}function Je(r){const{className:n,icon:t}=r;return t==="replace"?e.jsx(Is,{className:q(n)}):t==="messagecircle2"?e.jsx(ys,{className:q(n)}):t==="tool"?e.jsx(Ss,{className:q(n)}):t==="briefcase"?e.jsx(js,{className:q(n)}):t.startsWith("https")?e.jsx("img",{src:t,className:q(n)}):e.jsx(Ns,{className:q(n)})}function $(r){const{item:n,openPortalUi:t}=r;return e.jsx(W,{className:q("cursor-pointer",r.className),onMouseDown:()=>{t({...n.promptConfig})},onClick:()=>_({eventName:n.copy,eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"}),children:e.jsxs("div",{className:"flex w-full items-center gap-2",children:[e.jsx(Je,{icon:n.icon,className:"h-4 w-4 stroke-[1.5]"}),e.jsx("div",{children:n.copy})]})},n.copy)}function Ls(r){var V;const{isVisible:n,selectedText:t,setIsVisible:i,setModalOpen:m,textarea:p}=r,{ctx:c,setCtx:l,setLiveSelectionActive:s,setUserInput:N,userInput:C}=Z(b=>({ctx:b.ctx,requestIdHeader:b.requestIdHeader,setCtx:b.setCtx,setLiveSelectionActive:b.setLiveSelectionActive,setUserInput:b.setUserInput,userInput:b.userInput})),[j,h]=a.useState(!1),{chat:x,handleSubmit:y,inputRef:o,quillPrompts:u}=ee(),[S,v]=a.useState(!1),{...T}=a.useContext(X),P=je(),[A,B]=a.useState(!1),[Q,f]=a.useState(0),g=a.useRef(null),M=a.useRef(null);a.useEffect(()=>{const b=()=>{pe(p)?h(!0):h(!1)};return b(),p.addEventListener("keyup",b),()=>{p.removeEventListener("keyup",b)}},[]),a.useEffect(()=>{Q>0&&y(C)},[Q]);function w(b){const{extractContext:L,extractInput:pt,liveSelection:ft,query:ce}=b;if(!T.isAuthenticated){i(!0);return}const Te=pe(p);let de="";t?de=t:pt&&Te&&(de=Te);const ue=de.slice(-4e3);l({obj:{selectedText:""},text:ue}),i(!0),setTimeout(()=>{var te;(te=o.current)==null||te.focus()},20),ce&&N({prompt:ce}),ft&&x.activeThread.length===0&&!ue&&s(!0),ce&&ue&&f(te=>te+1)}function D(){if(!u||!u.dropdownItems)return;const{dropdownItems:b}=u;return t&&b.textSelected&&b.textSelected.length>0?e.jsx(e.Fragment,{children:b.textSelected.map(L=>e.jsx($,{item:L,openPortalUi:w},L.copy))}):pe(p)?e.jsx(e.Fragment,{children:b.inputContent.map(L=>e.jsx($,{item:L,openPortalUi:w},L.copy))}):e.jsxs(e.Fragment,{children:[b.context&&b.context.length>0&&e.jsx(e.Fragment,{children:b.context.map(L=>c.text?e.jsx($,{item:L,openPortalUi:w},L.copy):null)}),b.default&&b.default.length>0&&e.jsx(e.Fragment,{children:b.default.map(L=>e.jsx($,{item:L,openPortalUi:w},L.copy))})]})}const I=a.useCallback(()=>{M.current&&clearTimeout(M.current),B(!0)},[]),d=a.useCallback(()=>{M.current&&clearTimeout(M.current),M.current=window.setTimeout(()=>{B(!1)},300)},[]),E=a.useCallback(b=>{b.stopPropagation();const L={from:"QUILL",payload:{action:"CLOSE_QUILL_THROUGHT_PAGE",data:null}};window.parent.postMessage(L,"*"),_({eventName:"QuillDisableTemporarily",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"})},[]),k=a.useCallback(b=>{E(b),Qe(we.QUILL),_({eventName:"QuillDisableForThis",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"})},[E]),G=a.useCallback(b=>{E(b),P.update(L=>({...L,quill:{isEnabled:!1}})),_({eventName:"QuillDisableForever",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"})},[E]),R=a.useCallback(()=>{v(!0)},[]),U=a.useCallback(()=>{v(!1)},[]);return e.jsxs(Ft,{open:A,onOpenChange:b=>{b||B(!1)},modal:!1,children:[(j||n||t)&&e.jsx(qt,{asChild:!0,onPointerEnter:I,onPointerLeave:d,onPointerDownCapture:b=>{b.preventDefault(),b.stopPropagation()},children:e.jsx("div",{className:q("group/icon flex-center realtive h-5 w-5",{"rounded-full bg-zinc-100":A}),children:e.jsxs("div",{ref:g,className:"flex-center h-full w-full",children:[t&&e.jsx("div",{className:"absolute -right-0 -top-0",children:e.jsxs("span",{className:"relative flex h-1.5 w-1.5",children:[e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-indigo-300 opacity-75"}),e.jsx("span",{className:"relative inline-flex h-1.5 w-1.5 rounded-full bg-indigo-400"})]})}),e.jsx(Ts,{className:"h-4 w-4"})]})})}),e.jsxs(Ot,{className:"w-56",onPointerEnter:I,onPointerLeave:d,children:[e.jsxs(Re,{children:[D(),e.jsx("div",{className:"merlinExt-magic-btn-border rounded",children:e.jsx($,{item:{copy:"Custom Prompt",icon:"plus",promptConfig:{extractContext:!0,extractInput:!0,liveSelection:u&&u.textSelectionWithCustomPrompt||!1}},className:"bg-popover",openPortalUi:w})})]}),e.jsxs(e.Fragment,{children:[e.jsx(_t,{}),e.jsx(Re,{children:e.jsxs(W,{className:"flex justify-between focus:bg-transparent",children:[e.jsxs(Bt,{open:S,onOpenChange:b=>v(b),children:[e.jsx(Gt,{onPointerEnter:R,onPointerLeave:U,onClick:b=>{b.stopPropagation()},hidearrow:"true",children:e.jsx(Cs,{className:"h-4 w-4"})}),e.jsxs(Ut,{sticky:"partial",onPointerEnter:R,onPointerLeave:U,children:[e.jsx(W,{className:"hover:bg-accent cursor-pointer",onClick:E,children:"Disable temporarily"}),e.jsx(W,{className:"hover:bg-accent cursor-pointer",onClick:k,children:"Disable for this site"}),e.jsx(W,{className:"hover:bg-accent cursor-pointer",onClick:G,children:"Disable forever"})]})]}),e.jsx(F,{variant:"link",size:"xs",onClick:b=>{!T.isLoading&&T.isAuthenticated?(m(L=>!L),_({eventName:"FeedbackModal",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"})):i(!0)},className:"-ml-0.5",children:"Feedback"}),e.jsx(F,{variant:"ghost",size:"icon",onClick:b=>{!T.isLoading&&T.isAuthenticated?(J("https://www.getmerlin.in/dashboard?from=quill"),_({eventName:"OpenMerlinDashboard",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"})):i(!0)},className:"h-fit w-8 p-0 hover:rounded-full",children:e.jsx(Ge,{className:"h-6 w-6",children:e.jsx(Ue,{children:((V=T==null?void 0:T.name)==null?void 0:V[0])??"U"})})})]})})]})]})]})}function Ps(){return e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"flex-center",children:e.jsx(ye,{className:" font-medium leading-5",children:"You need to be logged in to use this feature. Please login or sign up to continue."})}),e.jsx(le,{className:"flex gap-2",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{onClick:()=>J("https://www.getmerlin.in/sign-in"),children:"Login"}),e.jsx(F,{variant:"secondary",onClick:()=>J("https://www.getmerlin.in/sign-in"),children:"Sign up"})]})})]})}function As({handleInsertText:r,index:n,msg:t}){const{t:i}=Be(),[m,p]=a.useState(!1),{chat:c,handleRegenerateLastMessage:l,isSSESuccessOrIdle:s}=ee(),N=a.useMemo(()=>c.activeThread.length-1===n&&t.role==="assistant",[c.activeThread.length,n,t.role]);function C(j){navigator.clipboard.writeText(j),p(!0),setTimeout(()=>p(!1),1200),_({eventName:"CopyButton",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/messages"})}if(t.role=="user")return e.jsx(e.Fragment,{children:e.jsxs("div",{style:{zIndex:10+n},className:q("bg-background",{"sticky -top-1 pt-1":n===c.activeThread.length-2}),id:"user-msg-container",children:[e.jsxs("div",{className:" flex gap-2",id:`${n===c.activeThread.length-2?"user-msg-body":""}`,children:[e.jsx(ne,{className:"relative mr-2 h-fit",variant:"secondary",children:i("super_gmail.prompt")}),e.jsx("span",{className:"line-clamp-1 max-h-24 overflow-y-auto break-words text-sm",children:t.content})]},t.id),c.activeThread.length-1!==n&&e.jsx(ae,{className:"my-2"})]})});if(t.role==="assistant")return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative flex min-h-[255px] flex-grow flex-col justify-between",children:[e.jsx("div",{className:" whitespace-pre-wrap break-words p-0 pb-6 text-sm",children:t.content.trim()}),s&&e.jsxs("div",{className:" bg-background flex w-full items-center gap-2 p-0.5 text-sm",children:[e.jsx(F,{size:"sm",variant:"secondary",onClick:()=>{r(t.content)},tabIndex:n===c.activeThread.length-1?0:-1,children:i("super_gmail.insert")}),e.jsx("button",{type:"button",className:"bg-transparent p-1 only:rounded-md",onClick:()=>{C(t.content)},tabIndex:n===c.activeThread.length-1?0:-1,disabled:m,children:m?e.jsx(is,{className:"plain-icon-color h-4 w-4 stroke-[1.5]"}):e.jsx(ls,{className:"plain-icon-color h-4 w-4 stroke-[1.5]"})}),N&&e.jsx("button",{type:"button",className:"bg-transparent p-1 only:rounded-md",onClick:()=>{l()},tabIndex:n===c.activeThread.length-1?0:-1,children:e.jsx(cs,{className:"plain-icon-color h-4 w-4 stroke-[1.5]"})}),t.totSiblings>0&&e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{type:"button",className:" group/btn bg-transparent",onClick:()=>c.switchLeft(t),disabled:t.idx===0,tabIndex:n===c.activeThread.length-1?0:-1,children:e.jsx(ds,{className:"plain-icon-color h-4 w-4 stroke-[1.5] group-disabled/btn:opacity-50"})}),e.jsxs("span",{className:"mx-0.5 flex items-end",children:[t.idx+1,e.jsx("span",{className:"relative -top-[1px]",children:"/"}),t.totSiblings]}),e.jsx("button",{type:"button",className:" group/btn bg-transparent",onClick:()=>c.switchRight(t),disabled:t.idx===t.totSiblings-1,tabIndex:n===c.activeThread.length-1?0:-1,children:e.jsx(us,{className:"plain-icon-color h-4 w-4 stroke-[1.5] group-disabled/btn:opacity-50"})})]})]})]}),c.activeThread.length-1!==n&&e.jsx(ae,{className:"my-2"})]});if(t.role==="system")return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:" flex h-[255px] flex-col justify-between",children:e.jsxs("div",{className:"",children:[e.jsx(O,{className:"mb-4 h-2 w-16"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(O,{className:"h-2 w-72"}),e.jsx(O,{className:"h-2 w-32"}),e.jsx(O,{className:"h-2 w-10"}),e.jsx(O,{className:"h-2 w-16"}),e.jsx(O,{className:"h-2 w-96"}),e.jsx(O,{className:"h-2 w-72"}),e.jsx(O,{className:"h-2 w-32"}),e.jsx(O,{className:"h-2 w-10"}),e.jsx(O,{className:"h-2 w-16"}),e.jsx(O,{className:"h-2 w-96"})]}),e.jsx(O,{className:"my-1 mt-4 h-2 w-16"}),e.jsx(O,{className:"h-2 w-20"})]})}),c.activeThread.length-1!==n&&e.jsx(ae,{className:"my-2"})]})}function Ms(r){var S;const{handleInsertText:n,setCurrentMode:t}=r,{chat:i,handleSSEQuill:m,handleSubmit:p,inputRef:c,isSSESuccessOrIdle:l,quillPrompts:s,scrollAreaRef:N}=ee(),{ctx:C,setUserInput:j,userInput:h}=Z(v=>({ctx:v.ctx,setUserInput:v.setUserInput,userInput:v.userInput})),x=a.useMemo(()=>(i.activeThread.length>0&&l||i.activeThread.length===0&&C.text.length>5)&&s&&s.quickPrompts,[i.activeThread.length,l,C.text.length,s]),y=Y.useRef(null),[o,u]=Y.useState(-1);return a.useEffect(()=>{y.current&&y.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[o]),e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"h-[320px] w-full p-4 pb-2",children:e.jsx(re,{className:"intersection-observer-root flex flex-1 flex-col",ref:N,children:e.jsxs("div",{className:"mr-2",children:[e.jsx("div",{className:"flex flex-col gap-2",children:e.jsxs("div",{className:"bg-background",id:"context-msg-container",children:[e.jsxs("div",{className:q("flex gap-2",{"flex-col":i.activeThread.length===0}),children:[i.activeThread.length===0?C.text?e.jsx(ne,{className:"relative h-fit w-fit",variant:"secondary",children:"Selected Context"}):e.jsx(ne,{className:"relative h-fit w-fit",variant:"secondary",children:"No context selected"}):e.jsx(ne,{className:"relative h-fit w-fit",variant:"secondary",children:"Context"}),e.jsx(re,{className:q("w-full resize-none text-sm focus-visible:ring-0",{"h-[260px]":i.activeThread.length===0,"h-24":i.activeThread.length>0}),children:C.text?e.jsx("div",{className:"mr-2 h-full whitespace-pre-wrap break-words text-sm ",children:C.text}):e.jsx("div",{className:"tex flex select-none flex-col gap-2",children:e.jsx("ul",{className:"my-2 space-y-2",children:e.jsxs("li",{className:"flex flex-wrap items-center",children:["👈 Please select the text that you want to reply to and press",e.jsx("br",{}),e.jsxs("div",{className:"flex items-center gap-1",children:["the send button",e.jsx(qe,{className:"inline h-3 w-3"}),"."]})]})})})})]}),i.activeThread.length>0&&e.jsx(ae,{className:"my-2"})," "]})}),(S=i.activeThread)==null?void 0:S.map((v,T)=>e.jsx(As,{msg:v,index:T,handleInsertText:n},v.id)),i.error&&!i.error.includes("Your queries have exhausted")&&e.jsxs("div",{className:"flex min-h-[200px] flex-grow flex-col justify-between px-2 text-red-500",children:[e.jsx("div",{className:"p-0 text-sm",children:i.error}),e.jsx("div",{className:"mt-2 flex items-center gap-2 text-sm",children:e.jsx(F,{onClick:()=>{p({prompt:i.activeThread[i.activeThread.length-1].content}),u(-1)},children:"Retry"})})]}),i.error&&i.error.includes("Your queries have exhausted")&&e.jsxs("div",{className:"flex min-h-[200px] flex-grow flex-col justify-between px-2",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex",children:[e.jsx("img",{className:"h-8 w-8",src:Ae(ts),alt:"face-in-cloud"}),e.jsx("img",{className:"h-8 w-8",src:Ae(ss),alt:"lightning"})]}),e.jsx("div",{className:"p-0 text-sm",children:"Out of queries"})]}),e.jsx("div",{className:"mt-2 flex items-center gap-2 text-sm",children:e.jsx(F,{onClick:()=>J("https://www.getmerlin.in/pricing?from=quill"),children:"Go Pro"})})]})]})})}),e.jsxs(le,{className:" flex shrink-0 justify-between gap-2 border-t p-4",children:[e.jsxs("div",{className:"relative flex flex-1 items-center",children:[e.jsx(Ke,{onChange:v=>{u(-1),j({prompt:v.target.value})},value:h.prompt,ref:c,id:"promptInput",placeholder:"Enter your prompt here",autoComplete:"off",onKeyDown:v=>{v.key==="Enter"&&v.shiftKey||v.key==="Enter"&&(v.preventDefault(),p(h),u(-1))},onKeyDownCapture:v=>{if(v.key==="ArrowUp"&&x){if(o===0)return;v.preventDefault(),v.stopPropagation(),u(T=>{const P=T>0?T-1:s.quickPrompts.length-1;return j({prompt:s.quickPrompts[P].prompt}),P})}v.key==="ArrowDown"&&x&&(v.preventDefault(),v.stopPropagation(),u(T=>{const P=T<s.quickPrompts.length-1?T+1:0;return j({prompt:s.quickPrompts[P].prompt}),P}))}}),x&&e.jsx(Ne,{className:"absolute left-0 top-10 w-full rounded-md py-2",children:e.jsx(re,{className:"h-28",children:e.jsx("div",{className:"flex w-full flex-col gap-1 text-sm",children:s.quickPrompts.map((v,T)=>e.jsxs("span",{ref:T===o?y:void 0,onClick:()=>{p({prompt:v.prompt}),u(-1)},className:q("hover:bg-secondary flex cursor-pointer items-center gap-2 px-2 py-1",{"bg-secondary":o===T}),children:[e.jsx(Je,{icon:v.icon,className:"h-4 w-4 shrink-0  stroke-[1.5]"}),v.copy]},v.copy))})})})]}),l?e.jsx(F,{variant:"outline",size:"icon",className:"flex-center aspect-square ",onClick:()=>{p(h),u(-1)},children:e.jsx(qe,{className:"h-4 w-4"})}):e.jsx(F,{size:"icon",variant:"outline",className:"flex-center aspect-square ",onClick:()=>{i.getLastMessage().content==""&&i.deleteLastMessage(),m.close(),_({eventName:"StopGenerationButton",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/messages"})},children:e.jsx(ks,{className:"h-4 w-4 text-rose-500"})}),e.jsx(F,{variant:"outline",size:"icon",className:"flex-center aspect-square ",onClick:()=>{t("SETTINGS")},children:e.jsx(ns,{className:"h-4 w-4 cursor-pointer"})})]})]})}function Ds({modalOpen:r,setModalOpen:n}){const[t,i]=a.useState(""),[m,p]=a.useState(""),{chat:c}=ee(),{requestIdHeader:l,userInput:s}=Z(h=>({requestIdHeader:h.requestIdHeader,userInput:h.userInput})),N=a.useRef(null);a.useEffect(()=>{const h=x=>{x.key==="Escape"&&r&&n(!1)};return window.addEventListener("keydown",h),()=>{window.removeEventListener("keydown",h)}},[r]);const{...C}=a.useContext(X);async function j(){var y;const x=(((y=c.activeThread)==null?void 0:y.slice(0,c.activeThread.length-1))??[]).map(o=>{var u;return{attachments:((u=o.attachments)==null?void 0:u.map(S=>({type:S.type,url:S.url})))??[],content:o.content,role:o.role}});await ms(JSON.stringify({activeChat:x,feature:"QUILL",feedbackMessage:t,userInput:s}),JSON.stringify({generatedResult:"NA"}),m??"negative",window.location.href,C.email??"EMAIL_NOT_FOUND",l)}return e.jsx("div",{className:"fixed left-1/2 top-1/2 z-[1001] h-full max-h-[350px] w-full max-w-[425px] -translate-x-1/2 -translate-y-1/2",ref:N,children:e.jsxs(Ne,{className:"relative flex h-full w-full flex-col justify-between gap-4",children:[e.jsx("div",{className:"absolute -right-4 -top-4",children:e.jsx(F,{variant:"outline",size:"icon",className:"rounded-full",onClick:()=>{n(!1)},children:e.jsx($e,{className:"text-primary/70 h-4 w-4 stroke-[1.5]"})})}),e.jsxs(ie,{className:"flex flex-col gap-2",children:[e.jsx(ye,{children:"Submit feedback"}),e.jsx(At,{className:"text-foreground/70 text-sm",children:"Please share what you liked / disliked about this feature"})]}),e.jsx(ge,{children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(Ve,{value:t,className:"w-full resize-none",placeholder:"Write your feedback here",onChange:h=>{i(h.target.value)},rows:4}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{variant:"ghost",size:"icon",className:q("p-0",{"bg-primary/10":m==="positive"}),onClick:()=>{p("positive")},children:e.jsx(ps,{className:"text-primary/70 h-4 w-4 stroke-[1.5]"})}),e.jsx(F,{variant:"ghost",size:"icon",className:q("p-0",{"bg-primary/10":m==="negative"}),onClick:()=>{p("negative")},children:e.jsx(fs,{className:"text-primary/70 h-4 w-4 stroke-[1.5]"})})]})]})}),e.jsxs(le,{className:"flex gap-2",children:[e.jsx(F,{variant:"outline",onClick:()=>{i(""),n(!1)},children:"Close"}),e.jsx(F,{variant:"merlin",onClick:()=>{if(!m){n(!1);return}j(),i(""),n(!1)},children:"Submit"})]})]})})}var ke="Radio",[Fs,Xe]=We(ke),[qs,Os]=Fs(ke),Ze=a.forwardRef((r,n)=>{const{__scopeRadio:t,name:i,checked:m=!1,required:p,disabled:c,value:l="on",onCheck:s,...N}=r,[C,j]=a.useState(null),h=_e(n,o=>j(o)),x=a.useRef(!1),y=C?!!C.closest("form"):!0;return e.jsxs(qs,{scope:t,checked:m,disabled:c,children:[e.jsx(Ie.button,{type:"button",role:"radio","aria-checked":m,"data-state":st(m),"data-disabled":c?"":void 0,disabled:c,value:l,...N,ref:h,onClick:be(r.onClick,o=>{m||s==null||s(),y&&(x.current=o.isPropagationStopped(),x.current||o.stopPropagation())})}),y&&e.jsx(_s,{control:C,bubbles:!x.current,name:i,value:l,checked:m,required:p,disabled:c,style:{transform:"translateX(-100%)"}})]})});Ze.displayName=ke;var et="RadioIndicator",tt=a.forwardRef((r,n)=>{const{__scopeRadio:t,forceMount:i,...m}=r,p=Os(et,t);return e.jsx(xs,{present:i||p.checked,children:e.jsx(Ie.span,{"data-state":st(p.checked),"data-disabled":p.disabled?"":void 0,...m,ref:n})})});tt.displayName=et;var _s=r=>{const{control:n,checked:t,bubbles:i=!0,...m}=r,p=a.useRef(null),c=bs(t),l=vs(n);return a.useEffect(()=>{const s=p.current,N=window.HTMLInputElement.prototype,j=Object.getOwnPropertyDescriptor(N,"checked").set;if(c!==t&&j){const h=new Event("click",{bubbles:i});j.call(s,t),s.dispatchEvent(h)}},[c,t,i]),e.jsx("input",{type:"radio","aria-hidden":!0,defaultChecked:t,...m,tabIndex:-1,ref:p,style:{...r.style,...l,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function st(r){return r?"checked":"unchecked"}var Bs=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],Se="RadioGroup",[Gs,qn]=We(Se,[ze,Xe]),nt=ze(),at=Xe(),[Us,zs]=Gs(Se),rt=a.forwardRef((r,n)=>{const{__scopeRadioGroup:t,name:i,defaultValue:m,value:p,required:c=!1,disabled:l=!1,orientation:s,dir:N,loop:C=!0,onValueChange:j,...h}=r,x=nt(t),y=rs(N),[o,u]=gs({prop:p,defaultProp:m,onChange:j});return e.jsx(Us,{scope:t,name:i,required:c,disabled:l,value:o,onValueChange:u,children:e.jsx(zt,{asChild:!0,...x,orientation:s,dir:y,loop:C,children:e.jsx(Ie.div,{role:"radiogroup","aria-required":c,"aria-orientation":s,"data-disabled":l?"":void 0,dir:y,...h,ref:n})})})});rt.displayName=Se;var ot="RadioGroupItem",it=a.forwardRef((r,n)=>{const{__scopeRadioGroup:t,disabled:i,...m}=r,p=zs(ot,t),c=p.disabled||i,l=nt(t),s=at(t),N=a.useRef(null),C=_e(n,N),j=p.value===m.value,h=a.useRef(!1);return a.useEffect(()=>{const x=o=>{Bs.includes(o.key)&&(h.current=!0)},y=()=>h.current=!1;return document.addEventListener("keydown",x),document.addEventListener("keyup",y),()=>{document.removeEventListener("keydown",x),document.removeEventListener("keyup",y)}},[]),e.jsx(Ht,{asChild:!0,...l,focusable:!c,active:j,children:e.jsx(Ze,{disabled:c,required:p.required,checked:j,...s,...m,name:p.name,ref:C,onCheck:()=>p.onValueChange(m.value),onKeyDown:be(x=>{x.key==="Enter"&&x.preventDefault()}),onFocus:be(m.onFocus,()=>{var x;h.current&&((x=N.current)==null||x.click())})})})});it.displayName=ot;var Hs="RadioGroupIndicator",lt=a.forwardRef((r,n)=>{const{__scopeRadioGroup:t,...i}=r,m=at(t);return e.jsx(tt,{...m,...i,ref:n})});lt.displayName=Hs;var ct=rt,dt=it,Qs=lt;const ut=a.forwardRef(({className:r,...n},t)=>e.jsx(ct,{className:q("grid gap-2",r),...n,ref:t}));ut.displayName=ct.displayName;const oe=a.forwardRef(({className:r,...n},t)=>e.jsx(dt,{ref:t,className:q("border-primary text-primary focus-visible:ring-ring aspect-square h-4 w-4 rounded-full border shadow focus:outline-none focus-visible:ring-1 disabled:cursor-not-allowed disabled:opacity-50",r),...n,children:e.jsx(Qs,{className:"flex items-center justify-center",children:e.jsx(os,{className:"fill-primary h-3.5 w-3.5"})})}));oe.displayName=dt.displayName;const Vs=Et({bio:me(),model:K(["GPT 3","GPT 4"]),name:me(),occupation:me(),outputLang:K(["english","hindi"]),outputLength:K(["short","medium","long"]),tone:K(["empathetic","optimistic","sincere","enthusiastic"]),writingStyle:K(["professional","casual","neutral"])});function Ks({setCurrentMode:r}){var x,y,o;const{t:n}=Be(),{...t}=a.useContext(X),i=je(),[m,p]=a.useState(null),[c,l]=He({instance:new Oe({area:"local"}),key:"quillSettings"}),s=Mt({defaultValues:{bio:"",model:"GPT 3",name:"",occupation:"",outputLang:"english",outputLength:"medium",tone:"empathetic",writingStyle:"professional"},resolver:Dt(Vs)});a.useEffect(()=>{s.reset(c)},[s,c]);function N(u){l(u),r("CHAT"),_({eventData:{...u,disable:m},eventName:"SaveSettings",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/settings"})}const C=a.useCallback(()=>{const u={from:"QUILL",payload:{action:"CLOSE_QUILL_THROUGHT_PAGE",data:null}};window.parent.postMessage(u,"*")},[]),j=a.useCallback(()=>{C(),Qe(we.QUILL)},[C]),h=a.useCallback(()=>{C(),i.update({quill:{isEnabled:!1}})},[C]);return a.useEffect(()=>{(async()=>{if(!await se.get("quillSettings")){const v=await se.get("gmailPersona");v?se.set("quillSettings",v):se.set("quillSettings",s.getValues())}})()},[]),e.jsxs(ge,{className:"flex w-full p-0",children:[e.jsxs("div",{className:"flex w-12 flex-col items-end justify-between gap-2 border-r p-1 py-2",children:[e.jsx("div",{className:"flex flex-col gap-2",children:e.jsx(F,{variant:"ghost",size:"icon",onClick:()=>{r("CHAT")},children:e.jsx(as,{})})}),e.jsx(F,{variant:"ghost",size:"icon",onClick:()=>J("https://www.getmerlin.in/dashboard"),children:e.jsx(Ge,{className:"h-6 w-6",children:e.jsx(Ue,{children:((o=(y=(x=t.name)==null?void 0:x.split(" "))==null?void 0:y.map(u=>u[0]))==null?void 0:o.join(""))??"U"})})})]}),e.jsx("div",{className:"flex h-[362px] w-full flex-col",children:c?e.jsxs(e.Fragment,{children:[e.jsxs(re,{className:"h-[300px]",children:[e.jsx(ie,{children:e.jsx(ye,{className:"text-lg",children:n("super_gmail.config")})}),e.jsxs(ge,{children:[e.jsx(Wt,{...s,children:e.jsx("form",{onSubmit:s.handleSubmit(N),children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(fe,{control:s.control,name:"model",render:({field:u})=>e.jsxs(he,{children:[e.jsx(xe,{children:n("super_gmail.ai_model")}),e.jsxs(Yt,{onValueChange:u.onChange,value:u.value,children:[e.jsx(Jt,{className:"w-full max-w-xs",children:e.jsx(Xt,{})}),e.jsxs(Zt,{children:[e.jsx(Me,{value:"GPT 3",children:"GPT 3"}),e.jsx(Me,{value:"GPT 4",children:"GPT 4"})]})]})]})}),e.jsx("h3",{className:"text-md font-semibold",children:n("super_gmail.persona")}),e.jsx(fe,{control:s.control,name:"name",render:({field:u})=>e.jsxs(he,{children:[e.jsx(xe,{children:n("super_gmail.name")}),e.jsx(De,{children:e.jsx(Ke,{placeholder:"Your name",...u})}),e.jsx(Fe,{})]})}),e.jsx("div",{className:"w-full max-w-sm",children:e.jsx(fe,{control:s.control,name:"bio",render:({field:u})=>e.jsxs(he,{children:[e.jsx(xe,{children:n("super_gmail.bio")}),e.jsx(De,{children:e.jsx(Ve,{placeholder:n("super_gmail.bio_placeholder"),className:"resize-none",...u})}),e.jsx(Fe,{})]})})})]})})}),e.jsxs("div",{className:"text-md flex flex-col space-y-2 font-semibold",children:[e.jsx("div",{children:"Disable quill"}),e.jsxs(ut,{value:m,onValueChange:u=>p(u.valueOf()),children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(oe,{value:"now",id:"now"}),e.jsx(ve,{htmlFor:"now",children:"For this session"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(oe,{value:"this-site",id:"this-site"}),e.jsx(ve,{htmlFor:"this-site",children:"For this site"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(oe,{value:"forever",id:"forever"}),e.jsx(ve,{htmlFor:"forever",children:"Forever"})]})]})]})]})]}),e.jsx(le,{className:"flex h-[60px] justify-end gap-2",children:e.jsx(F,{onClick:()=>{s.handleSubmit(N)(),m&&(m==="now"?C():m==="this-site"?j():m==="forever"&&h())},children:n("super_gmail.save")})})]}):e.jsx("div",{className:"flex-center h-full",children:e.jsx(hs,{})})})]})}function $s(r){const{startNewChat:n,textareaRef:t}=ee(),{liveSelectionActive:i,setCtx:m}=Z(w=>({liveSelectionActive:w.liveSelectionActive,setCtx:w.setCtx})),{...p}=a.useContext(X),{relativeDiv:c,textarea:l}=r,s=a.useRef(null),[N,C]=a.useState(!0),[j,h]=a.useState(!1),x=a.useRef(`textarea-${z()}`),y=a.useRef(`quill-portal-${z()}`),[o,u]=a.useState(0),[S,v]=a.useState(0),[T,P]=a.useState(""),[A,B]=a.useState(!1),[Q,f]=a.useState("CHAT");function g(w){l&&(l==null||l.focus(),Vt(l,w),l==null||l.scrollTo({behavior:"smooth",top:l==null?void 0:l.scrollHeight}),_({eventName:"InsertButton",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/quill"}))}a.useEffect(()=>{t.current=l;const w=()=>{const I=c.getBoundingClientRect(),d=l.getBoundingClientRect();let E=0,k=0;const G=d.height<60,R=24;d.x>=I.x?E=d.x-I.x+d.width-R:d.x+d.width>=I.x&&d.x<=I.x?E=d.x+d.width-I.x-R:E=-(I.x-(d.x+d.width)+R),d.y>=I.y?k=d.y-I.y+d.height-R+(G?R-d.height/2-10:0):d.y+d.height>=I.y&&d.y<=I.y?k=d.y+d.height-I.y-R+(G?R-d.height/2-10:0):k=-(I.y-(d.y+d.height)+R-(G?R-d.height/2-10:0)),u(E),v(k)};w(),l.setAttribute("merlin-id",x.current);const D=new ResizeObserver(w);return D.observe(l),window.addEventListener("resize",w),window.addEventListener("scroll",w),document.addEventListener("scroll",w),window.addEventListener("wheel",w),()=>{D.disconnect(),window.removeEventListener("resize",w),window.removeEventListener("scroll",w),document.removeEventListener("scroll",w),window.removeEventListener("wheel",w)}},[]),a.useEffect(()=>{function w(d){d.key==="Escape"&&(d.preventDefault(),B(!1))}const I=Ce(d=>{const E=window.getSelection().toString().trim();E.length>0?i?m({obj:{selectedText:E},text:E}):P(E):P("")},100);return document.addEventListener("selectionchange",I),window.addEventListener("keydown",w),()=>{window.removeEventListener("keydown",w),document.removeEventListener("selectionchange",I)}},[A,i]),a.useEffect(()=>{A||n()},[A]),a.useEffect(()=>{const w=s.current;if(A){const D=d=>{const E=w.closest(".reactAppRoot");if(!E)return;const k=E.parentNode;if(!k||!(k instanceof ShadowRoot))return;const G=k.activeElement,R=w.querySelectorAll('button:not(:disabled), [href], input, select, textarea, [tabindex]:not([tabindex="-1"]):not(:disabled)'),U=Array.from(R).indexOf(G),V=R.length-1;if(d.key==="Tab"&&(d.shiftKey&&U===0?(d.preventDefault(),R[V].focus()):!d.shiftKey&&U===R.length-1&&(d.preventDefault(),R[0].focus())),d.key==="ArrowDown"||d.key==="ArrowRight"){if(!G){R[0].focus();return}d.preventDefault();const b=U+1<R.length?U+1:0,L=R[b];L&&L.focus()}if(d.key==="ArrowUp"||d.key==="ArrowLeft"){if(!G){R[V].focus();return}d.preventDefault();const b=U-1>=0?U-1:R.length-1,L=R[b];L&&L.focus()}},I=d=>{d.key==="Escape"&&B(!1)};return w.addEventListener("keydown",D),w.addEventListener("keydown",I),()=>{w.removeEventListener("keydown",D),w.removeEventListener("keydown",I)}}},[A]),a.useEffect(()=>{const w=D=>{const{data:I}=D;if(I.from&&I.from==="QUILL"){const{payload:d}=I;d&&d.action==="CLOSE_QUILL_THROUGHT_PAGE"&&C(!1)}};return window.addEventListener("message",w),()=>{window.removeEventListener("message",w)}},[]);function M(){return p.isAuthenticated?Q==="SETTINGS"?e.jsx(Ks,{setCurrentMode:f}):e.jsx(e.Fragment,{children:e.jsx(Ms,{handleInsertText:g,setCurrentMode:f})}):e.jsx(Ps,{})}return N?e.jsxs("div",{style:{left:o,position:"absolute",top:S,zIndex:r.zIndex},children:[e.jsx(Ls,{isVisible:A,setModalOpen:h,setIsVisible:B,textarea:l,textareaId:x,selectedText:T}),e.jsx(Ee,{selector:{mountAsHtmlChild:!0},shouldMount:j,id:"quill-feedback-portal"+y.current,className:"merlin quill-feeback relative",groupBy:"quill-feeback-group",zIndex:2147483646,children:e.jsx(Ds,{modalOpen:j,setModalOpen:h})}),e.jsx(Ee,{selector:{mountAsHtmlChild:!0},shouldMount:A,id:y.current,className:"merlin quill-portal-ui relative",groupBy:"quill-portal-ui-group",zIndex:2147483646,children:e.jsxs(Ne,{className:q("fixed flex w-[448px] flex-col justify-between transition-[right] duration-300 ease-in-out",{"select-none":i}),style:{right:20,top:20,zIndex:2147483646},ref:s,children:[e.jsx("div",{className:"bg-secondary absolute -right-3 -top-3 cursor-pointer rounded-full p-1 shadow-lg ",onClick:()=>B(!1),children:e.jsx($e,{className:"h-4 w-4"})}),M()]})})]}):null}const mt=(r,n)=>{let t=n;if(!r)return!0;switch(r.type){case"qs":if(!t.querySelector(r.value))return!1;break;case"parent":t=t.parentElement;break;case"hasClass":if(!t.classList.contains(r.value))return!1;break;case"closest":if(t=t.closest(r.value),!t)return!1;break;case"next":if(t=t.nextElementSibling,!t)return!1;break;case"prev":if(t=t.previousElementSibling,!t)return!1;break;case"firstChild":if(t=t.firstElementChild,!t)return!1;break;case"lastChild":if(t=t.lastElementChild,!t)return!1;break;case"hasId":if(!t.id||t.id!==r.value)return!1;break;case"hasAttribute":if(!t.hasAttribute(r.value))return!1;break}return r.hasOwnProperty("then")?mt(r.then,t):!0};function Ws(r){const{blacklistedAttributes:n,mountData:t}=r,[i,m]=Y.useState([]),p=Y.useRef(null);function c(l,s){try{const N=window.location.host,C=l.find(j=>j.host===N);if(C){const{mountingSchema:j}=C;j.forEach(h=>{document.querySelectorAll(h.selector).forEach(y=>{if(y.getAttribute("merlin-id"))return;if(mt(h.condition,y)){try{const u=window.getComputedStyle(y);if(u.visibility==="hidden"||u.display==="none")return;const S=y.getBoundingClientRect();if(S.width<100||S.height<10)return;if(y instanceof HTMLTextAreaElement||y instanceof HTMLInputElement){const v=Array.from(y.attributes).map(P=>P.value),T=Array.from(y.attributes).map(P=>P.name);if(v.some(P=>P.toLowerCase().includes("search"))||T.some(P=>P.toLowerCase().includes("search"))||y.readOnly)return}}catch{return}m(u=>{if(u.some(v=>v.id===y.id))return u;const S=window.getComputedStyle(y);return[...u,{id:z(),ref:y,zIndex:S.zIndex||10}]})}})})}else{const j=document.body.querySelectorAll("textarea"),h=document.body.querySelectorAll('[contenteditable="true"]'),x=document.body.querySelectorAll("input[type=text]:not([name=email])");Array.from(h).concat(Array.from(j)).concat(Array.from(x)).forEach(o=>{try{const S=window.getComputedStyle(o);if(S.visibility==="hidden"||S.display==="none")return;const v=o.getBoundingClientRect();if(v.width<100||v.height<10)return;if(o instanceof HTMLTextAreaElement||o instanceof HTMLInputElement){const T=Array.from(o.attributes).map(A=>A.value),P=Array.from(o.attributes).map(A=>A.name);if(T.some(A=>A.toLowerCase().includes("search"))||P.some(A=>A.toLowerCase().includes("search"))||o.readOnly)return}}catch{return}s.some(S=>o.getAttribute(S.key)===S.value)||o.getAttribute("merlin-id")||m(S=>{if(S.some(T=>T.id===o.id))return S;const v=window.getComputedStyle(o);return[...S,{id:z(),ref:o,zIndex:v.zIndex||10}]})})}}catch{}}return a.useEffect(()=>{c(t,n);const l=new MutationObserver(Ce(()=>{c(t,n)},50));return l.observe(document.body,{childList:!0,subtree:!0}),()=>{l.disconnect()}},[]),a.useEffect(()=>{},[i]),e.jsx("div",{className:"relative",ref:p,onMouseEnter:()=>_({eventName:"QuillButton",eventType:"HoverElement",feature:"Quill",firedFromFile:"features/quill/quillWrapper"}),children:i.map(l=>e.jsx(Rs,{children:e.jsx($s,{textarea:l.ref,relativeDiv:p.current,zIndex:l.zIndex})},l.id))})}const Ys=async()=>{await new Promise(r=>{const n=new MutationObserver(Ce(()=>{document.body&&(r(),n.disconnect())},50));n.observe(document.documentElement,{childList:!0,subtree:!0})})};function Js({blacklistedAttributes:r,mountData:n}){var i,m;return(m=(i=je().details)==null?void 0:i.quill)!=null&&m.isEnabled?e.jsx(jt,{children:e.jsx(yt,{children:e.jsx(Ct,{children:e.jsx(Nt,{children:e.jsx(kt,{children:e.jsx(Pt,{children:e.jsx(It,{isWebpage:!1,children:e.jsx(Ws,{mountData:n,blacklistedAttributes:r})})})})})})})}):null}const Xs=async()=>{if(await Kt(we.QUILL))return;const n=await Lt();if(!n||!n.visible)return;const t=window.location.host,i=n.listInUse;if(i==="blacklist"){const j=n.blacklist,h=n.blacklistType;if(h==="contains"&&j.some(x=>t.includes(x))||h==="exact"&&j.some(x=>t===x))return}else if(i==="whitelist"){const j=n.whitelist,h=n.whitelistType;if(h==="contains"&&!j.some(x=>t.includes(x))||h==="exact"&&!j.some(x=>t===x))return}const m=n.shouldUseMount?n.mount:[],p=n.blacklistedAttributes;await Ys();const c=document.createElement("merlin-component");c.id="merlin-quill",c.className="merlin textarea-merlin";const l=c.attachShadow({mode:"open"}),s=document.createElement("style");s.textContent=`${ws}
  :host(#merlin-quill) {
  }
  .reactAppRoot {
    all: initial; /* 1st rule so subsequent properties are reset. */
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    position: absolute;
    top: 0;
    left: 0;
    z-index: ${t==="www.reddit.com"?10:2147483645};
  }
  .dark {
      ${St}
  }
  ${Tt}
  `.replaceAll(":root",":host"),l.appendChild(s);const N=document.createElement("div");N.id="reactAppRoot",N.className="reactAppRoot",vt.forEach(j=>{N.addEventListener(j,h=>{h.stopPropagation()})}),document.documentElement.prepend(c),l.appendChild(N),gt(N).render(e.jsx(Js,{mountData:m,blacklistedAttributes:p}))};Xs();
