var W=Object.defineProperty;var F=(e,t,s)=>t in e?W(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var r=(e,t,s)=>(F(e,typeof t!="symbol"?t+"":t,s),s),I=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)};var i=(e,t,s)=>(I(e,t,"read from private field"),s?s.call(e):t.get(e)),m=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},S=(e,t,s,a)=>(I(e,t,"write to private field"),a?a.call(e,s):t.set(e,s),s);var R=(e,t,s)=>(I(e,t,"access private method"),s);import{r as o,Z as T}from"./constants-e5712b98.js";var U=()=>{var e,t,s;try{let a=((e=globalThis.navigator)==null?void 0:e.userAgent).match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(a[1]==="Chrome")return parseInt(a[2])<100||((s=(t=globalThis.chrome.runtime)==null?void 0:t.getManifest())==null?void 0:s.manifest_version)===2}catch{return!1}return!1},f,d,u,E,g,M,A,k,x,O,N,j,L,P=(L=class{constructor({area:e="sync",allCopied:t=!1,copiedKeyList:s=[],serde:a={}}={}){m(this,x);m(this,N);m(this,f,void 0);m(this,d,void 0);m(this,u,void 0);m(this,E,void 0);m(this,g,new Map);m(this,M,void 0);r(this,"isCopied",e=>this.hasWebApi&&(this.allCopied||this.copiedKeySet.has(e)));m(this,A,!1);r(this,"getExtStorageApi",()=>{var e,t;return((e=globalThis.browser)==null?void 0:e.storage)||((t=globalThis.chrome)==null?void 0:t.storage)});r(this,"isWatchSupported",()=>this.hasExtensionApi);r(this,"keyNamespace","");r(this,"isValidKey",e=>e.startsWith(this.keyNamespace));r(this,"getNamespacedKey",e=>`${this.keyNamespace}${e}`);r(this,"getUnnamespacedKey",e=>e.slice(this.keyNamespace.length));r(this,"serde",{serializer:JSON.stringify,deserializer:JSON.parse});r(this,"rawGetAll",()=>{var e;return(e=i(this,d))==null?void 0:e.get()});r(this,"getAll",async()=>{let e=await this.rawGetAll();return Object.entries(e).filter(([t])=>this.isValidKey(t)).reduce((t,[s,a])=>(t[this.getUnnamespacedKey(s)]=a,t),{})});r(this,"copy",async e=>{var n,h;let t=e===void 0;if(!t&&!this.copiedKeySet.has(e)||!this.allCopied||!this.hasExtensionApi)return!1;let s=this.allCopied?await this.rawGetAll():await i(this,d).get((t?[...this.copiedKeySet]:[e]).map(this.getNamespacedKey));if(!s)return!1;let a=!1;for(let l in s){let y=s[l],c=(n=i(this,u))==null?void 0:n.getItem(l);(h=i(this,u))==null||h.setItem(l,y),a||(a=y!==c)}return a});r(this,"rawGet",async e=>(await this.rawGetMany([e]))[e]);r(this,"rawGetMany",async e=>this.hasExtensionApi?await i(this,d).get(e):e.filter(this.isCopied).reduce((t,s)=>{var a;return t[s]=(a=i(this,u))==null?void 0:a.getItem(s),t},{}));r(this,"rawSet",async(e,t)=>await this.rawSetMany({[e]:t}));r(this,"rawSetMany",async e=>(i(this,u)&&Object.entries(e).filter(([t])=>this.isCopied(t)).forEach(([t,s])=>i(this,u).setItem(t,s)),this.hasExtensionApi&&await i(this,d).set(e),null));r(this,"clear",async(e=!1)=>{var t;e&&((t=i(this,u))==null||t.clear()),await i(this,d).clear()});r(this,"rawRemove",async e=>{await this.rawRemoveMany([e])});r(this,"rawRemoveMany",async e=>{i(this,u)&&e.filter(this.isCopied).forEach(t=>i(this,u).removeItem(t)),this.hasExtensionApi&&await i(this,d).remove(e)});r(this,"removeAll",async()=>{let e=await this.getAll(),t=Object.keys(e);await this.removeMany(t)});r(this,"watch",e=>{let t=this.isWatchSupported();return t&&i(this,k).call(this,e),t});m(this,k,e=>{var t;for(let s in e){let a=this.getNamespacedKey(s),n=((t=i(this,g).get(a))==null?void 0:t.callbackSet)||new Set;if(n.add(e[s]),n.size>1)continue;let h=(l,y)=>{if(y!==this.area||!l[a])return;let c=i(this,g).get(a);if(!c)throw new Error(`Storage comms does not exist for nsKey: ${a}`);Promise.all([this.parseValue(l[a].newValue),this.parseValue(l[a].oldValue)]).then(([p,v])=>{for(let b of c.callbackSet)b({newValue:p,oldValue:v},y)})};i(this,f).onChanged.addListener(h),i(this,g).set(a,{callbackSet:n,listener:h})}});r(this,"unwatch",e=>{let t=this.isWatchSupported();return t&&R(this,x,O).call(this,e),t});r(this,"unwatchAll",()=>R(this,N,j).call(this));this.setCopiedKeySet(s),S(this,E,e),S(this,A,t),this.serde={...this.serde,...a};try{this.hasWebApi&&(t||s.length>0)&&S(this,u,window.localStorage)}catch{}try{this.hasExtensionApi&&(S(this,f,this.getExtStorageApi()),U()?S(this,d,T(i(this,f)[this.area],{exclude:["getBytesInUse"],errorFirst:!1})):S(this,d,i(this,f)[this.area]))}catch{}}get primaryClient(){return i(this,d)}get secondaryClient(){return i(this,u)}get area(){return i(this,E)}get hasWebApi(){try{return typeof window<"u"&&!!window.localStorage}catch(e){return console.error(e),!1}}get copiedKeySet(){return i(this,M)}get allCopied(){return i(this,A)}get hasExtensionApi(){try{return!!this.getExtStorageApi()}catch(e){return console.error(e),!1}}setCopiedKeySet(e){S(this,M,new Set(e))}async getItem(e){return this.get(e)}async getItems(e){return await this.getMany(e)}async setItem(e,t){await this.set(e,t)}async setItems(e){await await this.setMany(e)}async removeItem(e){return this.remove(e)}async removeItems(e){return await this.removeMany(e)}},f=new WeakMap,d=new WeakMap,u=new WeakMap,E=new WeakMap,g=new WeakMap,M=new WeakMap,A=new WeakMap,k=new WeakMap,x=new WeakSet,O=function(e){for(let t in e){let s=this.getNamespacedKey(t),a=e[t],n=i(this,g).get(s);n&&(n.callbackSet.delete(a),n.callbackSet.size===0&&(i(this,g).delete(s),i(this,f).onChanged.removeListener(n.listener)))}},N=new WeakSet,j=function(){i(this,g).forEach(({listener:e})=>i(this,f).onChanged.removeListener(e)),i(this,g).clear()},L),$=class extends P{constructor(){super(...arguments);r(this,"get",async t=>{let s=this.getNamespacedKey(t),a=await this.rawGet(s);return this.parseValue(a)});r(this,"getMany",async t=>{let s=t.map(this.getNamespacedKey),a=await this.rawGetMany(s),n=await Promise.all(Object.values(a).map(this.parseValue));return Object.keys(a).reduce((h,l,y)=>(h[this.getUnnamespacedKey(l)]=n[y],h),{})});r(this,"set",async(t,s)=>{let a=this.getNamespacedKey(t),n=this.serde.serializer(s);return this.rawSet(a,n)});r(this,"setMany",async t=>{let s=Object.entries(t).reduce((a,[n,h])=>(a[this.getNamespacedKey(n)]=this.serde.serializer(h),a),{});return await this.rawSetMany(s)});r(this,"remove",async t=>{let s=this.getNamespacedKey(t);return this.rawRemove(s)});r(this,"removeMany",async t=>{let s=t.map(this.getNamespacedKey);return await this.rawRemoveMany(s)});r(this,"setNamespace",t=>{this.keyNamespace=t});r(this,"parseValue",async t=>{try{if(t!==void 0)return this.serde.deserializer(t)}catch(s){console.error(s)}})}};function Q(e,t){let s=typeof e=="object",a=s?e.key:e,[n,h]=o.useState(t),[l,y]=o.useState(!0),c=o.useRef(!1),p=o.useRef(t instanceof Function?t():t);o.useEffect(()=>{p.current=n},[n]);let v=o.useRef(s?e.instance:new $),b=o.useCallback(w=>v.current.set(a,w!==void 0?w:p.current),[a]),V=o.useCallback(async w=>{let C=w instanceof Function?w(p.current):w;await b(C),c.current&&h(C)},[b]);o.useEffect(()=>{var C;c.current=!0;let w={[a]:K=>{c.current&&(h(K.newValue),y(!1))}};return v.current.watch(w),(C=v.current.get(a))==null||C.then(K=>{if(t instanceof Function){let G=t==null?void 0:t(K,!0);G!==void 0&&V(G)}else h(K!==void 0?K:t);y(!1)}),()=>{c.current=!1,v.current.unwatch(w),t instanceof Function&&h(t)}},[a,V]);let z=o.useCallback(()=>{v.current.remove(a),h(void 0)},[a]);return[n,V,{setRenderValue:h,setStoreValue:b,remove:z,isLoading:l}]}function Z(e,t,s){const a=o.useCallback(c=>window.matchMedia(c),[]),n=o.useMemo(()=>e.map(a),[e,a]),h=o.useCallback(()=>{const c=n.findIndex(p=>p.matches);return(t==null?void 0:t[c])||s},[t,s,n]),[l,y]=o.useState(h);return o.useEffect(()=>{const c=()=>y(h);return n.forEach(p=>p.addEventListener("change",c)),()=>n.forEach(p=>p.removeEventListener("change",c))},[h,n]),l}export{Q as P,Z as u};
