let picInPicIcon = `<svg version="1.1" id="Picture_in_Picture" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 24 24"style="enable-background:new 0 0 24 24;" xml:space="preserve"><style type="text/css">.st0 {fill:#FFFFFF;}</style><g><title>Picture In Picture</title><g id="XMLID_6_"><path id="XMLID_11_" class="st0" d="M19.6,11.2h-8.9v6.4h8.8L19.6,11.2L19.6,11.2z M23.9,19.8v-15c0-1.2-1-2.1-2.2-2.1H1.9c-1.2,0-2.2,0.9-2.2,2.1v15c0,1.2,1,2.1,2.2,2.1h19.9C22.9,21.9,23.9,21,23.9,19.8z M21.7,19.8H1.9v-15h19.9V19.8z"/></g></g></svg>`
let picInPicIcon2 = `<svg viewBox="1 1 21 21" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 12.75C16.4142 12.75 16.75 12.4142 16.75 12C16.75 11.5858 16.4142 11.25 16 11.25C15.5858 11.25 15.25 11.5858 15.25 12C15.25 12.4142 15.5858 12.75 16 12.75Z" fill="#ffffff"/><path d="M8 10.5C8 9.67157 8.67157 9 9.5 9H17.5C18.3284 9 19 9.67157 19 10.5V15.5C19 16.3284 18.3284 17 17.5 17H9.5C8.67157 17 8 16.3284 8 15.5V10.5ZM9.5 10.5V14.8942L11.5815 12.6392C12.0764 12.103 12.9235 12.103 13.4185 12.6392L16.0511 15.4912L16.0416 15.5H17.5V10.5H9.5ZM12.5 13.8556L10.9821 15.5H14.0178L12.5 13.8556Z" fill="#ffffff"/><path d="M5.75 4C3.67893 4 2 5.67893 2 7.75V16.25C2 18.3211 3.67893 20 5.75 20H18.25C20.3211 20 22 18.3211 22 16.25V7.75C22 5.67893 20.3211 4 18.25 4H5.75ZM3.5 7.75C3.5 6.50736 4.50736 5.5 5.75 5.5H18.25C19.4926 5.5 20.5 6.50736 20.5 7.75V16.25C20.5 17.4926 19.4926 18.5 18.25 18.5H5.75C4.50736 18.5 3.5 17.4926 3.5 16.25V7.75Z" fill="#ffffff"/></svg>`
let playIcon = `<svg width="2em" height="2em" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg" tabindex="-1" focusable="false" style="display: flex;"><path fill-rule="evenodd" clip-rule="evenodd" d="M30.978 16.136c1.363.77 1.363 2.735 0 3.506L10.005 31.514C8.663 32.274 7 31.304 7 29.76V6.017c0-1.543 1.663-2.513 3.005-1.753l20.973 11.872Z" fill="#CACACA"></path></svg>`
let pauseIcon = `<svg width="2em" height="2em" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg" tabindex="-1" focusable="false"><path d="M6 7.364a4.364 4.364 0 1 1 8.727 0v21.272a4.364 4.364 0 0 1-8.727 0V7.364ZM21.273 7.364a4.364 4.364 0 0 1 8.727 0v21.272a4.364 4.364 0 0 1-8.727 0V7.364Z" fill="#CACACA"></path></svg>`
let volumeIcon1 = `<svg width="2em" height="2em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 8.99998C16.5 9.49998 17 10.5 17 12C17 13.5 16.5 14.5 16 15M3 10.5V13.5C3 14.6046 3.5 15.5 5.5 16C7.5 16.5 9 21 12 21C14 21 14 3 12 3C9 3 7.5 7.5 5.5 8C3.5 8.5 3 9.39543 3 10.5Z" stroke="#cecece" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`
let volumeIcon2 = `<svg width="2em" height="2em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 6C20.5 7.5 21 10 21 12C21 14 20.5 16.5 19 18M16 8.99998C16.5 9.49998 17 10.5 17 12C17 13.5 16.5 14.5 16 15M3 10.5V13.5C3 14.6046 3.5 15.5 5.5 16C7.5 16.5 9 21 12 21C14 21 14 3 12 3C9 3 7.5 7.5 5.5 8C3.5 8.5 3 9.39543 3 10.5Z" stroke="#cecece" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`
let volumeIcon3 = `<svg width="2em" height="2em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 9L16 15M16 9L22 15M3 10.5V13.5C3 14.6046 3.5 15.5 5.5 16C7.5 16.5 9 21 12 21C14 21 14 3 12 3C9 3 7.5 7.5 5.5 8C3.5 8.5 3 9.39543 3 10.5Z" stroke="#cecece" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`
const MAX_TRIES_MONITOR_SKIP = 10
let isMonitorActive = false
let isIconActive = false
let isAlternateIconActive = false
let isNewPipActive = false
let isSliderVisible = false

function initContent() {
    startMonitoringForVideo(0)
}

initContent()

function eraseIcon() {
    let modals = document.querySelectorAll('.ontop')
    if (modals.length > 0) {
        modals.forEach(modal => {
           modal.remove() 
        })
    }
}

function createIcon() {
    let modal = document.createElement('div')
    let modalNew = document.createElement('div')
    const createSmallPopup = () => {
        const iconFrame = document.querySelector('.controls__right')
        if (iconFrame) {
            modal.innerHTML = picInPicIcon
            modal.classList.add('ontop')
            modal.classList.add('control-icon-btn')

            modalNew.innerHTML = picInPicIcon2
            modalNew.classList.add('ontop')
            modalNew.classList.add('control-icon-btn')
            iconFrame.insertBefore(modal, iconFrame.firstChild)
            iconFrame.insertBefore(modalNew, iconFrame.firstChild)
            isIconActive = true
        }
    }
    createSmallPopup()

    modalNew.addEventListener('click', async () => {
        isNewPipActive = true 
        let playerElem = document.querySelector('.btm-media-client')
        let video = document.querySelector('video')
        let videos = document.querySelectorAll('video')
        if (videos.length > 1) {
            videos.forEach(videoElem => {
                if (videoElem.style.display != 'none') {
                    video = videoElem
                }
            })
        }
        let playerSubtitles = document.querySelector('.dss-hls-subtitle-overlay')
        if (video.disablePictureInPicture) {
            video.disablePictureInPicture = false
        }
        const newWindow = await documentPictureInPicture.requestWindow({
            width: playerElem.clientWidth / 2,
            height: playerElem.clientHeight != 0 ? playerElem.clientHeight / 2 : playerElem.clientWidth / 3
        })
        playerElem.style.overflow = 'hidden'
        const styleSheetsArr = [...document.styleSheets]
        // const styleSheetsArr = [...document.styleSheets].slice(0,-7).concat([...document.styleSheets].slice(4))
        styleSheetsArr.forEach((styleSheet) => {
            try {
                const cssRules = [...styleSheet.cssRules].map(rule => rule.cssText).join('')
                const style = document.createElement('style')
                style.textContent = cssRules
                newWindow.document.head.appendChild(style)
            } catch (e) {
                const link = document.createElement('link')
                link.rel = 'stylesheet'
                link.type = styleSheet.type
                link.media = styleSheet.media
                link.href = styleSheet.href
                newWindow.document.head.appendChild(link)
            }
        })
        newWindow.document.body.append(video)
        newWindow.document.body.append(playerSubtitles)
        // here create custom controls
        newWindow.document.querySelector("html").style.display = 'flex'
        createControls(newWindow)
        video.style.width = '100%'
        video.style.height = '100%'


        newWindow.addEventListener('pagehide', e => {
            isNewPipActive = false
            // let playerContainer = document.querySelector('disney-web-player').shadowRoot.querySelector('.btm-media-client')
            let playerContainer = document.querySelector('disney-web-player').querySelector('.btm-media-client')
            let player = e.target.querySelector('video')
            let playerSub = e.target.querySelector('.dss-hls-subtitle-overlay')
            playerContainer.append(player)
            playerContainer.append(playerSub)
        })
        newWindow.addEventListener('resize', (e) => {
            let playerSub = e.target.document.querySelector('.dss-hls-subtitle-overlay')
            if (playerSub) {
                playerSub.style.width = `${e.target.outerWidth}px`
                playerSub.style.height = '100%'
            }
        })
    })

    modal.addEventListener('click', () => {
        enterPip()
    })
}

function startMonitoringForVideo(numTries) {
    numTries++
    const monitor = new MutationObserver(() => {
        let video = document.querySelector('video')
        let videos = document.querySelectorAll('video')
        if (videos.length > 1) {
            videos.forEach(videoElem => {
                if (videoElem.style.display != 'none') {
                    video = videoElem
                }
            })
        }
        let pipIcons = document.querySelectorAll('.ontop')
        if (video && isIconActive == false && pipIcons.length == 0) {
            createIcon()
        } else if (!video && isIconActive) {
            eraseIcon()
            isIconActive = false
        }
    })
    let reactEntry = document.querySelector("body")
    if (reactEntry) {
        if (isMonitorActive == false) {
            monitor.observe(reactEntry, {
                attributes: false,
                childList: true,
                subtree: true
            })
            isMonitorActive = true
        } else {
            return
        }

    } else {
        if (numTries > MAX_TRIES_MONITOR_SKIP) { return }
        setTimeout(() => {
            startMonitoringForVideo(numTries)
        }, 100 * numTries)
    }
}

function monitorElements(newWindow) {
    const pipMonitor = new MutationObserver(() => {
        const progressBar = newWindow.document.querySelector('.progress-bar')
        // const fullScreenBtn = newWindow.document.querySelector('[aria-label="Full Screen"]')
        const fullScreenBtn = newWindow.document.querySelector('.fullscreen-icon')
        const volumeProgress = newWindow.document.querySelector('.audio-control__volume-container')
        progressBar ? progressBar.style.display = 'none' : null
        fullScreenBtn ? fullScreenBtn.style.display = 'none' : null
        volumeProgress ? volumeProgress.style.display = 'none' : null
        const postPlayElem = newWindow.document.querySelector('.title-bug-area')
        postPlayElem ? postPlayElem.style.display = 'none' : null
        const subtitleElem = newWindow.document.querySelector('.dss-subtitle-renderer-cue')
        if (subtitleElem) {
            subtitleElem.style.fontSize = '16px'
        }
        if (!isNewPipActive) {
            pipMonitor.disconnect()
        }
    })
    const observerObject = newWindow.document.querySelector('body')
    pipMonitor.observe(observerObject, {
        attributes: true,
        childList: true,
        subtree: true
    })
}

setInterval(() => {
    let video = document.querySelector('video')
        let videos = document.querySelectorAll('video')
        if (videos.length > 1) {
            videos.forEach(videoElem => {
                if (videoElem.style.display != 'none') {
                    video = videoElem
                }
            })
        }
    // fix timer
    if (documentPictureInPicture.window && !video) {
        let pipVideo = documentPictureInPicture.window.document.querySelector('video')
        if (pipVideo) {
            fixTimer()
            // fixSize()
        }
    }
},1000)

function enterPip() {
    let video = document.querySelector('video')
        let videos = document.querySelectorAll('video')
        if (videos.length > 1) {
            videos.forEach(videoElem => {
                if (videoElem.style.display != 'none') {
                    video = videoElem
                }
            })
        }
    // creating picture in picture
    if ('pictureInPictureEnabled' in document) {
        if (video.disablePictureInPicture) {
            video.disablePictureInPicture = false
        }
        if (document.pictureInPictureElement) {
            document.exitPictureInPicture().catch(err => {
                console.log(err)
            }).then(() => {
                if (video) {
                    if (video.paused) {
                        video.play()
                    }
                }
            })
            return
        }
        video.requestPictureInPicture().catch(err => {
            console.log(err)
        })
    }
}

function createControls(newWindow) {
    let newControls = document.createElement('div')
    newControls.style.position = 'absolute'
    newControls.style.bottom = '10%'
    newControls.style.width = '100%'
    newControls.style.height = '40px'
    newControls.style.background = 'transparent'
    newControls.style.display = 'flex'
    newControls.style.alignItems = 'center'
    newControls.style.justifyContent = 'space-around'
    newControls.style.opacity = 0
    newControls.innerHTML = `
        <div class="timer" style="color: #CACACA; font-weight: 700;"></div>
        <div class="playControl" style="cursor: pointer;">
            ${newWindow.document.querySelector('video').paused ? playIcon : pauseIcon}
        </div>
        <div class="volumeControl" style="cursor: pointer; position: relative;">
            <div class="volumeIcon">${newWindow.document.querySelector('video').muted ? volumeIcon3 : (newWindow.document.querySelector('video').volume >= 0.5 ? volumeIcon2 : volumeIcon1)}</div>
            <input 
                type="range" 
                name="volumeSlider" 
                min="0" max="1" 
                step="0.1" 
                value="${newWindow.document.querySelector('video').volume}" 
                class="volumeSlider"
                style="display: none; transform: rotate(-90deg); width: 70px; position: absolute; top: -45px; left: -20px; cursor: pointer;"
            />
        </div>
    `
    newWindow.document.body.append(newControls)

    newWindow.document.querySelector('.volumeSlider').addEventListener('mouseenter', () => {
        isSliderVisible = true
    })

    newWindow.document.querySelector('.volumeSlider').addEventListener('mouseleave', () => {
        isSliderVisible = false
    })

    newWindow.document.querySelector('.volumeSlider').addEventListener('change', () => {
        if (!newWindow.document.querySelector('video').muted) {
            if (Number(newWindow.document.querySelector('.volumeSlider').value) >= 0.5) {
                newWindow.document.querySelector('.volumeControl .volumeIcon').innerHTML = volumeIcon2
            } else {
                newWindow.document.querySelector('.volumeControl .volumeIcon').innerHTML = volumeIcon1
            }
        }
        newWindow.document.querySelector('video').volume = newWindow.document.querySelector('.volumeSlider').value
    })

    newWindow.document.querySelector('.volumeControl').addEventListener('mouseenter', () => {
        newWindow.document.querySelector('.volumeSlider').style.display = 'block'
        isSliderVisible = true
    })

    newWindow.document.querySelector('.volumeControl').addEventListener('mouseleave', () => {
        setTimeout(() => {
            isSliderVisible = false
        },1000)
    })

    newWindow.document.querySelector('.volumeIcon').addEventListener('click', () => {
        let videoPip = newWindow.document.querySelector('video')
        if (videoPip.muted) {
            videoPip.muted = false
            if (Number(newWindow.document.querySelector('.volumeSlider').value) >= 0.5) {
                newWindow.document.querySelector('.volumeControl .volumeIcon').innerHTML = volumeIcon2
            } else {
                newWindow.document.querySelector('.volumeControl .volumeIcon').innerHTML = volumeIcon1
            }
        } else {
            videoPip.muted = true
            newWindow.document.querySelector('.volumeControl .volumeIcon').innerHTML = volumeIcon3
        }
    })
    newWindow.addEventListener('mouseout', () => {
        newControls.style.opacity = 0
    })

    newWindow.addEventListener('mousemove', () => {
        newControls.style.opacity = 1
    })

    newWindow.document.querySelector('.playControl').addEventListener('click', () => {
        let videoPip = newWindow.document.querySelector('video')
        if (videoPip.paused) {
            videoPip.play()
            newWindow.document.querySelector('.playControl').innerHTML = pauseIcon
        } else {
            videoPip.pause()
            newWindow.document.querySelector('.playControl').innerHTML = playIcon
        }
    })
}

function fixTimer() {
    let currentTime = documentPictureInPicture.window.document.querySelector('video').currentTime
    let currentMin = (currentTime / 60).toString().split('.')[0]
    let currentSec = (((currentTime / 60) - Number(currentMin)) * 60).toFixed()
    let fixedSec
    if (currentSec.length == 1) {
        fixedSec = `0${currentSec}`
    } else {
        fixedSec = currentSec
    }
    let timerElem = documentPictureInPicture.window.document.querySelector('.timer')
    if (timerElem) {
       timerElem.innerHTML = `${currentMin} : ${fixedSec}` 
    }
    // slider part
    if (!isSliderVisible && documentPictureInPicture.window.document.querySelector('.volumeSlider')) {
        documentPictureInPicture.window.document.querySelector('.volumeSlider').style.display = 'none'
    }
}

function fixSize() {
    let video = documentPictureInPicture.window.document.querySelector('video')
    let subtitles = documentPictureInPicture.window.document.querySelector('.dss-hls-subtitle-overlay')
    video.style.width = '100%'
    video.style.height = '100%'
    video.parentElement.style.overflow = 'hidden'
    if (subtitles) {
        subtitles.style.width = '100%'
        subtitles.style.height = '100%'
    }
}